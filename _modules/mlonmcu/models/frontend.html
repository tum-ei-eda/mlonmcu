

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>mlonmcu.models.frontend &mdash; ML on MCU 0.8.dev0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=70e6bf69"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            ML on MCU
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../readme.html">ML on MCU</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../design.html">Important Terms and Design Decisions (RFC)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../components.html">Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../components.html#components-in-detail">Components in Detail</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../environments.html">Environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../postprocess.html">Postprocesses</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../logging.html">Logging and Verbosity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../authors.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../history.html">History</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ML on MCU</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">mlonmcu.models.frontend</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for mlonmcu.models.frontend</h1><div class="highlight"><pre>
<span></span><span class="c1">#</span>
<span class="c1"># Copyright (c) 2022 TUM Department of Electrical and Computer Engineering.</span>
<span class="c1">#</span>
<span class="c1"># This file is part of MLonMCU.</span>
<span class="c1"># See https://github.com/tum-ei-eda/mlonmcu.git for further info.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="c1">#</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">multiprocessing</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">mlonmcu.feature.features</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_matching_features</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mlonmcu.models.model</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">ModelFormats</span><span class="p">,</span>
    <span class="n">Model</span><span class="p">,</span>
    <span class="n">ExampleProgram</span><span class="p">,</span>
    <span class="n">EmbenchProgram</span><span class="p">,</span>
    <span class="n">TaclebenchProgram</span><span class="p">,</span>
    <span class="n">PolybenchProgram</span><span class="p">,</span>
    <span class="n">CoremarkProgram</span><span class="p">,</span>
    <span class="n">DhrystoneProgram</span><span class="p">,</span>
    <span class="n">MathisProgram</span><span class="p">,</span>
    <span class="n">MibenchProgram</span><span class="p">,</span>
    <span class="n">OpenASIPProgram</span><span class="p">,</span>
    <span class="n">RVVBenchProgram</span><span class="p">,</span>
    <span class="n">ISSBenchProgram</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mlonmcu.models.lookup</span><span class="w"> </span><span class="kn">import</span> <span class="n">lookup_models</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mlonmcu.feature.type</span><span class="w"> </span><span class="kn">import</span> <span class="n">FeatureType</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mlonmcu.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">filter_config</span><span class="p">,</span> <span class="n">str2bool</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mlonmcu.artifact</span><span class="w"> </span><span class="kn">import</span> <span class="n">Artifact</span><span class="p">,</span> <span class="n">ArtifactFormat</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mlonmcu.setup</span><span class="w"> </span><span class="kn">import</span> <span class="n">utils</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mlonmcu.target.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">Metrics</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">mlonmcu.logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_logger</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">()</span>


<div class="viewcode-block" id="check_integrity">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.check_integrity">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">check_integrity</span><span class="p">(</span><span class="n">algorithm</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">],</span> <span class="n">check</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>

    <span class="n">hash_func</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">algorithm</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="c1"># Read the file in chunks of 8192 bytes</span>
        <span class="k">while</span> <span class="n">chunk</span> <span class="o">:=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8192</span><span class="p">):</span>
            <span class="n">hash_func</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>

    <span class="n">file_hash</span> <span class="o">=</span> <span class="n">hash_func</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
    <span class="n">hash_matches</span> <span class="o">=</span> <span class="n">file_hash</span> <span class="o">==</span> <span class="n">value</span>
    <span class="k">if</span> <span class="n">check</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">hash_matches</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Model hash (</span><span class="si">{</span><span class="n">algorithm</span><span class="si">}</span><span class="s2">) missmatch: </span><span class="si">{</span><span class="n">file_hash</span><span class="si">}</span><span class="s2"> vs. </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">hash_matches</span></div>



<div class="viewcode-block" id="Frontend">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.Frontend">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Frontend</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="n">FEATURES</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;validate&quot;</span><span class="p">}</span>

    <span class="n">DEFAULTS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;use_inout_data&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="c1"># the following should be configured using gen_data feature</span>
        <span class="s2">&quot;gen_data&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;gen_data_fill_mode&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;gen_data_file&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;gen_data_number&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;gen_data_fmt&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="c1"># the following should be configured using gen_ref_data feature</span>
        <span class="s2">&quot;gen_ref_data&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;gen_ref_data_mode&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;gen_ref_data_file&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;gen_ref_data_fmt&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;gen_ref_labels&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;gen_ref_labels_mode&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;gen_ref_labels_file&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;gen_ref_labels_fmt&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">REQUIRED</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">OPTIONAL</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">input_formats</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_formats</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_formats</span> <span class="o">=</span> <span class="n">input_formats</span> <span class="k">if</span> <span class="n">input_formats</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_formats</span> <span class="o">=</span> <span class="n">output_formats</span> <span class="k">if</span> <span class="n">output_formats</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span> <span class="k">if</span> <span class="n">config</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_features</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">filter_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULTS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">OPTIONAL</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">REQUIRED</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">probs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="n">probs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">probs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">probs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">))</span>
        <span class="k">return</span> <span class="s2">&quot;Frontend(&quot;</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">probs</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">use_inout_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;use_inout_data&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">gen_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;gen_data&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">gen_data_fill_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;gen_data_fill_mode&quot;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;random&quot;</span><span class="p">,</span> <span class="s2">&quot;ones&quot;</span><span class="p">,</span> <span class="s2">&quot;zeros&quot;</span><span class="p">,</span> <span class="s2">&quot;file&quot;</span><span class="p">,</span> <span class="s2">&quot;dataset&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">gen_data_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;gen_data_file&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">gen_data_number</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;gen_data_number&quot;</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">gen_data_fmt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;gen_data_fmt&quot;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;npy&quot;</span><span class="p">,</span> <span class="s2">&quot;npz&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">gen_ref_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;gen_ref_data&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">gen_ref_data_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;gen_ref_data_mode&quot;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">gen_ref_data_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;gen_ref_data_file&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">gen_ref_data_fmt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;gen_ref_data_fmt&quot;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;npy&quot;</span><span class="p">,</span> <span class="s2">&quot;npz&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">gen_ref_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;gen_ref_labels&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">gen_ref_labels_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;gen_ref_labels_mode&quot;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">gen_ref_labels_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;gen_ref_labels_file&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">gen_ref_labels_fmt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;gen_ref_labels_fmt&quot;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;npy&quot;</span><span class="p">,</span> <span class="s2">&quot;npz&quot;</span><span class="p">,</span> <span class="s2">&quot;txt&quot;</span><span class="p">,</span> <span class="s2">&quot;csv&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">value</span>

<div class="viewcode-block" id="Frontend.inference">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.Frontend.inference">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">inference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span> <span class="n">input_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">]):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


<div class="viewcode-block" id="Frontend.extract_model_info">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.Frontend.extract_model_info">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">extract_model_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">Model</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


<div class="viewcode-block" id="Frontend.supports_formats">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.Frontend.supports_formats">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">supports_formats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returs true if the frontend can handle at least one combination of input and output formats.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">ins</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">outs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Please provide a list of input formats, outputs formats or both&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">ins</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ins</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">ins</span> <span class="o">=</span> <span class="p">[</span><span class="n">ins</span><span class="p">]</span>
            <span class="n">supported</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">fmt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_formats</span> <span class="k">for</span> <span class="n">fmt</span> <span class="ow">in</span> <span class="n">ins</span><span class="p">)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span> <span class="ow">and</span> <span class="n">supported</span>
        <span class="k">if</span> <span class="n">outs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">outs</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">outs</span> <span class="o">=</span> <span class="p">[</span><span class="n">outs</span><span class="p">]</span>
            <span class="n">supported</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">fmt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_formats</span> <span class="k">for</span> <span class="n">fmt</span> <span class="ow">in</span> <span class="n">ins</span><span class="p">)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span> <span class="ow">and</span> <span class="n">supported</span>
        <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="Frontend.lookup_models">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.Frontend.lookup_models">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">lookup_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">lookup_models</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">frontends</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="p">],</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span></div>


<div class="viewcode-block" id="Frontend.process_features">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.Frontend.process_features">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">process_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">features</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">get_matching_features</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">FeatureType</span><span class="o">.</span><span class="n">FRONTEND</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
            <span class="k">assert</span> <span class="p">(</span>  <span class="c1"># If this assertion occurs, continue with the next frontend instead of failing</span>
                <span class="c1"># (TODO: create custom exception type)</span>
                <span class="n">feature</span><span class="o">.</span><span class="n">name</span>
                <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">FEATURES</span>
            <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Incompatible feature: </span><span class="si">{</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="c1"># Instead we might introduce self.compatible and set it to true at this line</span>
            <span class="n">feature</span><span class="o">.</span><span class="n">used</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">feature</span><span class="o">.</span><span class="n">add_frontend_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
            <span class="n">feature</span><span class="o">.</span><span class="n">update_formats</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_formats</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_formats</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">features</span></div>


<div class="viewcode-block" id="Frontend.produce_artifacts">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.Frontend.produce_artifacts">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="c1"># def produce_artifacts(self, model):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">produce_artifacts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="Frontend.generate_input_data">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.Frontend.generate_input_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_input_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_names</span><span class="p">,</span> <span class="n">input_types</span><span class="p">,</span> <span class="n">input_shapes</span><span class="p">,</span> <span class="n">input_ranges</span><span class="p">,</span> <span class="n">input_quant_details</span><span class="p">,</span> <span class="n">in_paths</span><span class="p">):</span>
        <span class="c1"># TODO: drop self and move method out of frontends.py, support non-tflite models</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_data</span>
        <span class="n">inputs_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_data_fill_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;zeros&quot;</span><span class="p">,</span> <span class="s2">&quot;ones&quot;</span><span class="p">,</span> <span class="s2">&quot;random&quot;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gen_data_number</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">NEW</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">input_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">input_names</span><span class="p">):</span>
                    <span class="k">assert</span> <span class="n">input_name</span> <span class="ow">in</span> <span class="n">input_types</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Unknown dtype for input: </span><span class="si">{</span><span class="n">input_name</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">dtype</span> <span class="o">=</span> <span class="n">input_types</span><span class="p">[</span><span class="n">input_name</span><span class="p">]</span>
                    <span class="n">quant</span> <span class="o">=</span> <span class="n">input_quant_details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">input_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">rng</span> <span class="o">=</span> <span class="n">input_ranges</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">input_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">gen_dtype</span> <span class="o">=</span> <span class="n">dtype</span>
                    <span class="k">if</span> <span class="n">quant</span><span class="p">:</span>
                        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">ty</span> <span class="o">=</span> <span class="n">quant</span>
                        <span class="k">assert</span> <span class="s2">&quot;float&quot;</span> <span class="ow">in</span> <span class="n">ty</span><span class="p">,</span> <span class="s2">&quot;Input already quantized?&quot;</span>
                        <span class="k">if</span> <span class="n">NEW</span><span class="p">:</span>
                            <span class="n">gen_dtype</span> <span class="o">=</span> <span class="n">ty</span>
                    <span class="k">assert</span> <span class="n">input_name</span> <span class="ow">in</span> <span class="n">input_shapes</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Unknown shape for input: </span><span class="si">{</span><span class="n">input_name</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">shape</span> <span class="o">=</span> <span class="n">input_shapes</span><span class="p">[</span><span class="n">input_name</span><span class="p">]</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_data_fill_mode</span> <span class="o">==</span> <span class="s2">&quot;zeros&quot;</span><span class="p">:</span>
                        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">gen_dtype</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_data_fill_mode</span> <span class="o">==</span> <span class="s2">&quot;ones&quot;</span><span class="p">:</span>
                        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">gen_dtype</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_data_fill_mode</span> <span class="o">==</span> <span class="s2">&quot;random&quot;</span><span class="p">:</span>
                        <span class="n">DIST</span> <span class="o">=</span> <span class="s2">&quot;uniform&quot;</span>
                        <span class="k">if</span> <span class="n">DIST</span> <span class="o">==</span> <span class="s2">&quot;uniform&quot;</span><span class="p">:</span>
                            <span class="n">UPPER</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">LOWER</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">if</span> <span class="n">rng</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">rng</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Range should be a tuple (lower, upper)&quot;</span>
                                <span class="n">LOWER</span><span class="p">,</span> <span class="n">UPPER</span> <span class="o">=</span> <span class="n">rng</span>
                            <span class="k">if</span> <span class="s2">&quot;float&quot;</span> <span class="ow">in</span> <span class="n">gen_dtype</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">UPPER</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="c1"># UPPER = 1.0</span>
                                    <span class="n">UPPER</span> <span class="o">=</span> <span class="mf">0.5</span>
                                <span class="k">if</span> <span class="n">LOWER</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="c1"># LOWER = -1.0</span>
                                    <span class="n">LOWER</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span>
                            <span class="k">elif</span> <span class="s2">&quot;int&quot;</span> <span class="ow">in</span> <span class="n">gen_dtype</span><span class="p">:</span>
                                <span class="n">dtype_info</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">gen_dtype</span><span class="p">),)</span>
                                <span class="k">if</span> <span class="n">UPPER</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">UPPER</span> <span class="o">=</span> <span class="n">dtype_info</span><span class="o">.</span><span class="n">max</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">assert</span> <span class="n">UPPER</span> <span class="o">&lt;=</span> <span class="n">dtype_info</span><span class="o">.</span><span class="n">max</span><span class="p">,</span> <span class="s2">&quot;Out of dtype bound&quot;</span>
                                <span class="k">if</span> <span class="n">LOWER</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">LOWER</span> <span class="o">=</span> <span class="n">dtype_info</span><span class="o">.</span><span class="n">min</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">assert</span> <span class="n">LOWER</span> <span class="o">&gt;=</span> <span class="n">dtype_info</span><span class="o">.</span><span class="n">min</span><span class="p">,</span> <span class="s2">&quot;Out of dtype bound&quot;</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported dtype: </span><span class="si">{</span><span class="n">gen_dtype</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">assert</span> <span class="n">LOWER</span> <span class="o">&lt;=</span> <span class="n">UPPER</span>
                            <span class="n">RANGE</span> <span class="o">=</span> <span class="n">UPPER</span> <span class="o">-</span> <span class="n">LOWER</span>
                            <span class="k">assert</span> <span class="n">RANGE</span> <span class="o">&gt;</span> <span class="mi">0</span>
                            <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">LOWER</span><span class="p">,</span> <span class="n">UPPER</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>
                            <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">gen_dtype</span><span class="p">)</span>
                            <span class="c1"># input(&quot;?=&quot;)</span>
                            <span class="c1"># if &quot;float&quot; in dtype:</span>
                            <span class="c1">#     arr = np.random.rand(*shape).astype(dtype)</span>
                            <span class="c1"># elif &quot;int&quot; in dtype:</span>
                            <span class="c1">#     arr = np.random.randint(np.iinfo(dtype).min,</span>
                            <span class="c1">#     np.iinfo(dtype).max, size=shape, dtype=dtype)</span>
                            <span class="c1"># else:</span>
                            <span class="c1">#     assert False</span>
                        <span class="c1"># Quantize if required</span>
                        <span class="c1"># if gen_dtype != dtype:</span>
                        <span class="k">if</span> <span class="n">quant</span><span class="p">:</span>
                            <span class="k">assert</span> <span class="s2">&quot;int&quot;</span> <span class="ow">in</span> <span class="n">dtype</span>
                            <span class="c1"># assert quant</span>
                            <span class="n">scale</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">ty</span> <span class="o">=</span> <span class="n">quant</span>
                            <span class="n">arr</span> <span class="o">=</span> <span class="p">(</span><span class="n">arr</span> <span class="o">/</span> <span class="n">scale</span><span class="p">)</span> <span class="o">+</span> <span class="n">shift</span>
                            <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
                            <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
                            <span class="c1"># input(&quot;!=&quot;)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported distribution: </span><span class="si">{</span><span class="n">DIST</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="kc">False</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">input_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="n">inputs_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_data_fill_mode</span> <span class="o">==</span> <span class="s2">&quot;file&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_data_file</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_paths</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;in_paths is empty&quot;</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_paths</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">in_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                        <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">in_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">iterdir</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">files</span> <span class="o">=</span> <span class="n">in_paths</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">NEW</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
                        <span class="n">file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="n">file</span><span class="o">.</span><span class="n">is_file</span><span class="p">(),</span> <span class="sa">f</span><span class="s2">&quot;Not found: </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">basename</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">stem</span><span class="p">,</span> <span class="n">file</span><span class="o">.</span><span class="n">suffix</span>
                    <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s2">&quot;.bin&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s2">&quot;_&quot;</span> <span class="ow">in</span> <span class="n">basename</span><span class="p">:</span>
                            <span class="n">i</span><span class="p">,</span> <span class="n">ii</span> <span class="o">=</span> <span class="n">basename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                            <span class="n">ii</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">basename</span><span class="p">)</span>
                            <span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">temp</span><span class="p">:</span>
                            <span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
                    <span class="k">elif</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;.npy&quot;</span><span class="p">,</span> <span class="s2">&quot;.npz&quot;</span><span class="p">]:</span>
                        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported ext: </span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gen_data_number</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">))):</span>
                    <span class="k">assert</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">temp</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">input_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">input_names</span><span class="p">):</span>
                        <span class="k">assert</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="k">assert</span> <span class="n">input_name</span> <span class="ow">in</span> <span class="n">input_types</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Unknown dtype for input: </span><span class="si">{</span><span class="n">input_name</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">dtype</span> <span class="o">=</span> <span class="n">input_types</span><span class="p">[</span><span class="n">input_name</span><span class="p">]</span>
                        <span class="n">quant</span> <span class="o">=</span> <span class="n">input_quant_details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">input_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="n">rng</span> <span class="o">=</span> <span class="n">input_ranges</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">input_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="n">gen_dtype</span> <span class="o">=</span> <span class="n">dtype</span>
                        <span class="k">if</span> <span class="n">quant</span><span class="p">:</span>
                            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">ty</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">quant</span>
                            <span class="c1"># assert &quot;float&quot; in ty, &quot;Input already quantized?&quot;</span>
                            <span class="k">if</span> <span class="n">NEW</span><span class="p">:</span>
                                <span class="n">gen_dtype</span> <span class="o">=</span> <span class="n">ty</span>
                        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">ii</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">gen_dtype</span><span class="p">)</span>
                        <span class="k">assert</span> <span class="n">input_name</span> <span class="ow">in</span> <span class="n">input_shapes</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Unknown shape for input: </span><span class="si">{</span><span class="n">input_name</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">shape</span> <span class="o">=</span> <span class="n">input_shapes</span><span class="p">[</span><span class="n">input_name</span><span class="p">]</span>
                        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>
                        <span class="c1"># Quantize if required</span>
                        <span class="c1"># if gen_dtype != dtype:</span>
                        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="k">assert</span> <span class="s2">&quot;int&quot;</span> <span class="ow">in</span> <span class="n">dtype</span>
                            <span class="c1"># assert quant</span>
                            <span class="n">scale</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">ty</span><span class="p">,</span> <span class="n">qrng</span> <span class="o">=</span> <span class="n">quant</span>
                            <span class="k">if</span> <span class="n">qrng</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">qrng</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Range should be a tuple (lower, upper)&quot;</span>
                                <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="n">qrng</span>
                                <span class="k">assert</span> <span class="n">lower</span> <span class="o">&lt;=</span> <span class="n">upper</span>
                                <span class="n">CLIP_INPUTS</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">if</span> <span class="n">CLIP_INPUTS</span><span class="p">:</span>
                                    <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">lower</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span>
                                        <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">arr</span><span class="p">),</span> <span class="n">lower</span>
                                    <span class="p">),</span> <span class="s2">&quot;Range missmatch (lower)&quot;</span>
                                    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">upper</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span>
                                        <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">arr</span><span class="p">),</span> <span class="n">upper</span>
                                    <span class="p">),</span> <span class="s2">&quot;Range missmatch (upper)&quot;</span>
                            <span class="n">arr</span> <span class="o">=</span> <span class="p">(</span><span class="n">arr</span> <span class="o">/</span> <span class="n">scale</span><span class="p">)</span> <span class="o">+</span> <span class="n">shift</span>
                            <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
                            <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
                            <span class="c1"># input(&quot;!=&quot;)</span>
                        <span class="k">if</span> <span class="n">rng</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="c1"># TODO: Move shared code!</span>
                            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">rng</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Range should be a tuple (lower, upper)&quot;</span>
                            <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="n">rng</span>
                            <span class="k">assert</span> <span class="n">lower</span> <span class="o">&lt;=</span> <span class="n">upper</span>
                            <span class="n">CLIP_INPUTS</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="n">CLIP_INPUTS</span><span class="p">:</span>
                                <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">lower</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">arr</span><span class="p">),</span> <span class="n">lower</span><span class="p">),</span> <span class="s2">&quot;Range missmatch (lower)&quot;</span>
                                <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">upper</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">arr</span><span class="p">),</span> <span class="n">upper</span><span class="p">),</span> <span class="s2">&quot;Range missmatch (upper)&quot;</span>
                        <span class="n">data</span><span class="p">[</span><span class="n">input_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span>
                    <span class="n">inputs_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_data_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Missing value for gen_data_file&quot;</span>
                <span class="n">file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gen_data_file</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">file</span><span class="o">.</span><span class="n">is_file</span><span class="p">(),</span> <span class="sa">f</span><span class="s2">&quot;File not found: </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="c1"># for i, input_name in enumerate(input_names):</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_data_fill_mode</span> <span class="o">==</span> <span class="s2">&quot;dataset&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;unsupported fill_mode: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">gen_data_fill_mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">inputs_data</span></div>


<div class="viewcode-block" id="Frontend.generate_output_ref_data">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.Frontend.generate_output_ref_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_output_ref_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">inputs_data</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">out_paths</span><span class="p">,</span> <span class="n">output_names</span><span class="p">,</span> <span class="n">output_types</span><span class="p">,</span> <span class="n">output_shapes</span><span class="p">,</span> <span class="n">output_quant_details</span>
    <span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_ref_data</span>
        <span class="n">outputs_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_ref_data_mode</span> <span class="o">==</span> <span class="s2">&quot;model&quot;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputs_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">input_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inputs_data</span><span class="p">):</span>
                <span class="c1"># input(&quot;321?&quot;)</span>
                <span class="n">output_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">quant</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dequant</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">outputs_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output_data</span><span class="p">)</span>
                <span class="c1"># input(&quot;321!&quot;)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_ref_data_mode</span> <span class="o">==</span> <span class="s2">&quot;file&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_ref_data_file</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">out_paths</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;out_paths is empty&quot;</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">out_paths</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">out_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                        <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">out_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">iterdir</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">files</span> <span class="o">=</span> <span class="n">out_paths</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputs_data</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span>
                    <span class="n">files</span>
                <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Missing output data for provided inputs. (Expected: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">inputs_data</span><span class="p">)</span><span class="si">}</span><span class="s2">, Got: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
                        <span class="n">file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="n">file</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span>
                    <span class="n">basename</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">stem</span><span class="p">,</span> <span class="n">file</span><span class="o">.</span><span class="n">suffix</span>
                    <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s2">&quot;.bin&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s2">&quot;_&quot;</span> <span class="ow">in</span> <span class="n">basename</span><span class="p">:</span>
                            <span class="n">i</span><span class="p">,</span> <span class="n">ii</span> <span class="o">=</span> <span class="n">basename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                            <span class="n">ii</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">basename</span><span class="p">)</span>
                            <span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">temp</span><span class="p">:</span>
                            <span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
                    <span class="k">elif</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;.npy&quot;</span><span class="p">,</span> <span class="s2">&quot;.npz&quot;</span><span class="p">]:</span>
                        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported ext: </span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># TODO: handle case where there are more output samples than input samples?</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">)):</span>
                    <span class="k">assert</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">temp</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">output_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">output_names</span><span class="p">):</span>
                        <span class="k">assert</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="k">assert</span> <span class="n">output_name</span> <span class="ow">in</span> <span class="n">output_types</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Unknown dtype for output: </span><span class="si">{</span><span class="n">output_name</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">dtype</span> <span class="o">=</span> <span class="n">output_types</span><span class="p">[</span><span class="n">output_name</span><span class="p">]</span>
                        <span class="n">dequant</span> <span class="o">=</span> <span class="n">output_quant_details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">output_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">dequant</span><span class="p">:</span>
                            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">ty</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">dequant</span>
                            <span class="n">dtype</span> <span class="o">=</span> <span class="n">ty</span>
                        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">ii</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
                        <span class="k">assert</span> <span class="n">output_name</span> <span class="ow">in</span> <span class="n">output_shapes</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Unknown shape for output: </span><span class="si">{</span><span class="n">output_name</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">shape</span> <span class="o">=</span> <span class="n">output_shapes</span><span class="p">[</span><span class="n">output_name</span><span class="p">]</span>
                        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>
                        <span class="n">data</span><span class="p">[</span><span class="n">output_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span>
                    <span class="n">outputs_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_ref_data_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Missing value for gen_ref_data_file&quot;</span>
                <span class="n">file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gen_data_file</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">file</span><span class="o">.</span><span class="n">is_file</span><span class="p">(),</span> <span class="sa">f</span><span class="s2">&quot;File not found: </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;unsupported fill_mode: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">gen_ref_data_mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outputs_data</span></div>


<div class="viewcode-block" id="Frontend.generate_ref_labels">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.Frontend.generate_ref_labels">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_ref_labels</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">inputs_data</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">out_labels_paths</span><span class="p">,</span> <span class="n">output_names</span><span class="p">,</span> <span class="n">output_types</span><span class="p">,</span> <span class="n">output_shapes</span><span class="p">,</span> <span class="n">output_quant_details</span>
    <span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_ref_labels</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_ref_labels_mode</span> <span class="o">==</span> <span class="s2">&quot;model&quot;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputs_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">input_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inputs_data</span><span class="p">):</span>
                <span class="n">output_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">quant</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dequant</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Does not support multi-output classification&quot;</span>
                <span class="n">output_data</span> <span class="o">=</span> <span class="n">output_data</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">output_data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="n">top_label</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">output_data</span><span class="p">)</span>
                <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">top_label</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_ref_labels_mode</span> <span class="o">==</span> <span class="s2">&quot;file&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_ref_labels_file</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">out_labels_paths</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;labels_paths is empty&quot;</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">out_labels_paths</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="n">file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">out_labels_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_ref_labels_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Missing value for gen_ref_labels_file&quot;</span>
                <span class="n">file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gen_ref_labels_file</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">file</span><span class="o">.</span><span class="n">is_file</span><span class="p">(),</span> <span class="sa">f</span><span class="s2">&quot;File not found: </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">suffix</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="n">ext</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

                <span class="n">labels_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                <span class="k">assert</span> <span class="s2">&quot;i&quot;</span> <span class="ow">in</span> <span class="n">labels_df</span><span class="o">.</span><span class="n">columns</span>
                <span class="k">assert</span> <span class="s2">&quot;label_idx&quot;</span> <span class="ow">in</span> <span class="n">labels_df</span><span class="o">.</span><span class="n">columns</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputs_data</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels_df</span><span class="p">)</span>
                <span class="n">labels_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">labels_df</span><span class="p">[</span><span class="s2">&quot;label_idx&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputs_data</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fmt not supported: </span><span class="si">{</span><span class="n">fmt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;unsupported fill_mode: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">gen_ref_labels_mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">labels</span></div>


<div class="viewcode-block" id="Frontend.generate_model_info">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.Frontend.generate_model_info">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_model_info</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_names</span><span class="p">,</span>
        <span class="n">output_names</span><span class="p">,</span>
        <span class="n">input_shapes</span><span class="p">,</span>
        <span class="n">output_shapes</span><span class="p">,</span>
        <span class="n">input_types</span><span class="p">,</span>
        <span class="n">output_types</span><span class="p">,</span>
        <span class="n">input_ranges</span><span class="p">,</span>
        <span class="n">output_ranges</span><span class="p">,</span>
        <span class="n">input_quant_details</span><span class="p">,</span>
        <span class="n">output_quant_details</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">model_info_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;input_names&quot;</span><span class="p">:</span> <span class="n">input_names</span><span class="p">,</span>
            <span class="s2">&quot;output_names&quot;</span><span class="p">:</span> <span class="n">output_names</span><span class="p">,</span>
            <span class="s2">&quot;input_shapes&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">input_shapes</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
            <span class="s2">&quot;output_shapes&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">output_shapes</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
            <span class="s2">&quot;input_types&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">input_types</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
            <span class="s2">&quot;output_types&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">output_types</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
            <span class="s2">&quot;input_ranges&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">input_ranges</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
            <span class="s2">&quot;output_ranges&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">output_ranges</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
            <span class="s2">&quot;input_quant_details&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">input_quant_details</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
            <span class="s2">&quot;output_quant_details&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">output_quant_details</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
        <span class="p">}</span>
        <span class="c1"># nested version</span>
        <span class="c1"># model_info_dict = {</span>
        <span class="c1">#     &quot;inputs&quot;: [</span>
        <span class="c1">#         {</span>
        <span class="c1">#             &quot;name&quot;: &quot;input_1&quot;,</span>
        <span class="c1">#             &quot;shape&quot;: [1, 1014],</span>
        <span class="c1">#             &quot;type&quot;: &quot;int8&quot;,</span>
        <span class="c1">#         }</span>
        <span class="c1">#     ],</span>
        <span class="c1">#     &quot;outputs&quot;: [</span>
        <span class="c1">#         {</span>
        <span class="c1">#             &quot;name&quot;: &quot;output&quot;,</span>
        <span class="c1">#             &quot;shape&quot;: [1, 10],</span>
        <span class="c1">#             &quot;type&quot;: &quot;int8&quot;,</span>
        <span class="c1">#         }</span>
        <span class="c1">#     ],</span>
        <span class="c1"># }</span>
        <span class="k">return</span> <span class="n">model_info_dict</span>  <span class="c1"># TODO: turn into class</span></div>


<div class="viewcode-block" id="Frontend.process_metadata">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.Frontend.process_metadata">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">process_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">cfg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">model_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">metadata</span>
        <span class="n">in_paths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">out_paths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">labels_paths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">input_shapes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">output_shapes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">input_types</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">output_types</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">input_ranges</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">output_ranges</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">input_quant_details</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">output_quant_details</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;network_parameters&quot;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
            <span class="n">network</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;network_parameters&quot;</span><span class="p">]</span>
            <span class="k">assert</span> <span class="s2">&quot;input_nodes&quot;</span> <span class="ow">in</span> <span class="n">network</span>
            <span class="n">ins</span> <span class="o">=</span> <span class="n">network</span><span class="p">[</span><span class="s2">&quot;input_nodes&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">inp</span> <span class="ow">in</span> <span class="n">ins</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shape&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">ty</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dtype&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ty</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ty</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># legacy</span>
                <span class="n">rng</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;range&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">quantize</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;quantize&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">and</span> <span class="n">shape</span><span class="p">:</span>
                    <span class="n">input_shapes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">shape</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">and</span> <span class="n">ty</span><span class="p">:</span>
                    <span class="n">input_types</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ty</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">and</span> <span class="n">rng</span><span class="p">:</span>
                    <span class="n">input_ranges</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">rng</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">and</span> <span class="n">quantize</span><span class="p">:</span>
                    <span class="n">quant_scale</span> <span class="o">=</span> <span class="n">quantize</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scale&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">quant_zero_shift</span> <span class="o">=</span> <span class="n">quantize</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;zero_shift&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">quant_dtype</span> <span class="o">=</span> <span class="n">quantize</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dtype&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">quant_range</span> <span class="o">=</span> <span class="n">quantize</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;range&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">quant_details</span> <span class="o">=</span> <span class="p">[</span><span class="n">quant_scale</span><span class="p">,</span> <span class="n">quant_zero_shift</span><span class="p">,</span> <span class="n">quant_dtype</span><span class="p">,</span> <span class="n">quant_range</span><span class="p">]</span>
                    <span class="n">input_quant_details</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">quant_details</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_inout_data</span> <span class="ow">or</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">gen_data</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_data_fill_mode</span> <span class="o">==</span> <span class="s2">&quot;file&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_data_file</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span>
                <span class="p">):</span>
                    <span class="k">if</span> <span class="s2">&quot;example_input&quot;</span> <span class="ow">in</span> <span class="n">inp</span> <span class="ow">and</span> <span class="s2">&quot;path&quot;</span> <span class="ow">in</span> <span class="n">inp</span><span class="p">[</span><span class="s2">&quot;example_input&quot;</span><span class="p">]:</span>
                        <span class="n">in_data_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">inp</span><span class="p">[</span><span class="s2">&quot;example_input&quot;</span><span class="p">][</span><span class="s2">&quot;path&quot;</span><span class="p">])</span>
                        <span class="c1"># TODO: this will only work with relative paths to model dir! (Fallback to parent directories?)</span>
                        <span class="n">in_path</span> <span class="o">=</span> <span class="n">model_dir</span> <span class="o">/</span> <span class="n">in_data_dir</span>
                        <span class="k">assert</span> <span class="p">(</span>
                            <span class="n">in_path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()</span>
                        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Input data directory defined in model metadata does not exist: </span><span class="si">{</span><span class="n">in_path</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">in_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">in_path</span><span class="p">)</span>
            <span class="k">assert</span> <span class="s2">&quot;output_nodes&quot;</span> <span class="ow">in</span> <span class="n">network</span>
            <span class="n">outs</span> <span class="o">=</span> <span class="n">network</span><span class="p">[</span><span class="s2">&quot;output_nodes&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">outp</span> <span class="ow">in</span> <span class="n">outs</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">outp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="n">outp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shape&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">ty</span> <span class="o">=</span> <span class="n">outp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dtype&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ty</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ty</span> <span class="o">=</span> <span class="n">outp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># legacy</span>
                <span class="n">rng</span> <span class="o">=</span> <span class="n">outp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;range&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">dequantize</span> <span class="o">=</span> <span class="n">outp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dequantize&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">and</span> <span class="n">shape</span><span class="p">:</span>
                    <span class="n">output_shapes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">shape</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">and</span> <span class="n">ty</span><span class="p">:</span>
                    <span class="n">output_types</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ty</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">and</span> <span class="n">rng</span><span class="p">:</span>
                    <span class="n">output_ranges</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">rng</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">and</span> <span class="n">dequantize</span><span class="p">:</span>
                    <span class="n">quant_scale</span> <span class="o">=</span> <span class="n">dequantize</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scale&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">quant_zero_shift</span> <span class="o">=</span> <span class="n">dequantize</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;zero_shift&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">quant_dtype</span> <span class="o">=</span> <span class="n">dequantize</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dtype&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">quant_range</span> <span class="o">=</span> <span class="n">dequantize</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;range&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">quant_details</span> <span class="o">=</span> <span class="p">[</span><span class="n">quant_scale</span><span class="p">,</span> <span class="n">quant_zero_shift</span><span class="p">,</span> <span class="n">quant_dtype</span><span class="p">,</span> <span class="n">quant_range</span><span class="p">]</span>
                    <span class="n">output_quant_details</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">quant_details</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_inout_data</span> <span class="ow">or</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">gen_ref_data</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_ref_data_mode</span> <span class="o">==</span> <span class="s2">&quot;file&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_ref_data_file</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span>
                <span class="p">):</span>
                    <span class="k">if</span> <span class="s2">&quot;test_output_path&quot;</span> <span class="ow">in</span> <span class="n">outp</span><span class="p">:</span>
                        <span class="n">out_data_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">outp</span><span class="p">[</span><span class="s2">&quot;test_output_path&quot;</span><span class="p">])</span>
                        <span class="n">out_path</span> <span class="o">=</span> <span class="n">model_dir</span> <span class="o">/</span> <span class="n">out_data_dir</span>
                        <span class="k">assert</span> <span class="p">(</span>
                            <span class="n">out_path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()</span>
                        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Output data directory defined in model metadata does not exist: </span><span class="si">{</span><span class="n">out_path</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">out_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_ref_labels</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_ref_labels_mode</span> <span class="o">==</span> <span class="s2">&quot;file&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_ref_labels_file</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;test_labels_file&quot;</span> <span class="ow">in</span> <span class="n">outp</span><span class="p">:</span>
                        <span class="n">labels_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">outp</span><span class="p">[</span><span class="s2">&quot;test_labels_file&quot;</span><span class="p">])</span>
                        <span class="n">labels_path</span> <span class="o">=</span> <span class="n">model_dir</span> <span class="o">/</span> <span class="n">labels_file</span>
                        <span class="k">assert</span> <span class="p">(</span>
                            <span class="n">labels_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span>
                        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Labels file defined in model metadata does not exist: </span><span class="si">{</span><span class="n">labels_path</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">labels_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labels_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fallback_in_path</span> <span class="o">=</span> <span class="n">model_dir</span> <span class="o">/</span> <span class="s2">&quot;input&quot;</span>
            <span class="k">if</span> <span class="n">fallback_in_path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                <span class="n">in_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fallback_in_path</span><span class="p">)</span>
            <span class="n">fallback_out_path</span> <span class="o">=</span> <span class="n">model_dir</span> <span class="o">/</span> <span class="s2">&quot;output&quot;</span>
            <span class="k">if</span> <span class="n">fallback_out_path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                <span class="n">out_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fallback_out_path</span><span class="p">)</span>
            <span class="n">fallback_labels_path</span> <span class="o">=</span> <span class="n">model_dir</span> <span class="o">/</span> <span class="s2">&quot;output_labels.csv&quot;</span>
            <span class="k">if</span> <span class="n">fallback_labels_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="n">labels_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fallback_labels_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">inputs_path</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Overriding default model input data with user path&quot;</span><span class="p">)</span>
            <span class="n">in_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">inputs_path</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">outputs_path</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Overriding default model output data with user path&quot;</span><span class="p">)</span>
            <span class="n">out_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">outputs_path</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">output_labels_path</span><span class="p">:</span>  <span class="c1"># TODO</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Overriding default model output labels with user path&quot;</span><span class="p">)</span>
            <span class="n">labels_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">output_labels_path</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;backends&quot;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">cfg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">backend_options</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;backends&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">backend</span> <span class="ow">in</span> <span class="n">backend_options</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">backend_options</span><span class="p">[</span><span class="n">backend</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">flattened</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">backend</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">backend_options</span><span class="p">[</span><span class="n">backend</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                    <span class="n">cfg</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">flattened</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_shapes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_types</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">input_shapes</span><span class="p">),</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">input_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">input_shapes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_types</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">input_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">input_types</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">input_names</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="p">(</span>
                    <span class="n">input_names</span><span class="p">,</span>
                    <span class="n">input_shapes</span><span class="p">,</span>
                    <span class="n">input_types</span><span class="p">,</span>
                    <span class="n">input_quant_details</span><span class="p">,</span>
                    <span class="n">output_names</span><span class="p">,</span>
                    <span class="n">output_shapes</span><span class="p">,</span>
                    <span class="n">output_types</span><span class="p">,</span>
                    <span class="n">output_quant_details</span><span class="p">,</span>
                <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_model_info</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Model info could not be extracted.&quot;</span><span class="p">)</span>

        <span class="c1"># Detect model support code (Allow overwrite in metadata YAML)</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">support_path</span><span class="p">:</span>
            <span class="n">support_path</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">support_path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">support_path</span> <span class="o">=</span> <span class="n">model_dir</span> <span class="o">/</span> <span class="s2">&quot;support&quot;</span>
        <span class="k">if</span> <span class="n">support_path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
            <span class="k">assert</span> <span class="n">cfg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="c1"># TODO: onlu overwrite if unset?</span>
            <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mlif.model_support_dir&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cfg</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;mlif.model_support_dir&quot;</span><span class="p">:</span> <span class="n">support_path</span><span class="p">})</span>
            <span class="c1"># cfg.update({&quot;espidf.model_support_dir&quot;: support_path})</span>
            <span class="c1"># cfg.update({&quot;zephyr.model_support_dir&quot;: support_path})</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_paths</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;mlif.input_data_path&quot;</span><span class="p">:</span> <span class="n">in_paths</span><span class="p">})</span>
            <span class="c1"># cfg.update({&quot;espidf.input_data_path&quot;: in_paths})</span>
            <span class="c1"># cfg.update({&quot;zephyr.input_data_path&quot;: in_paths})</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">out_paths</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;mlif.output_data_path&quot;</span><span class="p">:</span> <span class="n">out_paths</span><span class="p">})</span>
            <span class="c1"># cfg.update({&quot;espidf.output_data_path&quot;: out_paths})</span>
            <span class="c1"># cfg.update({&quot;zephyr.output_data_path&quot;: out_paths})</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels_paths</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;mlif.output_labels_path&quot;</span><span class="p">:</span> <span class="n">labels_paths</span><span class="p">})</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_shapes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.input_shapes&quot;</span><span class="p">:</span> <span class="n">input_shapes</span><span class="p">})</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_shapes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.output_shapes&quot;</span><span class="p">:</span> <span class="n">output_shapes</span><span class="p">})</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_types</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.input_types&quot;</span><span class="p">:</span> <span class="n">input_types</span><span class="p">})</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_types</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.output_types&quot;</span><span class="p">:</span> <span class="n">output_types</span><span class="p">})</span>
        <span class="c1"># flattened version</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_shapes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_types</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">output_shapes</span><span class="p">),</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">output_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">output_shapes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_shapes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">output_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">output_types</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">artifacts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">inputs_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">gen_model_info</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># TODO: move to self (configurable)</span>
        <span class="k">if</span> <span class="n">gen_model_info</span><span class="p">:</span>
            <span class="n">model_info_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_model_info</span><span class="p">(</span>
                <span class="n">input_names</span><span class="p">,</span>
                <span class="n">output_names</span><span class="p">,</span>
                <span class="n">input_shapes</span><span class="p">,</span>
                <span class="n">output_shapes</span><span class="p">,</span>
                <span class="n">input_types</span><span class="p">,</span>
                <span class="n">output_types</span><span class="p">,</span>
                <span class="n">input_ranges</span><span class="p">,</span>
                <span class="n">output_ranges</span><span class="p">,</span>
                <span class="n">input_quant_details</span><span class="p">,</span>
                <span class="n">output_quant_details</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>

            <span class="n">content</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">model_info_dict</span><span class="p">)</span>
            <span class="n">model_info_artifact</span> <span class="o">=</span> <span class="n">Artifact</span><span class="p">(</span>
                <span class="s2">&quot;model_info.yml&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">ArtifactFormat</span><span class="o">.</span><span class="n">TEXT</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;model_info&quot;</span><span class="p">,)</span>
            <span class="p">)</span>
            <span class="n">artifacts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_info_artifact</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_data</span><span class="p">:</span>
            <span class="n">inputs_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_input_data</span><span class="p">(</span>
                <span class="n">input_names</span><span class="p">,</span> <span class="n">input_types</span><span class="p">,</span> <span class="n">input_shapes</span><span class="p">,</span> <span class="n">input_ranges</span><span class="p">,</span> <span class="n">input_quant_details</span><span class="p">,</span> <span class="n">in_paths</span>
            <span class="p">)</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_data_fmt</span>
            <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;npy&quot;</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdirname</span><span class="p">:</span>
                    <span class="n">tempfilename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tmpdirname</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;inputs.npy&quot;</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">tempfilename</span><span class="p">,</span> <span class="n">inputs_data</span><span class="p">)</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tempfilename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">raw</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;npz&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported fmt: </span><span class="si">{</span><span class="n">fmt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">raw</span>
            <span class="n">inputs_data_artifact</span> <span class="o">=</span> <span class="n">Artifact</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;inputs.</span><span class="si">{</span><span class="n">fmt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="n">raw</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">ArtifactFormat</span><span class="o">.</span><span class="n">BIN</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;inputs&quot;</span><span class="p">,</span> <span class="n">fmt</span><span class="p">))</span>
            <span class="n">artifacts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inputs_data_artifact</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_ref_data</span><span class="p">:</span>
            <span class="n">outputs_ref_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_output_ref_data</span><span class="p">(</span>
                <span class="n">inputs_data</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">out_paths</span><span class="p">,</span> <span class="n">output_names</span><span class="p">,</span> <span class="n">output_types</span><span class="p">,</span> <span class="n">output_shapes</span><span class="p">,</span> <span class="n">output_quant_details</span>
            <span class="p">)</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_data_fmt</span>
            <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;npy&quot;</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdirname</span><span class="p">:</span>
                    <span class="n">tempfilename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tmpdirname</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;outputs_ref.npy&quot;</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">tempfilename</span><span class="p">,</span> <span class="n">outputs_ref_data</span><span class="p">)</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tempfilename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">raw</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;npz&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported fmt: </span><span class="si">{</span><span class="n">fmt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">raw</span>
            <span class="n">outputs_ref_artifact</span> <span class="o">=</span> <span class="n">Artifact</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;outputs_ref.</span><span class="si">{</span><span class="n">fmt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="n">raw</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">ArtifactFormat</span><span class="o">.</span><span class="n">BIN</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;outputs_ref&quot;</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">artifacts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outputs_ref_artifact</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_ref_labels</span><span class="p">:</span>
            <span class="n">labels_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_ref_labels</span><span class="p">(</span>
                <span class="n">inputs_data</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">labels_paths</span><span class="p">,</span> <span class="n">output_names</span><span class="p">,</span> <span class="n">output_types</span><span class="p">,</span> <span class="n">output_shapes</span><span class="p">,</span> <span class="n">output_quant_details</span>
            <span class="p">)</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_ref_labels_fmt</span>
            <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;npy&quot;</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdirname</span><span class="p">:</span>
                    <span class="n">tempfilename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tmpdirname</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;labels.npy&quot;</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">tempfilename</span><span class="p">,</span> <span class="n">labels_ref</span><span class="p">)</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tempfilename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">raw</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;npz&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span>
            <span class="k">elif</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;txt&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span>
            <span class="k">elif</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported fmt: </span><span class="si">{</span><span class="n">fmt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">raw</span>
            <span class="n">labels_ref_artifact</span> <span class="o">=</span> <span class="n">Artifact</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;labels_ref.</span><span class="si">{</span><span class="n">fmt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="n">raw</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">ArtifactFormat</span><span class="o">.</span><span class="n">BIN</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;labels_ref&quot;</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">artifacts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labels_ref_artifact</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">artifacts</span></div>


<div class="viewcode-block" id="Frontend.generate">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.Frontend.generate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
        <span class="n">artifacts</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">paths</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">count</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">formats</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; frontend expects at least one model&quot;</span>
        <span class="n">max_ins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_formats</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">count</span> <span class="o">&lt;=</span> <span class="n">max_ins</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; frontend did not expect more than </span><span class="si">{</span><span class="n">max_ins</span><span class="si">}</span><span class="s2"> models&quot;</span>
        <span class="n">formats</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">formats</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">supports_formats</span><span class="p">(</span><span class="n">formats</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Invalid model format for &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; frontend&quot;</span>

        <span class="n">artifacts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">produce_artifacts</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">artifacts</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">artifacts</span> <span class="o">=</span> <span class="p">[</span><span class="n">artifacts</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">artifacts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; frontend should produce at least one model&quot;</span>
        <span class="n">max_outs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_formats</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">artifacts</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">max_outs</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; frontend should not return more than </span><span class="si">{</span><span class="n">max_outs</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># If we want to use the same instance of this Frontend in parallel, we need to get rid of self.artifacts...</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="n">artifacts</span><span class="p">},</span> <span class="p">{}</span></div>


<div class="viewcode-block" id="Frontend.generate_artifacts">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.Frontend.generate_artifacts">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_artifacts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Artifact</span><span class="p">]:</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">artifacts</span><span class="p">,</span> <span class="n">metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="c1"># TODO: do something with out?</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="n">Metrics</span><span class="p">()}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">metrics_</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;default&quot;</span><span class="p">:</span>
                <span class="n">metrics_</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;Load Stage Time [s]&quot;</span><span class="p">,</span> <span class="n">diff</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">metrics_</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">include_optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">artifact</span> <span class="o">=</span> <span class="n">Artifact</span><span class="p">(</span><span class="s2">&quot;load_metrics.csv&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">ArtifactFormat</span><span class="o">.</span><span class="n">TEXT</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;metrics&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">artifacts</span><span class="p">:</span>
                <span class="n">artifacts</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">artifacts</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">artifact</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">artifacts</span> <span class="o">=</span> <span class="n">artifacts</span>
        <span class="k">return</span> <span class="n">artifacts</span></div>


<div class="viewcode-block" id="Frontend.export_artifacts">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.Frontend.export_artifacts">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">export_artifacts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">artifacts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;No artifacts found, please run generate_artifacts() first&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="n">is_dir</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">suffix</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">is_dir</span><span class="p">:</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="n">path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()</span>
            <span class="p">),</span> <span class="s2">&quot;The supplied path does not exists.&quot;</span>  <span class="c1"># Make sure it actually exists (we do not create it by default)</span>
            <span class="k">for</span> <span class="n">artifact</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">artifacts</span><span class="p">:</span>
                <span class="n">artifact</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


<div class="viewcode-block" id="Frontend.get_platform_config">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.Frontend.get_platform_config">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_platform_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">platform</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{}</span></div>


<div class="viewcode-block" id="Frontend.add_platform_config">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.Frontend.add_platform_config">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_platform_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">platform</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_platform_config</span><span class="p">(</span><span class="n">platform</span><span class="p">))</span></div>


<div class="viewcode-block" id="Frontend.get_platform_defs">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.Frontend.get_platform_defs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_platform_defs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">platform</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{}</span></div>


<div class="viewcode-block" id="Frontend.add_platform_defs">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.Frontend.add_platform_defs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_platform_defs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">platform</span><span class="p">,</span> <span class="n">defs</span><span class="p">):</span>
        <span class="n">defs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_platform_defs</span><span class="p">(</span><span class="n">platform</span><span class="p">))</span></div>
</div>



<div class="viewcode-block" id="SimpleFrontend">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.SimpleFrontend">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SimpleFrontend</span><span class="p">(</span><span class="n">Frontend</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An abstract frontend with equivalent input and output formats.&quot;&quot;&quot;</span>

    <span class="c1"># Assumption: only raw model data</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">input_formats</span><span class="o">=</span><span class="p">[</span><span class="n">fmt</span><span class="p">],</span>
            <span class="n">output_formats</span><span class="o">=</span><span class="p">[</span><span class="n">fmt</span><span class="p">],</span>
            <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
        <span class="p">)</span>

<div class="viewcode-block" id="SimpleFrontend.produce_artifacts">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.SimpleFrontend.produce_artifacts">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">produce_artifacts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_formats</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_formats</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">paths</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">artifacts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">name</span>
        <span class="k">assert</span> <span class="s2">&quot;/&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">name</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_formats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">extension</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>  <span class="c1"># TODO: is an onnx model raw data or text?</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">artifacts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Artifact</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="n">raw</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">ArtifactFormat</span><span class="o">.</span><span class="n">RAW</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">artifacts</span></div>
</div>



<span class="c1"># TODO: move to frontends.py</span>
<span class="c1"># TODO: frontend parsed metadata instead of lookup.py?</span>
<span class="c1"># TODO: how to find inout_data?</span>
<div class="viewcode-block" id="TfLiteFrontend">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.TfLiteFrontend">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TfLiteFrontend</span><span class="p">(</span><span class="n">SimpleFrontend</span><span class="p">):</span>
    <span class="n">FEATURES</span> <span class="o">=</span> <span class="n">Frontend</span><span class="o">.</span><span class="n">FEATURES</span> <span class="o">|</span> <span class="p">{</span>
        <span class="s2">&quot;visualize&quot;</span><span class="p">,</span>
        <span class="s2">&quot;split_layers&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tflite_analyze&quot;</span><span class="p">,</span>
        <span class="s2">&quot;gen_data&quot;</span><span class="p">,</span>
        <span class="s2">&quot;gen_ref_data&quot;</span><span class="p">,</span>
        <span class="s2">&quot;gen_ref_labels&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">DEFAULTS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="o">**</span><span class="n">Frontend</span><span class="o">.</span><span class="n">DEFAULTS</span><span class="p">,</span>
        <span class="s2">&quot;visualize_enable&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;visualize_script&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;split_layers&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;pack_script&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;analyze_enable&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;analyze_script&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;check_integrity&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">REQUIRED</span> <span class="o">=</span> <span class="n">Frontend</span><span class="o">.</span><span class="n">REQUIRED</span>

    <span class="n">OPTIONAL</span> <span class="o">=</span> <span class="n">SimpleFrontend</span><span class="o">.</span><span class="n">OPTIONAL</span> <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;tflite_analyze.script&quot;</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="s2">&quot;tflite&quot;</span><span class="p">,</span>
            <span class="n">ModelFormats</span><span class="o">.</span><span class="n">TFLITE</span><span class="p">,</span>
            <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
        <span class="p">)</span>

<div class="viewcode-block" id="TfLiteFrontend.process_metadata">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.TfLiteFrontend.process_metadata">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">process_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">cfg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">process_metadata</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">cfg</span><span class="o">=</span><span class="n">cfg</span><span class="p">)</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">metadata</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_integrity</span><span class="p">:</span>
            <span class="n">checked</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">network_data</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;network&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">network_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">hash_data</span> <span class="o">=</span> <span class="n">network_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hash&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">hash_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">algorithm</span> <span class="o">=</span> <span class="n">hash_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;algorithm&quot;</span><span class="p">,</span> <span class="s2">&quot;sha1&quot;</span><span class="p">)</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">hash_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="n">check_integrity</span><span class="p">(</span><span class="n">algorithm</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">checked</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">checked</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Skipping integrity check (missing hash)&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_integrity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;check_integrity&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">visualize_enable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;visualize_enable&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">split_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;split_layers&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">visualize_script</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;visualize_script&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">pack_script</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;pack_script&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_enable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;analyze_enable&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_script</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;analyze_script&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="TfLiteFrontend.extract_model_info">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.TfLiteFrontend.extract_model_info">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">extract_model_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">Model</span><span class="p">):</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">tensorflow</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">tf</span>

        <span class="n">model_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">interpreter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">lite</span><span class="o">.</span><span class="n">Interpreter</span><span class="p">(</span><span class="n">model_path</span><span class="o">=</span><span class="n">model_path</span><span class="p">)</span>
        <span class="n">input_details</span> <span class="o">=</span> <span class="n">interpreter</span><span class="o">.</span><span class="n">get_input_details</span><span class="p">()</span>
        <span class="n">output_details</span> <span class="o">=</span> <span class="n">interpreter</span><span class="o">.</span><span class="n">get_output_details</span><span class="p">()</span>
        <span class="n">input_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">input_shapes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">input_types</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">input_quant_details</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">output_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">output_shapes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">output_types</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">output_quant_details</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">inp</span> <span class="ow">in</span> <span class="n">input_details</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">inp</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
            <span class="n">input_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">input_shapes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">inp</span><span class="p">[</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">input_types</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">inp</span><span class="p">[</span><span class="s2">&quot;dtype&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">name</span>
            <span class="k">if</span> <span class="s2">&quot;quantization&quot;</span> <span class="ow">in</span> <span class="n">inp</span><span class="p">:</span>
                <span class="n">scale</span><span class="p">,</span> <span class="n">zero_point</span> <span class="o">=</span> <span class="n">inp</span><span class="p">[</span><span class="s2">&quot;quantization&quot;</span><span class="p">]</span>
                <span class="n">quant</span> <span class="o">=</span> <span class="p">[</span><span class="n">scale</span><span class="p">,</span> <span class="n">zero_point</span><span class="p">,</span> <span class="s2">&quot;float32&quot;</span><span class="p">]</span>
                <span class="n">input_quant_details</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">quant</span>
        <span class="k">for</span> <span class="n">outp</span> <span class="ow">in</span> <span class="n">output_details</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">outp</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
            <span class="n">output_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">output_shapes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">outp</span><span class="p">[</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">output_types</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">outp</span><span class="p">[</span><span class="s2">&quot;dtype&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">name</span>
            <span class="k">if</span> <span class="s2">&quot;quantization&quot;</span> <span class="ow">in</span> <span class="n">outp</span><span class="p">:</span>
                <span class="n">scale</span><span class="p">,</span> <span class="n">zero_point</span> <span class="o">=</span> <span class="n">outp</span><span class="p">[</span><span class="s2">&quot;quantization&quot;</span><span class="p">]</span>
                <span class="n">quant</span> <span class="o">=</span> <span class="p">[</span><span class="n">scale</span><span class="p">,</span> <span class="n">zero_point</span><span class="p">,</span> <span class="s2">&quot;float32&quot;</span><span class="p">]</span>
                <span class="n">output_quant_details</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">quant</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">input_names</span><span class="p">,</span>
            <span class="n">input_shapes</span><span class="p">,</span>
            <span class="n">input_types</span><span class="p">,</span>
            <span class="n">input_quant_details</span><span class="p">,</span>
            <span class="n">output_names</span><span class="p">,</span>
            <span class="n">output_shapes</span><span class="p">,</span>
            <span class="n">output_types</span><span class="p">,</span>
            <span class="n">output_quant_details</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TfLiteFrontend.inference">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.TfLiteFrontend.inference">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">inference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span> <span class="n">input_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">],</span> <span class="n">quant</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dequant</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">tensorflow</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">tf</span>

        <span class="n">model_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">interpreter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">lite</span><span class="o">.</span><span class="n">Interpreter</span><span class="p">(</span><span class="n">model_path</span><span class="o">=</span><span class="n">model_path</span><span class="p">)</span>
        <span class="n">input_details</span> <span class="o">=</span> <span class="n">interpreter</span><span class="o">.</span><span class="n">get_input_details</span><span class="p">()</span>
        <span class="n">output_details</span> <span class="o">=</span> <span class="n">interpreter</span><span class="o">.</span><span class="n">get_output_details</span><span class="p">()</span>
        <span class="n">interpreter</span><span class="o">.</span><span class="n">allocate_tensors</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Input details:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">input_details</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Output details:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">output_details</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_details</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Multi-inputs not yet supported&quot;</span>
        <span class="n">input_type</span> <span class="o">=</span> <span class="n">input_details</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;dtype&quot;</span><span class="p">]</span>
        <span class="n">input_name</span> <span class="o">=</span> <span class="n">input_details</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="n">input_shape</span> <span class="o">=</span> <span class="n">input_details</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">input_name</span> <span class="ow">in</span> <span class="n">input_data</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Input </span><span class="si">{</span><span class="n">input_name</span><span class="si">}</span><span class="s2"> fot found in data&quot;</span>
        <span class="n">np_features</span> <span class="o">=</span> <span class="n">input_data</span><span class="p">[</span><span class="n">input_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">quant</span> <span class="ow">and</span> <span class="n">input_type</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">:</span>
            <span class="n">input_scale</span><span class="p">,</span> <span class="n">input_zero_point</span> <span class="o">=</span> <span class="n">input_details</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;quantization&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Input scale:&quot;</span><span class="p">,</span> <span class="n">input_scale</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Input zero point:&quot;</span><span class="p">,</span> <span class="n">input_zero_point</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">()</span>
            <span class="n">np_features</span> <span class="o">=</span> <span class="p">(</span><span class="n">np_features</span> <span class="o">/</span> <span class="n">input_scale</span><span class="p">)</span> <span class="o">+</span> <span class="n">input_zero_point</span>
            <span class="n">np_features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">np_features</span><span class="p">)</span>
        <span class="n">np_features</span> <span class="o">=</span> <span class="n">np_features</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">input_type</span><span class="p">)</span>
        <span class="n">np_features</span> <span class="o">=</span> <span class="n">np_features</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">input_shape</span><span class="p">)</span>
        <span class="n">interpreter</span><span class="o">.</span><span class="n">set_tensor</span><span class="p">(</span><span class="n">input_details</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;index&quot;</span><span class="p">],</span> <span class="n">np_features</span><span class="p">)</span>
        <span class="n">interpreter</span><span class="o">.</span><span class="n">invoke</span><span class="p">()</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">interpreter</span><span class="o">.</span><span class="n">get_tensor</span><span class="p">(</span><span class="n">output_details</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;index&quot;</span><span class="p">])</span>

        <span class="c1"># If the output type is int8 (quantized model), rescale data</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_details</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Multi-outputs not yet supported&quot;</span>
        <span class="n">output_type</span> <span class="o">=</span> <span class="n">output_details</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;dtype&quot;</span><span class="p">]</span>
        <span class="n">output_name</span> <span class="o">=</span> <span class="n">output_details</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">dequant</span> <span class="ow">and</span> <span class="n">output_type</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">:</span>
            <span class="n">output_scale</span><span class="p">,</span> <span class="n">output_zero_point</span> <span class="o">=</span> <span class="n">output_details</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;quantization&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Raw output scores:&quot;</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Output scale:&quot;</span><span class="p">,</span> <span class="n">output_scale</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Output zero point:&quot;</span><span class="p">,</span> <span class="n">output_zero_point</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">()</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">output_scale</span> <span class="o">*</span> <span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">-</span> <span class="n">output_zero_point</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="c1"># Print the results of inference</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Inference output:&quot;</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">output</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">output_name</span><span class="p">:</span> <span class="n">output</span><span class="p">}</span></div>


<div class="viewcode-block" id="TfLiteFrontend.produce_artifacts">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.TfLiteFrontend.produce_artifacts">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">produce_artifacts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_formats</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">paths</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">artifacts</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">name</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">name</span>
        <span class="c1"># assert &quot;/&quot; not in name</span>
        <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_formats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">extension</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">artifacts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Artifact</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="n">raw</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">ArtifactFormat</span><span class="o">.</span><span class="n">RAW</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_enable</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdirname</span><span class="p">:</span>
                <span class="n">out_file</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">tmpdirname</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;tflite_analyze.csv&quot;</span><span class="p">)</span>

                <span class="n">args</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">path</span><span class="p">,</span>
                    <span class="s2">&quot;--csv&quot;</span><span class="p">,</span>
                    <span class="n">out_file</span><span class="p">,</span>
                    <span class="s2">&quot;--ops&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;--estimate-macs&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;--estimate-rom&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;--estimate-ram&quot;</span><span class="p">,</span>
                <span class="p">]</span>

                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_script</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="k">assert</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analyze_script</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">(),</span> <span class="sa">f</span><span class="s2">&quot;Script </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">analyze_script</span><span class="si">}</span><span class="s2"> not found.&quot;</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">python</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analyze_script</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
                    <span class="n">tflite_analyze_csv</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

                <span class="n">tflite_analyze_artifact</span> <span class="o">=</span> <span class="n">Artifact</span><span class="p">(</span>
                    <span class="s2">&quot;tflite_analyze.csv&quot;</span><span class="p">,</span>
                    <span class="n">content</span><span class="o">=</span><span class="n">tflite_analyze_csv</span><span class="p">,</span>
                    <span class="n">fmt</span><span class="o">=</span><span class="n">ArtifactFormat</span><span class="o">.</span><span class="n">TEXT</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">artifacts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tflite_analyze_artifact</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">visualize_enable</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">visualize_script</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

            <span class="n">in_file</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="s2">&quot;html&quot;</span>
            <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdirname</span><span class="p">:</span>
                <span class="n">out_file</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">tmpdirname</span><span class="p">)</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;tflite_visualize.</span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="n">utils</span><span class="o">.</span><span class="n">python</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">visualize_script</span><span class="p">,</span> <span class="n">in_file</span><span class="p">,</span> <span class="n">out_file</span><span class="p">)</span>

                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
                    <span class="n">tflite_visualize_text</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

                <span class="n">tflite_visualize_artifact</span> <span class="o">=</span> <span class="n">Artifact</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;tflite_visualize.</span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">content</span><span class="o">=</span><span class="n">tflite_visualize_text</span><span class="p">,</span>
                    <span class="n">fmt</span><span class="o">=</span><span class="n">ArtifactFormat</span><span class="o">.</span><span class="n">TEXT</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">artifacts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tflite_visualize_artifact</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">visualize_enable</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_enable</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_formats</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">visualize_enable</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_enable</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_formats</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_formats</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">artifacts</span></div>


<div class="viewcode-block" id="TfLiteFrontend.generate">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.TfLiteFrontend.generate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_layers</span><span class="p">:</span>
            <span class="n">artifacts</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="n">name</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">name</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">formats</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">formats</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">supports_formats</span><span class="p">(</span><span class="n">formats</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Invalid model format for &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; frontend&quot;</span>

            <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">produce_artifacts</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="p">[</span><span class="n">ret</span><span class="p">]</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; frontend should produce at least one model&quot;</span>
            <span class="n">max_outs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_formats</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">max_outs</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; frontend should not return more than </span><span class="si">{</span><span class="n">max_outs</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">artifacts</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ret</span>
            <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdirname</span><span class="p">:</span>

                <span class="k">def</span><span class="w"> </span><span class="nf">get_num_layers</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
                    <span class="n">tflite_pack_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;--count-layers&quot;</span><span class="p">,</span> <span class="s2">&quot;--noop&quot;</span><span class="p">]</span>
                    <span class="n">out</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pack_script</span><span class="p">,</span> <span class="o">*</span><span class="n">tflite_pack_args</span><span class="p">)</span>
                    <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Found\s(\d+)\slayers.&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                    <span class="n">num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">return</span> <span class="n">num</span>

                <span class="n">replace</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># replace = True</span>
                <span class="n">drop</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="c1"># drop = True</span>
                <span class="k">def</span><span class="w"> </span><span class="nf">gen_layer_files</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">dest</span><span class="p">):</span>
                    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">num_layers</span> <span class="o">=</span> <span class="n">get_num_layers</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="n">num_layers</span> <span class="o">&gt;</span> <span class="mi">0</span>
                    <span class="n">keep</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">replace</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="n">keep</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">keep</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_layers</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">keep</span> <span class="ow">and</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keep</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">out_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;layer</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">out_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span> <span class="o">/</span> <span class="n">out_name</span>
                        <span class="n">tflite_pack_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;-k&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="s2">&quot;--out&quot;</span><span class="p">,</span> <span class="n">out_file</span><span class="p">]</span>
                        <span class="n">utils</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pack_script</span><span class="p">,</span> <span class="o">*</span><span class="n">tflite_pack_args</span><span class="p">)</span>
                        <span class="k">assert</span> <span class="n">out_file</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span>
                        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_file</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">results</span>

                <span class="n">layer_files</span> <span class="o">=</span> <span class="n">gen_layer_files</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">tmpdirname</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">layer_file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">layer_files</span><span class="p">):</span>
                    <span class="n">subrun</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;layer</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">layer_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">subrun</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">layer_model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">layer_name</span><span class="p">,</span> <span class="p">[</span><span class="n">layer_file</span><span class="p">])</span>
                    <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">produce_artifacts</span><span class="p">(</span><span class="n">layer_model</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">ret</span> <span class="o">=</span> <span class="p">[</span><span class="n">ret</span><span class="p">]</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; frontend should produce at least one model&quot;</span>
                    <span class="n">max_outs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_formats</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">max_outs</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; frontend should not return more than </span><span class="si">{</span><span class="n">max_outs</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">if</span> <span class="n">replace</span><span class="p">:</span>
                        <span class="n">subrun</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>
                    <span class="n">artifacts</span><span class="p">[</span><span class="n">subrun</span><span class="p">]</span> <span class="o">=</span> <span class="n">ret</span>
                <span class="k">if</span> <span class="n">drop</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">artifacts</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">artifacts</span><span class="p">,</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">model</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="RelayFrontend">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.RelayFrontend">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RelayFrontend</span><span class="p">(</span><span class="n">SimpleFrontend</span><span class="p">):</span>
    <span class="n">FEATURES</span> <span class="o">=</span> <span class="n">Frontend</span><span class="o">.</span><span class="n">FEATURES</span> <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;relayviz&quot;</span><span class="p">}</span>

    <span class="n">DEFAULTS</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">Frontend</span><span class="o">.</span><span class="n">DEFAULTS</span><span class="p">,</span> <span class="s2">&quot;visualize_graph&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;relayviz_plotter&quot;</span><span class="p">:</span> <span class="s2">&quot;term&quot;</span><span class="p">}</span>

    <span class="n">REQUIRED</span> <span class="o">=</span> <span class="n">Frontend</span><span class="o">.</span><span class="n">REQUIRED</span> <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;tvm.build_dir&quot;</span><span class="p">,</span> <span class="s2">&quot;tvm.pythonpath&quot;</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="s2">&quot;relay&quot;</span><span class="p">,</span>
            <span class="n">ModelFormats</span><span class="o">.</span><span class="n">RELAY</span><span class="p">,</span>
            <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">visualize_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;visualize_graph&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">relayviz_plotter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;relayviz_plotter&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">tvm_build_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;tvm.build_dir&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">tvm_pythonpath</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;tvm.pythonpath&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="RelayFrontend.produce_artifacts">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.RelayFrontend.produce_artifacts">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">produce_artifacts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_formats</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">paths</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">artifacts</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">name</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">name</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_formats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">extension</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>  <span class="c1"># TODO: is an onnx model raw data or text?</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">artifacts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Artifact</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="n">raw</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">ArtifactFormat</span><span class="o">.</span><span class="n">RAW</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">visualize_graph</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_formats</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_formats</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">_relayviz</span><span class="p">(</span><span class="n">in_file</span><span class="p">,</span> <span class="n">out_file</span><span class="p">,</span> <span class="n">plotter_name</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="p">{}):</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

                <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;PYTHONPATH&quot;</span><span class="p">])</span>
                <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;TVM_LIBRARY_PATH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s2">&quot;TVM_LIBRARY_PATH&quot;</span><span class="p">]</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">tvm</span><span class="w"> </span><span class="kn">import</span> <span class="n">parser</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">tvm.contrib</span><span class="w"> </span><span class="kn">import</span> <span class="n">relay_viz</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">tvm.contrib.relay_viz.terminal</span><span class="w"> </span><span class="kn">import</span> <span class="n">TermPlotter</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">tvm.contrib.relay_viz.dot</span><span class="w"> </span><span class="kn">import</span> <span class="n">DotPlotter</span>

                <span class="k">if</span> <span class="n">plotter_name</span> <span class="o">==</span> <span class="s2">&quot;term&quot;</span><span class="p">:</span>
                    <span class="n">plotter_cls</span> <span class="o">=</span> <span class="n">TermPlotter</span>
                <span class="k">elif</span> <span class="n">plotter_name</span> <span class="o">==</span> <span class="s2">&quot;dot&quot;</span><span class="p">:</span>
                    <span class="n">plotter_cls</span> <span class="o">=</span> <span class="n">DotPlotter</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid plotter name: </span><span class="si">{</span><span class="n">plotter_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">in_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">relay_text</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="n">relay_text</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

                <span class="n">mod</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">fromtext</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

                <span class="n">plotter_inst</span> <span class="o">=</span> <span class="n">plotter_cls</span><span class="p">()</span>
                <span class="n">viz</span> <span class="o">=</span> <span class="n">relay_viz</span><span class="o">.</span><span class="n">RelayVisualizer</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">plotter</span><span class="o">=</span><span class="n">plotter_inst</span><span class="p">)</span>
                <span class="n">out_file_base</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">out_file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">viz</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">out_file_base</span><span class="p">)</span>

            <span class="n">in_file</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">relayviz_plotter</span> <span class="o">==</span> <span class="s2">&quot;term&quot;</span> <span class="k">else</span> <span class="s2">&quot;pdf&quot;</span>
            <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdirname</span><span class="p">:</span>
                <span class="n">out_file</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">tmpdirname</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;relayviz.</span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;relayviz&quot;</span><span class="p">))</span>
                <span class="n">proc</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span>
                    <span class="n">target</span><span class="o">=</span><span class="n">_relayviz</span><span class="p">,</span>
                    <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">in_file</span><span class="p">,</span> <span class="n">out_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">relayviz_plotter</span><span class="p">],</span>
                    <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;env&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;PYTHONPATH&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tvm_pythonpath</span><span class="p">,</span> <span class="s2">&quot;TVM_LIBRARY_PATH&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tvm_build_dir</span><span class="p">}},</span>
                <span class="p">)</span>
                <span class="n">proc</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                <span class="n">proc</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">relayviz_plotter</span> <span class="o">==</span> <span class="s2">&quot;term&quot;</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
                        <span class="n">relayviz_text</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

                    <span class="n">relayviz_artifact</span> <span class="o">=</span> <span class="n">Artifact</span><span class="p">(</span>
                        <span class="s2">&quot;relayviz.txt&quot;</span><span class="p">,</span>
                        <span class="n">content</span><span class="o">=</span><span class="n">relayviz_text</span><span class="p">,</span>
                        <span class="n">fmt</span><span class="o">=</span><span class="n">ArtifactFormat</span><span class="o">.</span><span class="n">TEXT</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
                        <span class="n">relayviz_data</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

                    <span class="n">relayviz_artifact</span> <span class="o">=</span> <span class="n">Artifact</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;relayviz.</span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">raw</span><span class="o">=</span><span class="n">relayviz_data</span><span class="p">,</span>
                        <span class="n">fmt</span><span class="o">=</span><span class="n">ArtifactFormat</span><span class="o">.</span><span class="n">RAW</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="n">artifacts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">relayviz_artifact</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">artifacts</span></div>
</div>



<div class="viewcode-block" id="PackedFrontend">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.PackedFrontend">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">PackedFrontend</span><span class="p">(</span><span class="n">Frontend</span><span class="p">):</span>  <span class="c1"># Inherit from TFLiteFrontend? -&gt; how to do constructor?</span>
    <span class="n">FEATURES</span> <span class="o">=</span> <span class="n">Frontend</span><span class="o">.</span><span class="n">FEATURES</span> <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;packing&quot;</span><span class="p">,</span> <span class="s2">&quot;packed&quot;</span><span class="p">}</span>

    <span class="n">DEFAULTS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="o">**</span><span class="n">Frontend</span><span class="o">.</span><span class="n">DEFAULTS</span><span class="p">,</span>
        <span class="s2">&quot;ignore_existing&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;fake_pack&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># Pretend that every compatible tensor is packable</span>
        <span class="c1"># (best case scenerio, TODO: rename to force_pack?)</span>
        <span class="s2">&quot;use_packed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;check&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># Unimplemented</span>
    <span class="p">}</span>

    <span class="n">REQUIRED</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;packer.exe&quot;</span><span class="p">}</span>  <span class="c1"># TODO move to feature?</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;packed&quot;</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fake_pack</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_existing</span><span class="p">:</span>
            <span class="c1"># assert self.use_packed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_formats</span> <span class="o">=</span> <span class="p">[</span><span class="n">ModelFormats</span><span class="o">.</span><span class="n">TFLITE</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_formats</span> <span class="o">=</span> <span class="p">[</span><span class="n">ModelFormats</span><span class="o">.</span><span class="n">PACKED</span><span class="p">,</span> <span class="n">ModelFormats</span><span class="o">.</span><span class="n">TFLITE</span><span class="p">]</span>

        <span class="c1"># if self.use_packed:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_formats</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">ModelFormats</span><span class="o">.</span><span class="n">PACKED</span><span class="p">,</span>
            <span class="n">ModelFormats</span><span class="o">.</span><span class="n">TFLITE</span><span class="p">,</span>
        <span class="p">]</span>  <span class="c1"># Always copy over the input model as intermediate artifact for reproducability</span>
        <span class="c1"># TODO: add a Frontend.DEFAULT which can be used to turn off this behavoir (keep intermediate?)</span>
        <span class="c1"># else:</span>
        <span class="c1">#     self.output_formats = [ModelFormats.TFLITE]</span>
        <span class="c1"># Order of formats ir irrelevant here, hot for artifacts, the first one will always be the main object</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ignore_existing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;ignore_existing&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fake_pack</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;fake_pack&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">use_packed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;use_packed&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;check&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<div class="viewcode-block" id="PackedFrontend.produce_artifacts">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.PackedFrontend.produce_artifacts">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">produce_artifacts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="n">tflite_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">packed_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">name</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fake_pack</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_existing</span><span class="p">:</span>  <span class="c1"># -&gt; ins: TFLITE</span>
            <span class="c1"># assert self.use_packed</span>
            <span class="n">tflite_path</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tflite_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
                <span class="n">tflite_data</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># -&gt; ins: TFLITE, PACKED</span>
            <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">fmt</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">paths</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">formats</span><span class="p">):</span>
                <span class="n">data_in</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
                    <span class="n">data_in</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="n">ModelFormats</span><span class="o">.</span><span class="n">PACKED</span><span class="p">:</span>
                    <span class="n">packed_data</span> <span class="o">=</span> <span class="n">data_in</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="n">fmt</span> <span class="o">==</span> <span class="n">ModelFormats</span><span class="o">.</span><span class="n">TFLITE</span><span class="p">:</span>
                    <span class="c1"># tflite_data_in = data_in</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected model format: </span><span class="si">{</span><span class="n">fmt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">packed_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Do packing</span>
            <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdirname</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using temporary directory for packing results: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">tmpdirname</span><span class="p">)</span>
                <span class="n">packer_exe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;packer_exe&quot;</span><span class="p">]</span>
                <span class="k">assert</span> <span class="n">packer_exe</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="n">in_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tmpdirname</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;in.tflite&quot;</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">in_file</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
                    <span class="n">handle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">tflite_data</span><span class="p">)</span>
                <span class="n">out_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tmpdirname</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;out.tflm&quot;</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">packer_exe</span><span class="p">,</span> <span class="n">in_file</span><span class="p">,</span> <span class="n">out_file</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
                    <span class="n">packed_data</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>

        <span class="n">tflite_artifact</span> <span class="o">=</span> <span class="n">Artifact</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.tflite&quot;</span><span class="p">,</span>
            <span class="n">raw</span><span class="o">=</span><span class="n">tflite_data</span><span class="p">,</span>
            <span class="n">fmt</span><span class="o">=</span><span class="n">ArtifactFormat</span><span class="o">.</span><span class="n">RAW</span><span class="p">,</span>
            <span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">],</span>
            <span class="n">optional</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_packed</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">packed_artifact</span> <span class="o">=</span> <span class="n">Artifact</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.tflm&quot;</span><span class="p">,</span>
            <span class="n">raw</span><span class="o">=</span><span class="n">packed_data</span><span class="p">,</span>
            <span class="n">fmt</span><span class="o">=</span><span class="n">ArtifactFormat</span><span class="o">.</span><span class="n">RAW</span><span class="p">,</span>
            <span class="n">optional</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_packed</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_packed</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">packed_artifact</span><span class="p">,</span> <span class="n">tflite_artifact</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">tflite_artifact</span><span class="p">,</span> <span class="n">packed_artifact</span><span class="p">]</span></div>
</div>



<div class="viewcode-block" id="ONNXFrontend">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.ONNXFrontend">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ONNXFrontend</span><span class="p">(</span><span class="n">SimpleFrontend</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="s2">&quot;onnx&quot;</span><span class="p">,</span>
            <span class="n">ModelFormats</span><span class="o">.</span><span class="n">ONNX</span><span class="p">,</span>
            <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="PBFrontend">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.PBFrontend">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">PBFrontend</span><span class="p">(</span><span class="n">SimpleFrontend</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="s2">&quot;pb&quot;</span><span class="p">,</span>
            <span class="n">ModelFormats</span><span class="o">.</span><span class="n">PB</span><span class="p">,</span>
            <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="PaddleFrontend">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.PaddleFrontend">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">PaddleFrontend</span><span class="p">(</span><span class="n">SimpleFrontend</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="s2">&quot;paddle&quot;</span><span class="p">,</span>
            <span class="n">ModelFormats</span><span class="o">.</span><span class="n">PADDLE</span><span class="p">,</span>
            <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="ExampleFrontend">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.ExampleFrontend">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ExampleFrontend</span><span class="p">(</span><span class="n">SimpleFrontend</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="s2">&quot;example&quot;</span><span class="p">,</span>
            <span class="n">ModelFormats</span><span class="o">.</span><span class="n">NONE</span><span class="p">,</span>
            <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">supported_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;hello_world&quot;</span><span class="p">,</span> <span class="s2">&quot;foobar&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="ExampleFrontend.lookup_models">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.ExampleFrontend.lookup_models">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">lookup_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;example/&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">supported_names</span><span class="p">:</span>
                <span class="n">hint</span> <span class="o">=</span> <span class="n">ExampleProgram</span><span class="p">(</span>
                    <span class="n">name</span><span class="p">,</span>
                    <span class="n">alt</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;example/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hint</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="ExampleFrontend.generate">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.ExampleFrontend.generate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
        <span class="n">artifacts</span> <span class="o">=</span> <span class="p">[</span><span class="n">Artifact</span><span class="p">(</span><span class="s2">&quot;dummy_model&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="nb">bytes</span><span class="p">(),</span> <span class="n">fmt</span><span class="o">=</span><span class="n">ArtifactFormat</span><span class="o">.</span><span class="n">RAW</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="s2">&quot;dummy&quot;</span><span class="p">])]</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="n">artifacts</span><span class="p">},</span> <span class="p">{}</span></div>


<div class="viewcode-block" id="ExampleFrontend.get_platform_config">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.ExampleFrontend.get_platform_config">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_platform_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">platform</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;mlif&quot;</span><span class="p">:</span>
            <span class="n">ret</span><span class="p">[</span><span class="s2">&quot;template&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;example&quot;</span>
        <span class="k">return</span> <span class="n">ret</span></div>
</div>



<div class="viewcode-block" id="EmbenchFrontend">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.EmbenchFrontend">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">EmbenchFrontend</span><span class="p">(</span><span class="n">SimpleFrontend</span><span class="p">):</span>
    <span class="n">REQUIRED</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;embench.src_dir&quot;</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="s2">&quot;embench&quot;</span><span class="p">,</span>
            <span class="n">ModelFormats</span><span class="o">.</span><span class="n">NONE</span><span class="p">,</span>
            <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">supported_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: automatic lookup</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="s2">&quot;edn&quot;</span><span class="p">,</span>
            <span class="s2">&quot;md5sum&quot;</span><span class="p">,</span>
            <span class="s2">&quot;nettle-sha256&quot;</span><span class="p">,</span>
            <span class="s2">&quot;nettle-aes&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;matmult-int&quot;</span><span class="p">,</span>
            <span class="s2">&quot;aha-mont64&quot;</span><span class="p">,</span>
            <span class="s2">&quot;huffbench&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cubic&quot;</span><span class="p">,</span>
            <span class="s2">&quot;nbody&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sglib-combined&quot;</span><span class="p">,</span>
            <span class="s2">&quot;crc32&quot;</span><span class="p">,</span>
            <span class="s2">&quot;wikisort&quot;</span><span class="p">,</span>
            <span class="s2">&quot;slre&quot;</span><span class="p">,</span>
            <span class="s2">&quot;qrduino&quot;</span><span class="p">,</span>
            <span class="s2">&quot;minver&quot;</span><span class="p">,</span>
            <span class="s2">&quot;picojpeg&quot;</span><span class="p">,</span>
            <span class="s2">&quot;tarfind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;st&quot;</span><span class="p">,</span>
            <span class="s2">&quot;nsichneu&quot;</span><span class="p">,</span>
            <span class="s2">&quot;statemate&quot;</span><span class="p">,</span>
            <span class="s2">&quot;primecount&quot;</span><span class="p">,</span>
        <span class="p">]</span>

    <span class="c1"># @property</span>
    <span class="c1"># def skip_backend(self):</span>
    <span class="c1">#     return True</span>

<div class="viewcode-block" id="EmbenchFrontend.lookup_models">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.EmbenchFrontend.lookup_models">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">lookup_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;embench/&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">supported_names</span><span class="p">:</span>
                <span class="n">hint</span> <span class="o">=</span> <span class="n">EmbenchProgram</span><span class="p">(</span>
                    <span class="n">name</span><span class="p">,</span>
                    <span class="n">alt</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;embench/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hint</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="EmbenchFrontend.generate">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.EmbenchFrontend.generate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
        <span class="n">artifacts</span> <span class="o">=</span> <span class="p">[</span><span class="n">Artifact</span><span class="p">(</span><span class="s2">&quot;dummy_model&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="nb">bytes</span><span class="p">(),</span> <span class="n">fmt</span><span class="o">=</span><span class="n">ArtifactFormat</span><span class="o">.</span><span class="n">RAW</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="s2">&quot;dummy&quot;</span><span class="p">])]</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="n">artifacts</span><span class="p">},</span> <span class="p">{}</span></div>


<div class="viewcode-block" id="EmbenchFrontend.get_platform_defs">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.EmbenchFrontend.get_platform_defs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_platform_defs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">platform</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;mlif&quot;</span><span class="p">:</span>
            <span class="n">ret</span><span class="p">[</span><span class="s2">&quot;EMBENCH_DIR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;embench.src_dir&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="EmbenchFrontend.get_platform_config">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.EmbenchFrontend.get_platform_config">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_platform_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">platform</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;mlif&quot;</span><span class="p">:</span>
            <span class="n">ret</span><span class="p">[</span><span class="s2">&quot;template&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;embench&quot;</span>
        <span class="k">return</span> <span class="n">ret</span></div>
</div>



<div class="viewcode-block" id="TaclebenchFrontend">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.TaclebenchFrontend">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TaclebenchFrontend</span><span class="p">(</span><span class="n">SimpleFrontend</span><span class="p">):</span>
    <span class="n">REQUIRED</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;taclebench.src_dir&quot;</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="s2">&quot;taclebench&quot;</span><span class="p">,</span>
            <span class="n">ModelFormats</span><span class="o">.</span><span class="n">NONE</span><span class="p">,</span>
            <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">supported_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: automatic lookup</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="s2">&quot;test/test3&quot;</span><span class="p">,</span>
            <span class="s2">&quot;test/cover&quot;</span><span class="p">,</span>
            <span class="s2">&quot;test/duff&quot;</span><span class="p">,</span>
            <span class="s2">&quot;app/powerwindow&quot;</span><span class="p">,</span>
            <span class="s2">&quot;app/lift&quot;</span><span class="p">,</span>
            <span class="s2">&quot;kernel/deg2rad&quot;</span><span class="p">,</span>
            <span class="s2">&quot;kernel/matrix1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;kernel/binarysearch&quot;</span><span class="p">,</span>
            <span class="s2">&quot;kernel/pm&quot;</span><span class="p">,</span>
            <span class="s2">&quot;kernel/sha&quot;</span><span class="p">,</span>
            <span class="s2">&quot;kernel/filterbank&quot;</span><span class="p">,</span>
            <span class="s2">&quot;kernel/md5&quot;</span><span class="p">,</span>
            <span class="s2">&quot;kernel/fir2dim&quot;</span><span class="p">,</span>
            <span class="s2">&quot;kernel/fft&quot;</span><span class="p">,</span>
            <span class="s2">&quot;kernel/minver&quot;</span><span class="p">,</span>
            <span class="s2">&quot;kernel/lms&quot;</span><span class="p">,</span>
            <span class="s2">&quot;kernel/bitcount&quot;</span><span class="p">,</span>
            <span class="s2">&quot;kernel/st&quot;</span><span class="p">,</span>
            <span class="s2">&quot;kernel/bsort&quot;</span><span class="p">,</span>
            <span class="s2">&quot;kernel/bitonic&quot;</span><span class="p">,</span>
            <span class="s2">&quot;kernel/iir&quot;</span><span class="p">,</span>
            <span class="s2">&quot;kernel/prime&quot;</span><span class="p">,</span>
            <span class="s2">&quot;kernel/jfdctint&quot;</span><span class="p">,</span>
            <span class="s2">&quot;kernel/recursion&quot;</span><span class="p">,</span>
            <span class="s2">&quot;kernel/complex_updates&quot;</span><span class="p">,</span>
            <span class="s2">&quot;kernel/cosf&quot;</span><span class="p">,</span>
            <span class="s2">&quot;kernel/insertsort&quot;</span><span class="p">,</span>
            <span class="s2">&quot;kernel/fac&quot;</span><span class="p">,</span>
            <span class="s2">&quot;kernel/rad2deg&quot;</span><span class="p">,</span>
            <span class="s2">&quot;kernel/isqrt&quot;</span><span class="p">,</span>
            <span class="s2">&quot;kernel/cubic&quot;</span><span class="p">,</span>
            <span class="s2">&quot;kernel/ludcmp&quot;</span><span class="p">,</span>
            <span class="s2">&quot;kernel/quicksort&quot;</span><span class="p">,</span>
            <span class="s2">&quot;kernel/countnegative&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sequential/epic&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sequential/huff_dec&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sequential/fmref&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sequential/h264_dec&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sequential/dijkstra&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sequential/adpcm_dec&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sequential/adpcm_enc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sequential/gsm_dec&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sequential/rijndael_dec&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sequential/g723_enc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sequential/huff_enc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sequential/statemate&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sequential/susan&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sequential/gsm_enc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sequential/ndes&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sequential/audiobeam&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sequential/rijndael_enc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sequential/cjpeg_transupp&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sequential/ammunition&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sequential/mpeg2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sequential/anagram&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sequential/cjpeg_wrbmp&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sequential/petrinet&quot;</span><span class="p">,</span>
        <span class="p">]</span>

    <span class="c1"># @property</span>
    <span class="c1"># def skip_backend(self):</span>
    <span class="c1">#     return True</span>

<div class="viewcode-block" id="TaclebenchFrontend.lookup_models">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.TaclebenchFrontend.lookup_models">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">lookup_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;taclebench/&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">supported_names</span><span class="p">:</span>
                <span class="n">hint</span> <span class="o">=</span> <span class="n">TaclebenchProgram</span><span class="p">(</span>
                    <span class="n">name</span><span class="p">,</span>
                    <span class="n">alt</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;taclebench/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hint</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="TaclebenchFrontend.generate">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.TaclebenchFrontend.generate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
        <span class="n">artifacts</span> <span class="o">=</span> <span class="p">[</span><span class="n">Artifact</span><span class="p">(</span><span class="s2">&quot;dummy_model&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="nb">bytes</span><span class="p">(),</span> <span class="n">fmt</span><span class="o">=</span><span class="n">ArtifactFormat</span><span class="o">.</span><span class="n">RAW</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="s2">&quot;dummy&quot;</span><span class="p">])]</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="n">artifacts</span><span class="p">},</span> <span class="p">{}</span></div>


<div class="viewcode-block" id="TaclebenchFrontend.get_platform_defs">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.TaclebenchFrontend.get_platform_defs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_platform_defs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">platform</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;mlif&quot;</span><span class="p">:</span>
            <span class="n">ret</span><span class="p">[</span><span class="s2">&quot;TACLEBENCH_DIR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;taclebench.src_dir&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="TaclebenchFrontend.get_platform_config">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.TaclebenchFrontend.get_platform_config">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_platform_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">platform</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;mlif&quot;</span><span class="p">:</span>
            <span class="n">ret</span><span class="p">[</span><span class="s2">&quot;template&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;taclebench&quot;</span>
        <span class="k">return</span> <span class="n">ret</span></div>
</div>



<div class="viewcode-block" id="PolybenchFrontend">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.PolybenchFrontend">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">PolybenchFrontend</span><span class="p">(</span><span class="n">SimpleFrontend</span><span class="p">):</span>

    <span class="n">DEFAULTS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="o">**</span><span class="n">Frontend</span><span class="o">.</span><span class="n">DEFAULTS</span><span class="p">,</span>
        <span class="s2">&quot;dataset&quot;</span><span class="p">:</span> <span class="s2">&quot;large&quot;</span><span class="p">,</span>  <span class="c1"># mini/small/medium/large/extralarge</span>
    <span class="p">}</span>

    <span class="n">REQUIRED</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;polybench.src_dir&quot;</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="s2">&quot;polybench&quot;</span><span class="p">,</span>
            <span class="n">ModelFormats</span><span class="o">.</span><span class="n">NONE</span><span class="p">,</span>
            <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">supported_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: automatic lookup</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="s2">&quot;linear-algebra/solvers/gramschmidt&quot;</span><span class="p">,</span>
            <span class="s2">&quot;linear-algebra/solvers/ludcmp&quot;</span><span class="p">,</span>
            <span class="s2">&quot;linear-algebra/solvers/trisolv&quot;</span><span class="p">,</span>
            <span class="s2">&quot;linear-algebra/solvers/durbin&quot;</span><span class="p">,</span>
            <span class="s2">&quot;linear-algebra/solvers/lu&quot;</span><span class="p">,</span>
            <span class="s2">&quot;linear-algebra/solvers/cholesky&quot;</span><span class="p">,</span>
            <span class="s2">&quot;linear-algebra/kernels/atax&quot;</span><span class="p">,</span>
            <span class="s2">&quot;linear-algebra/kernels/3mm&quot;</span><span class="p">,</span>
            <span class="s2">&quot;linear-algebra/kernels/mvt&quot;</span><span class="p">,</span>
            <span class="s2">&quot;linear-algebra/kernels/2mm&quot;</span><span class="p">,</span>
            <span class="s2">&quot;linear-algebra/kernels/bicg&quot;</span><span class="p">,</span>
            <span class="s2">&quot;linear-algebra/kernels/doitgen&quot;</span><span class="p">,</span>
            <span class="s2">&quot;linear-algebra/blas/trmm&quot;</span><span class="p">,</span>
            <span class="s2">&quot;linear-algebra/blas/gemver&quot;</span><span class="p">,</span>
            <span class="s2">&quot;linear-algebra/blas/syrk&quot;</span><span class="p">,</span>
            <span class="s2">&quot;linear-algebra/blas/gesummv&quot;</span><span class="p">,</span>
            <span class="s2">&quot;linear-algebra/blas/syr2k&quot;</span><span class="p">,</span>
            <span class="s2">&quot;linear-algebra/blas/symm&quot;</span><span class="p">,</span>
            <span class="s2">&quot;linear-algebra/blas/gemm&quot;</span><span class="p">,</span>
            <span class="s2">&quot;stencils/fdtd-2d&quot;</span><span class="p">,</span>
            <span class="s2">&quot;stencils/seidel-2d&quot;</span><span class="p">,</span>
            <span class="s2">&quot;stencils/adi&quot;</span><span class="p">,</span>
            <span class="s2">&quot;stencils/jacobi-1d&quot;</span><span class="p">,</span>
            <span class="s2">&quot;stencils/jacobi-2d&quot;</span><span class="p">,</span>
            <span class="s2">&quot;stencils/heat-3d&quot;</span><span class="p">,</span>
            <span class="s2">&quot;datamining/covariance&quot;</span><span class="p">,</span>
            <span class="s2">&quot;datamining/correlation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;medley/deriche&quot;</span><span class="p">,</span>
            <span class="s2">&quot;medley/nussinov&quot;</span><span class="p">,</span>
            <span class="s2">&quot;medley/floyd-warshall&quot;</span><span class="p">,</span>
        <span class="p">]</span>

    <span class="c1"># @property</span>
    <span class="c1"># def skip_backend(self):</span>
    <span class="c1">#     return True</span>

<div class="viewcode-block" id="PolybenchFrontend.lookup_models">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.PolybenchFrontend.lookup_models">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">lookup_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;polybench/&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">supported_names</span><span class="p">:</span>
                <span class="n">hint</span> <span class="o">=</span> <span class="n">PolybenchProgram</span><span class="p">(</span>
                    <span class="n">name</span><span class="p">,</span>
                    <span class="n">alt</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;polybench/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hint</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="PolybenchFrontend.generate">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.PolybenchFrontend.generate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
        <span class="n">artifacts</span> <span class="o">=</span> <span class="p">[</span><span class="n">Artifact</span><span class="p">(</span><span class="s2">&quot;dummy_model&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="nb">bytes</span><span class="p">(),</span> <span class="n">fmt</span><span class="o">=</span><span class="n">ArtifactFormat</span><span class="o">.</span><span class="n">RAW</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="s2">&quot;dummy&quot;</span><span class="p">])]</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="n">artifacts</span><span class="p">},</span> <span class="p">{}</span></div>


<div class="viewcode-block" id="PolybenchFrontend.get_platform_defs">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.PolybenchFrontend.get_platform_defs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_platform_defs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">platform</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;mlif&quot;</span><span class="p">:</span>
            <span class="n">ret</span><span class="p">[</span><span class="s2">&quot;POLYBENCH_DIR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;polybench.src_dir&quot;</span><span class="p">])</span>
            <span class="n">ret</span><span class="p">[</span><span class="s2">&quot;POLYBENCH_DATASET&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;dataset&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;_DATASET&quot;</span>
        <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="PolybenchFrontend.get_platform_config">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.PolybenchFrontend.get_platform_config">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_platform_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">platform</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;mlif&quot;</span><span class="p">:</span>
            <span class="n">ret</span><span class="p">[</span><span class="s2">&quot;template&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;polybench&quot;</span>
        <span class="k">return</span> <span class="n">ret</span></div>
</div>



<div class="viewcode-block" id="CoremarkFrontend">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.CoremarkFrontend">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CoremarkFrontend</span><span class="p">(</span><span class="n">SimpleFrontend</span><span class="p">):</span>
    <span class="n">REQUIRED</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="s2">&quot;coremark&quot;</span><span class="p">,</span>
            <span class="n">ModelFormats</span><span class="o">.</span><span class="n">NONE</span><span class="p">,</span>
            <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">supported_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="s2">&quot;coremark&quot;</span><span class="p">,</span>
        <span class="p">]</span>

<div class="viewcode-block" id="CoremarkFrontend.lookup_models">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.CoremarkFrontend.lookup_models">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">lookup_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;coremark/&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">supported_names</span><span class="p">:</span>
                <span class="n">hint</span> <span class="o">=</span> <span class="n">CoremarkProgram</span><span class="p">(</span>
                    <span class="n">name</span><span class="p">,</span>
                    <span class="n">alt</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;coremark/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hint</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="CoremarkFrontend.generate">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.CoremarkFrontend.generate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
        <span class="n">artifacts</span> <span class="o">=</span> <span class="p">[</span><span class="n">Artifact</span><span class="p">(</span><span class="s2">&quot;dummy_model&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="nb">bytes</span><span class="p">(),</span> <span class="n">fmt</span><span class="o">=</span><span class="n">ArtifactFormat</span><span class="o">.</span><span class="n">RAW</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="s2">&quot;dummy&quot;</span><span class="p">])]</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="n">artifacts</span><span class="p">},</span> <span class="p">{}</span></div>


<div class="viewcode-block" id="CoremarkFrontend.get_platform_config">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.CoremarkFrontend.get_platform_config">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_platform_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">platform</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;mlif&quot;</span><span class="p">:</span>
            <span class="n">ret</span><span class="p">[</span><span class="s2">&quot;template&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;coremark&quot;</span>
        <span class="k">return</span> <span class="n">ret</span></div>
</div>



<div class="viewcode-block" id="DhrystoneFrontend">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.DhrystoneFrontend">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DhrystoneFrontend</span><span class="p">(</span><span class="n">SimpleFrontend</span><span class="p">):</span>
    <span class="n">REQUIRED</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="s2">&quot;dhrystone&quot;</span><span class="p">,</span>
            <span class="n">ModelFormats</span><span class="o">.</span><span class="n">NONE</span><span class="p">,</span>
            <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">supported_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="s2">&quot;dhrystone&quot;</span><span class="p">,</span>
        <span class="p">]</span>

<div class="viewcode-block" id="DhrystoneFrontend.lookup_models">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.DhrystoneFrontend.lookup_models">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">lookup_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;dhrystone/&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">supported_names</span><span class="p">:</span>
                <span class="n">hint</span> <span class="o">=</span> <span class="n">DhrystoneProgram</span><span class="p">(</span>
                    <span class="n">name</span><span class="p">,</span>
                    <span class="n">alt</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;dhrystone/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hint</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="DhrystoneFrontend.generate">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.DhrystoneFrontend.generate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
        <span class="n">artifacts</span> <span class="o">=</span> <span class="p">[</span><span class="n">Artifact</span><span class="p">(</span><span class="s2">&quot;dummy_model&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="nb">bytes</span><span class="p">(),</span> <span class="n">fmt</span><span class="o">=</span><span class="n">ArtifactFormat</span><span class="o">.</span><span class="n">RAW</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="s2">&quot;dummy&quot;</span><span class="p">])]</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="n">artifacts</span><span class="p">},</span> <span class="p">{}</span></div>


<div class="viewcode-block" id="DhrystoneFrontend.get_platform_config">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.DhrystoneFrontend.get_platform_config">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_platform_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">platform</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;mlif&quot;</span><span class="p">:</span>
            <span class="n">ret</span><span class="p">[</span><span class="s2">&quot;template&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;dhrystone&quot;</span>
        <span class="k">return</span> <span class="n">ret</span></div>
</div>



<div class="viewcode-block" id="MathisFrontend">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.MathisFrontend">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">MathisFrontend</span><span class="p">(</span><span class="n">SimpleFrontend</span><span class="p">):</span>
    <span class="n">REQUIRED</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="s2">&quot;mathis&quot;</span><span class="p">,</span>
            <span class="n">ModelFormats</span><span class="o">.</span><span class="n">NONE</span><span class="p">,</span>
            <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">supported_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="s2">&quot;to_upper&quot;</span><span class="p">,</span>
            <span class="s2">&quot;add8&quot;</span><span class="p">,</span>
            <span class="s2">&quot;add16&quot;</span><span class="p">,</span>
            <span class="s2">&quot;gather_add8&quot;</span><span class="p">,</span>
            <span class="s2">&quot;gather_add16&quot;</span><span class="p">,</span>
            <span class="s2">&quot;scatter_add8&quot;</span><span class="p">,</span>
            <span class="s2">&quot;scatter_add16&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dot8&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dot16&quot;</span><span class="p">,</span>
            <span class="s2">&quot;saxpy8&quot;</span><span class="p">,</span>
            <span class="s2">&quot;saxpy16&quot;</span><span class="p">,</span>
            <span class="s2">&quot;matmul8&quot;</span><span class="p">,</span>
            <span class="s2">&quot;matmul16&quot;</span><span class="p">,</span>
            <span class="s2">&quot;matmul8_a&quot;</span><span class="p">,</span>
            <span class="s2">&quot;matmul16_a&quot;</span><span class="p">,</span>
            <span class="s2">&quot;transposed_matmul8&quot;</span><span class="p">,</span>
            <span class="s2">&quot;transposed_matmul16&quot;</span><span class="p">,</span>
            <span class="s2">&quot;transposed_matmul8_a&quot;</span><span class="p">,</span>
            <span class="s2">&quot;transposed_matmul16_a&quot;</span><span class="p">,</span>
            <span class="s2">&quot;transposed_matmul8_b&quot;</span><span class="p">,</span>
            <span class="s2">&quot;transposed_matmul16_b&quot;</span><span class="p">,</span>
        <span class="p">]</span>

<div class="viewcode-block" id="MathisFrontend.lookup_models">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.MathisFrontend.lookup_models">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">lookup_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;mathis/&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">supported_names</span><span class="p">:</span>
                <span class="n">hint</span> <span class="o">=</span> <span class="n">MathisProgram</span><span class="p">(</span>
                    <span class="n">name</span><span class="p">,</span>
                    <span class="n">alt</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;mathis/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hint</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="MathisFrontend.generate">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.MathisFrontend.generate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
        <span class="n">artifacts</span> <span class="o">=</span> <span class="p">[</span><span class="n">Artifact</span><span class="p">(</span><span class="s2">&quot;dummy_model&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="nb">bytes</span><span class="p">(),</span> <span class="n">fmt</span><span class="o">=</span><span class="n">ArtifactFormat</span><span class="o">.</span><span class="n">RAW</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="s2">&quot;dummy&quot;</span><span class="p">])]</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="n">artifacts</span><span class="p">},</span> <span class="p">{}</span></div>


<div class="viewcode-block" id="MathisFrontend.get_platform_config">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.MathisFrontend.get_platform_config">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_platform_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">platform</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;mlif&quot;</span><span class="p">:</span>
            <span class="n">ret</span><span class="p">[</span><span class="s2">&quot;template&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;mathis&quot;</span>
        <span class="k">return</span> <span class="n">ret</span></div>
</div>



<div class="viewcode-block" id="MibenchFrontend">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.MibenchFrontend">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">MibenchFrontend</span><span class="p">(</span><span class="n">SimpleFrontend</span><span class="p">):</span>
    <span class="n">REQUIRED</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;mibench.src_dir&quot;</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="s2">&quot;mibench&quot;</span><span class="p">,</span>
            <span class="n">ModelFormats</span><span class="o">.</span><span class="n">NONE</span><span class="p">,</span>
            <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">supported_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: automatic lookup</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="s2">&quot;telecomm/FFT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;telecomm/CRC32&quot;</span><span class="p">,</span>
            <span class="s2">&quot;automotive/susan&quot;</span><span class="p">,</span>
            <span class="s2">&quot;automotive/basicmath&quot;</span><span class="p">,</span>
            <span class="s2">&quot;automotive/bitcount&quot;</span><span class="p">,</span>
            <span class="s2">&quot;automotive/qsort&quot;</span><span class="p">,</span>
            <span class="s2">&quot;security/sha&quot;</span><span class="p">,</span>
            <span class="s2">&quot;security/rijndael&quot;</span><span class="p">,</span>
            <span class="s2">&quot;network/dijkstra&quot;</span><span class="p">,</span>
            <span class="s2">&quot;office/stringsearch&quot;</span><span class="p">,</span>
        <span class="p">]</span>

    <span class="c1"># @property</span>
    <span class="c1"># def skip_backend(self):</span>
    <span class="c1">#     return True</span>

<div class="viewcode-block" id="MibenchFrontend.lookup_models">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.MibenchFrontend.lookup_models">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">lookup_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;mibench/&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">supported_names</span><span class="p">:</span>
                <span class="n">hint</span> <span class="o">=</span> <span class="n">MibenchProgram</span><span class="p">(</span>
                    <span class="n">name</span><span class="p">,</span>
                    <span class="n">alt</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;mibench/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hint</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="MibenchFrontend.generate">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.MibenchFrontend.generate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
        <span class="n">artifacts</span> <span class="o">=</span> <span class="p">[</span><span class="n">Artifact</span><span class="p">(</span><span class="s2">&quot;dummy_model&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="nb">bytes</span><span class="p">(),</span> <span class="n">fmt</span><span class="o">=</span><span class="n">ArtifactFormat</span><span class="o">.</span><span class="n">RAW</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="s2">&quot;dummy&quot;</span><span class="p">])]</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="n">artifacts</span><span class="p">},</span> <span class="p">{}</span></div>


<div class="viewcode-block" id="MibenchFrontend.get_platform_defs">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.MibenchFrontend.get_platform_defs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_platform_defs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">platform</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;mlif&quot;</span><span class="p">:</span>
            <span class="n">ret</span><span class="p">[</span><span class="s2">&quot;MIBENCH_DIR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;mibench.src_dir&quot;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="MibenchFrontend.get_platform_config">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.MibenchFrontend.get_platform_config">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_platform_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">platform</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;mlif&quot;</span><span class="p">:</span>
            <span class="n">ret</span><span class="p">[</span><span class="s2">&quot;template&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;mibench&quot;</span>

        <span class="k">return</span> <span class="n">ret</span></div>
</div>



<div class="viewcode-block" id="LayerGenFrontend">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.LayerGenFrontend">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">LayerGenFrontend</span><span class="p">(</span><span class="n">Frontend</span><span class="p">):</span>
    <span class="n">FEATURES</span> <span class="o">=</span> <span class="n">Frontend</span><span class="o">.</span><span class="n">FEATURES</span>

    <span class="n">DEFAULTS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="o">**</span><span class="n">Frontend</span><span class="o">.</span><span class="n">DEFAULTS</span><span class="p">,</span>
        <span class="s2">&quot;fmt&quot;</span><span class="p">:</span> <span class="s2">&quot;tflite&quot;</span><span class="p">,</span>  <span class="c1"># TODO: relay</span>
    <span class="p">}</span>

    <span class="n">REQUIRED</span> <span class="o">=</span> <span class="n">Frontend</span><span class="o">.</span><span class="n">REQUIRED</span> <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;layergen.exe&quot;</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="s2">&quot;layergen&quot;</span><span class="p">,</span>
            <span class="n">input_formats</span><span class="o">=</span><span class="p">[</span><span class="n">ModelFormats</span><span class="o">.</span><span class="n">TEXT</span><span class="p">],</span>
            <span class="n">output_formats</span><span class="o">=</span><span class="p">[</span><span class="n">ModelFormats</span><span class="o">.</span><span class="n">TFLITE</span><span class="p">,</span> <span class="n">ModelFormats</span><span class="o">.</span><span class="n">RELAY</span><span class="p">],</span>
            <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fmt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;fmt&quot;</span><span class="p">]</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;TFLITE&quot;</span><span class="p">,</span> <span class="s2">&quot;RELAY&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">layergen_exe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;layergen.exe&quot;</span><span class="p">])</span>

<div class="viewcode-block" id="LayerGenFrontend.produce_artifacts">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.LayerGenFrontend.produce_artifacts">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">produce_artifacts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="k">pass</span></div>


    <span class="c1"># def produce_artifacts(self, model):</span>
    <span class="c1">#     artifacts = {}</span>
    <span class="c1">#     name = model.name</span>
    <span class="c1">#     path = model.paths[0]</span>
    <span class="c1">#     ext = ModelFormats[self.fmt].extension</span>
    <span class="c1">#     print(&quot;ext&quot;, ext)</span>
    <span class="c1">#     with open(path, &quot;r&quot;) as handle:</span>
    <span class="c1">#         content = handle.read()</span>
    <span class="c1">#     lines = content.strip().split(&quot;\n&quot;)</span>
    <span class="c1">#     print(&quot;lines&quot;, lines, list(filter(None, lines)))</span>
    <span class="c1">#     assert len(lines) &gt; 0, &quot;Empty file not allowed.&quot;</span>

    <span class="c1">#     def helper(args):</span>
    <span class="c1">#         args = args.split(&quot; &quot;)</span>
    <span class="c1">#         with tempfile.TemporaryDirectory() as tmpdirname:</span>
    <span class="c1">#             out = Path(tmpdirname) / f&quot;out.{ext}&quot;</span>
    <span class="c1">#             utils.python(self.layergen_exe, self.fmt.lower(), out, *args, cwd=tmpdirname)</span>
    <span class="c1">#             # TODO: log output</span>
    <span class="c1">#             with open(out, &quot;rb&quot;) as handle:</span>
    <span class="c1">#                 raw = handle.read()</span>
    <span class="c1">#             return raw</span>

    <span class="c1">#     if len(lines) &gt; 1:</span>
    <span class="c1">#         for i, args in enumerate(lines):</span>
    <span class="c1">#             name = f&quot;model{i}&quot;</span>
    <span class="c1">#             raw = helper(args)</span>
    <span class="c1">#             artifact = Artifact(f&quot;{name}.{ext}&quot;, raw=raw, fmt=ArtifactFormat.RAW, flags=[&quot;model&quot;])</span>
    <span class="c1">#         artifacts[name] = [artifact]</span>
    <span class="c1">#     else:</span>
    <span class="c1">#         artifacts[&quot;default&quot;] = []</span>
    <span class="c1">#     return artifacts</span>

<div class="viewcode-block" id="LayerGenFrontend.generate">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.LayerGenFrontend.generate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
        <span class="n">artifacts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">name</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="n">ModelFormats</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fmt</span><span class="p">]</span><span class="o">.</span><span class="n">extension</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Empty file not allowed.&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">helper</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdirname</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tmpdirname</span><span class="p">)</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;out.</span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">python</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layergen_exe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmt</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">out</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">tmpdirname</span><span class="p">)</span>
                <span class="c1"># TODO: log output</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
                    <span class="n">raw</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">raw</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">args</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;model</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">raw</span> <span class="o">=</span> <span class="n">helper</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                <span class="n">artifact</span> <span class="o">=</span> <span class="n">Artifact</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="n">raw</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">ArtifactFormat</span><span class="o">.</span><span class="n">RAW</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">])</span>
                <span class="n">artifacts</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">artifact</span><span class="p">]</span>
            <span class="c1"># TODO: fix this</span>
            <span class="n">artifacts</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">artifacts</span><span class="p">[</span><span class="s2">&quot;model0&quot;</span><span class="p">]</span>  <span class="c1"># Dummy model because default artifacts can not be empty</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="n">helper</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">artifact</span> <span class="o">=</span> <span class="n">Artifact</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="n">raw</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">ArtifactFormat</span><span class="o">.</span><span class="n">RAW</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">])</span>
            <span class="n">artifacts</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">artifact</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">artifacts</span><span class="p">,</span> <span class="p">{}</span></div>
</div>



<div class="viewcode-block" id="OpenASIPFrontend">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.OpenASIPFrontend">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">OpenASIPFrontend</span><span class="p">(</span><span class="n">SimpleFrontend</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="s2">&quot;openasip&quot;</span><span class="p">,</span>
            <span class="n">ModelFormats</span><span class="o">.</span><span class="n">NONE</span><span class="p">,</span>
            <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">supported_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="s2">&quot;sha256&quot;</span><span class="p">,</span>
            <span class="s2">&quot;aes&quot;</span><span class="p">,</span>
            <span class="s2">&quot;crc&quot;</span><span class="p">,</span>
        <span class="p">]</span>

    <span class="c1"># @property</span>
    <span class="c1"># def skip_backend(self):</span>
    <span class="c1">#     return True</span>

<div class="viewcode-block" id="OpenASIPFrontend.lookup_models">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.OpenASIPFrontend.lookup_models">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">lookup_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;openasip/&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">supported_names</span><span class="p">:</span>
                <span class="n">hint</span> <span class="o">=</span> <span class="n">OpenASIPProgram</span><span class="p">(</span>
                    <span class="n">name</span><span class="p">,</span>
                    <span class="n">alt</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;openasip/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hint</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="OpenASIPFrontend.generate">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.OpenASIPFrontend.generate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
        <span class="n">artifacts</span> <span class="o">=</span> <span class="p">[</span><span class="n">Artifact</span><span class="p">(</span><span class="s2">&quot;dummy_model&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="nb">bytes</span><span class="p">(),</span> <span class="n">fmt</span><span class="o">=</span><span class="n">ArtifactFormat</span><span class="o">.</span><span class="n">RAW</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="s2">&quot;dummy&quot;</span><span class="p">])]</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="n">artifacts</span><span class="p">},</span> <span class="p">{}</span></div>


<div class="viewcode-block" id="OpenASIPFrontend.get_platform_config">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.OpenASIPFrontend.get_platform_config">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_platform_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">platform</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;mlif&quot;</span><span class="p">:</span>
            <span class="n">ret</span><span class="p">[</span><span class="s2">&quot;template&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;openasip&quot;</span>
        <span class="k">return</span> <span class="n">ret</span></div>
</div>



<div class="viewcode-block" id="RVVBenchFrontend">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.RVVBenchFrontend">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RVVBenchFrontend</span><span class="p">(</span><span class="n">SimpleFrontend</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="s2">&quot;rvv_bench&quot;</span><span class="p">,</span>
            <span class="n">ModelFormats</span><span class="o">.</span><span class="n">NONE</span><span class="p">,</span>
            <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">supported_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="s2">&quot;instructions_scalar&quot;</span><span class="p">,</span>
            <span class="s2">&quot;instructions_rvv&quot;</span><span class="p">,</span>
            <span class="s2">&quot;memcpy&quot;</span><span class="p">,</span>
            <span class="s2">&quot;memset&quot;</span><span class="p">,</span>
            <span class="s2">&quot;utf8_count&quot;</span><span class="p">,</span>
            <span class="s2">&quot;strlen&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mergelines&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mandelbrot&quot;</span><span class="p">,</span>
            <span class="s2">&quot;chacha20&quot;</span><span class="p">,</span>
            <span class="s2">&quot;poly1305&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ascii_to_utf16&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ascii_to_uft32&quot;</span><span class="p">,</span>
            <span class="s2">&quot;byteswap&quot;</span><span class="p">,</span>
            <span class="s2">&quot;LUT4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;LUT6&quot;</span><span class="p">,</span>
            <span class="s2">&quot;hist&quot;</span><span class="p">,</span>
            <span class="s2">&quot;base64_encode&quot;</span><span class="p">,</span>
        <span class="p">]</span>

    <span class="c1"># @property</span>
    <span class="c1"># def skip_backend(self):</span>
    <span class="c1">#     return True</span>

<div class="viewcode-block" id="RVVBenchFrontend.lookup_models">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.RVVBenchFrontend.lookup_models">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">lookup_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;rvv_bench/&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">supported_names</span><span class="p">:</span>
                <span class="n">hint</span> <span class="o">=</span> <span class="n">RVVBenchProgram</span><span class="p">(</span>
                    <span class="n">name</span><span class="p">,</span>
                    <span class="n">alt</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;rvv_bench/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hint</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="RVVBenchFrontend.generate">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.RVVBenchFrontend.generate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
        <span class="n">artifacts</span> <span class="o">=</span> <span class="p">[</span><span class="n">Artifact</span><span class="p">(</span><span class="s2">&quot;dummy_model&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="nb">bytes</span><span class="p">(),</span> <span class="n">fmt</span><span class="o">=</span><span class="n">ArtifactFormat</span><span class="o">.</span><span class="n">RAW</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="s2">&quot;dummy&quot;</span><span class="p">])]</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="n">artifacts</span><span class="p">},</span> <span class="p">{}</span></div>


<div class="viewcode-block" id="RVVBenchFrontend.get_platform_config">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.RVVBenchFrontend.get_platform_config">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_platform_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">platform</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;mlif&quot;</span><span class="p">:</span>
            <span class="n">ret</span><span class="p">[</span><span class="s2">&quot;template&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;rvv_bench&quot;</span>
        <span class="k">return</span> <span class="n">ret</span></div>
</div>



<div class="viewcode-block" id="ISSBenchFrontend">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.ISSBenchFrontend">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ISSBenchFrontend</span><span class="p">(</span><span class="n">SimpleFrontend</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="s2">&quot;iss_bench&quot;</span><span class="p">,</span>
            <span class="n">ModelFormats</span><span class="o">.</span><span class="n">NONE</span><span class="p">,</span>
            <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">supported_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="s2">&quot;large_block&quot;</span><span class="p">,</span>
            <span class="s2">&quot;branch_heavy&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mem_heavy&quot;</span><span class="p">,</span>
        <span class="p">]</span>

    <span class="c1"># @property</span>
    <span class="c1"># def skip_backend(self):</span>
    <span class="c1">#     return True</span>

<div class="viewcode-block" id="ISSBenchFrontend.lookup_models">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.ISSBenchFrontend.lookup_models">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">lookup_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;iss_bench/&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">supported_names</span><span class="p">:</span>
                <span class="n">hint</span> <span class="o">=</span> <span class="n">ISSBenchProgram</span><span class="p">(</span>
                    <span class="n">name</span><span class="p">,</span>
                    <span class="n">alt</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;iss_bench/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hint</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="ISSBenchFrontend.generate">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.ISSBenchFrontend.generate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
        <span class="n">artifacts</span> <span class="o">=</span> <span class="p">[</span><span class="n">Artifact</span><span class="p">(</span><span class="s2">&quot;dummy_model&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="nb">bytes</span><span class="p">(),</span> <span class="n">fmt</span><span class="o">=</span><span class="n">ArtifactFormat</span><span class="o">.</span><span class="n">RAW</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="s2">&quot;dummy&quot;</span><span class="p">])]</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="n">artifacts</span><span class="p">},</span> <span class="p">{}</span></div>


<div class="viewcode-block" id="ISSBenchFrontend.get_platform_config">
<a class="viewcode-back" href="../../../mlonmcu.models.html#mlonmcu.models.frontend.ISSBenchFrontend.get_platform_config">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_platform_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">platform</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;mlif&quot;</span><span class="p">:</span>
            <span class="n">ret</span><span class="p">[</span><span class="s2">&quot;template&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;iss_bench&quot;</span>
        <span class="k">return</span> <span class="n">ret</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, TUM Department of Electrical and Computer Engineering - Chair of Electronic Design Automation.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>