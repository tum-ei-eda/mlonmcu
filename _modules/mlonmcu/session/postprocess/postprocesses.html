

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>mlonmcu.session.postprocess.postprocesses &mdash; ML on MCU 0.7.dev0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../_static/documentation_options.js?v=3bfbed7b"></script>
      <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            ML on MCU
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../readme.html">ML on MCU</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../design.html">Important Terms and Design Decisions (RFC)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../components.html">Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../components.html#components-in-detail">Components in Detail</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../environments.html">Environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../postprocess.html">Postprocesses</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../logging.html">Logging and Verbosity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../authors.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../history.html">History</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">ML on MCU</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">mlonmcu.session.postprocess.postprocesses</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for mlonmcu.session.postprocess.postprocesses</h1><div class="highlight"><pre>
<span></span><span class="c1">#</span>
<span class="c1"># Copyright (c) 2022 TUM Department of Electrical and Computer Engineering.</span>
<span class="c1">#</span>
<span class="c1"># This file is part of MLonMCU.</span>
<span class="c1"># See https://github.com/tum-ei-eda/mlonmcu.git for further info.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="c1">#</span>
<span class="sd">&quot;&quot;&quot;Collection of (example) postprocesses integrated in MLonMCU.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">ast</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">mlonmcu.artifact</span> <span class="kn">import</span> <span class="n">Artifact</span><span class="p">,</span> <span class="n">ArtifactFormat</span><span class="p">,</span> <span class="n">lookup_artifacts</span>
<span class="kn">from</span> <span class="nn">mlonmcu.config</span> <span class="kn">import</span> <span class="n">str2dict</span><span class="p">,</span> <span class="n">str2bool</span><span class="p">,</span> <span class="n">str2list</span>
<span class="kn">from</span> <span class="nn">mlonmcu.logging</span> <span class="kn">import</span> <span class="n">get_logger</span>

<span class="kn">from</span> <span class="nn">.postprocess</span> <span class="kn">import</span> <span class="n">SessionPostprocess</span><span class="p">,</span> <span class="n">RunPostprocess</span>
<span class="kn">from</span> <span class="nn">.validate_metrics</span> <span class="kn">import</span> <span class="n">parse_validate_metrics</span><span class="p">,</span> <span class="n">parse_classify_metrics</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">()</span>


<div class="viewcode-block" id="match_rows">
<a class="viewcode-back" href="../../../../mlonmcu.session.postprocess.html#mlonmcu.session.postprocess.postprocesses.match_rows">[docs]</a>
<span class="k">def</span> <span class="nf">match_rows</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">cols</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper function to group similar rows in a dataframe.&quot;&quot;&quot;</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">groups</span></div>



<span class="k">def</span> <span class="nf">_check_cfg</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^((?:[a-zA-Z\d\-_ \.\[\]]+)(?:,[a-zA-Z\d\-_ \.\[\]]+)*)$&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">_parse_cfg</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">_check_cfg</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>


<div class="viewcode-block" id="FilterColumnsPostprocess">
<a class="viewcode-back" href="../../../../mlonmcu.session.postprocess.html#mlonmcu.session.postprocess.postprocesses.FilterColumnsPostprocess">[docs]</a>
<span class="k">class</span> <span class="nc">FilterColumnsPostprocess</span><span class="p">(</span><span class="n">SessionPostprocess</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Postprocess which can be used to drop unwanted columns from a report.&quot;&quot;&quot;</span>

    <span class="n">DEFAULTS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="o">**</span><span class="n">SessionPostprocess</span><span class="o">.</span><span class="n">DEFAULTS</span><span class="p">,</span>
        <span class="s2">&quot;keep&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;drop&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;drop_nan&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;drop_empty&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;drop_const&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;filter_cols&quot;</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">keep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get keep property.&quot;&quot;&quot;</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;keep&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">_parse_cfg</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cfg</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">drop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get drop property.&quot;&quot;&quot;</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">_parse_cfg</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cfg</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">drop_nan</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get drop_nan property.&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;drop_nan&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">drop_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get drop_empty property.&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;drop_empty&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">drop_const</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get drop_const property.&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;drop_const&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<div class="viewcode-block" id="FilterColumnsPostprocess.post_session">
<a class="viewcode-back" href="../../../../mlonmcu.session.postprocess.html#mlonmcu.session.postprocess.postprocesses.FilterColumnsPostprocess.post_session">[docs]</a>
    <span class="k">def</span> <span class="nf">post_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">report</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Called at the end of a session.&quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_filter_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">keep</span><span class="p">,</span> <span class="n">drop</span><span class="p">,</span> <span class="n">drop_nan</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">drop_empty</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">drop_const</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">drop_empty</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span>
            <span class="k">if</span> <span class="n">drop_nan</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">drop_const</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="n">df</span> <span class="o">!=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">any</span><span class="p">()]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">keep</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">drop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;&#39;drop&#39; and &#39;keep&#39; can not be defined at the same time&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">keep</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">drop_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keep</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">drop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">drop_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">drop</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">drop_cols</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">drop_cols</span><span class="p">)</span>

        <span class="n">report</span><span class="o">.</span><span class="n">pre_df</span> <span class="o">=</span> <span class="n">_filter_df</span><span class="p">(</span>
            <span class="n">report</span><span class="o">.</span><span class="n">pre_df</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">keep</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">drop</span><span class="p">,</span>
            <span class="n">drop_nan</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">drop_nan</span><span class="p">,</span>
            <span class="n">drop_empty</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">drop_empty</span><span class="p">,</span>
            <span class="n">drop_const</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">drop_const</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">main_df</span> <span class="o">=</span> <span class="n">_filter_df</span><span class="p">(</span>
            <span class="n">report</span><span class="o">.</span><span class="n">main_df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop</span><span class="p">,</span> <span class="n">drop_nan</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">drop_nan</span><span class="p">,</span> <span class="n">drop_const</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">drop_const</span>
        <span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">post_df</span> <span class="o">=</span> <span class="n">_filter_df</span><span class="p">(</span>
            <span class="n">report</span><span class="o">.</span><span class="n">post_df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop</span><span class="p">,</span> <span class="n">drop_nan</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">drop_nan</span><span class="p">,</span> <span class="n">drop_const</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">drop_const</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="RenameColumnsPostprocess">
<a class="viewcode-back" href="../../../../mlonmcu.session.postprocess.html#mlonmcu.session.postprocess.postprocesses.RenameColumnsPostprocess">[docs]</a>
<span class="k">class</span> <span class="nc">RenameColumnsPostprocess</span><span class="p">(</span><span class="n">SessionPostprocess</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Postprocess which can rename columns based on a provided mapping.&quot;&quot;&quot;</span>

    <span class="n">DEFAULTS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="o">**</span><span class="n">SessionPostprocess</span><span class="o">.</span><span class="n">DEFAULTS</span><span class="p">,</span>
        <span class="s2">&quot;mapping&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s2">&quot;merge&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;rename_cols&quot;</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;mapping&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">str2dict</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;merge&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<div class="viewcode-block" id="RenameColumnsPostprocess.post_session">
<a class="viewcode-back" href="../../../../mlonmcu.session.postprocess.html#mlonmcu.session.postprocess.postprocesses.RenameColumnsPostprocess.post_session">[docs]</a>
    <span class="k">def</span> <span class="nf">post_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">report</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Called at the end of a session.&quot;&quot;&quot;</span>
        <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">values</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;rename_cols: non unique mapping found. use merge=True to avoid overwriting values.&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">df</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="s2">&quot;first&quot;</span><span class="p">)]</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="s2">&quot;first&quot;</span><span class="p">)]</span>
            <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="n">combine_first</span><span class="p">(</span><span class="n">merge</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>

        <span class="n">report</span><span class="o">.</span><span class="n">pre_df</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">pre_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">main_df</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">main_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">post_df</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">post_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge</span><span class="p">:</span>
            <span class="n">report</span><span class="o">.</span><span class="n">pre_df</span> <span class="o">=</span> <span class="n">merge</span><span class="p">(</span><span class="n">report</span><span class="o">.</span><span class="n">pre_df</span><span class="p">)</span>
            <span class="n">report</span><span class="o">.</span><span class="n">main_df</span> <span class="o">=</span> <span class="n">merge</span><span class="p">(</span><span class="n">report</span><span class="o">.</span><span class="n">main_df</span><span class="p">)</span>
            <span class="n">report</span><span class="o">.</span><span class="n">post_df</span> <span class="o">=</span> <span class="n">merge</span><span class="p">(</span><span class="n">report</span><span class="o">.</span><span class="n">post_df</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="Features2ColumnsPostprocess">
<a class="viewcode-back" href="../../../../mlonmcu.session.postprocess.html#mlonmcu.session.postprocess.postprocesses.Features2ColumnsPostprocess">[docs]</a>
<span class="k">class</span> <span class="nc">Features2ColumnsPostprocess</span><span class="p">(</span><span class="n">SessionPostprocess</span><span class="p">):</span>  <span class="c1"># RunPostprocess?</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Postprocess which can be used to transform (explode) the &#39;Features&#39; Column</span>
<span class="sd">    in a dataframe for easier filtering.&quot;&quot;&quot;</span>

    <span class="n">DEFAULTS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="o">**</span><span class="n">SessionPostprocess</span><span class="o">.</span><span class="n">DEFAULTS</span><span class="p">,</span>
        <span class="s2">&quot;limit&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;drop&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;features2cols&quot;</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">limit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get limit property.&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;limit&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">str2list</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">drop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get drop property.&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<div class="viewcode-block" id="Features2ColumnsPostprocess.post_session">
<a class="viewcode-back" href="../../../../mlonmcu.session.postprocess.html#mlonmcu.session.postprocess.postprocesses.Features2ColumnsPostprocess.post_session">[docs]</a>
    <span class="k">def</span> <span class="nf">post_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">report</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">post_df</span>
        <span class="k">if</span> <span class="s2">&quot;Features&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">to_concat</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Features&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">({</span><span class="s2">&quot;feature_&quot;</span> <span class="o">+</span> <span class="n">feature_name</span><span class="p">:</span> <span class="n">feature_name</span> <span class="ow">in</span> <span class="n">x</span><span class="p">}))</span>
            <span class="k">for</span> <span class="n">feature_name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Features&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span>
            <span class="k">if</span> <span class="n">feature_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limit</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">to_concat</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">feature_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="n">to_concat</span><span class="p">,</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop</span><span class="p">:</span>
            <span class="n">tmp_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Features&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tmp_df</span> <span class="o">=</span> <span class="n">df</span>
        <span class="n">new_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">tmp_df</span><span class="p">,</span> <span class="n">feature_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">post_df</span> <span class="o">=</span> <span class="n">new_df</span></div>
</div>



<div class="viewcode-block" id="Config2ColumnsPostprocess">
<a class="viewcode-back" href="../../../../mlonmcu.session.postprocess.html#mlonmcu.session.postprocess.postprocesses.Config2ColumnsPostprocess">[docs]</a>
<span class="k">class</span> <span class="nc">Config2ColumnsPostprocess</span><span class="p">(</span><span class="n">SessionPostprocess</span><span class="p">):</span>  <span class="c1"># RunPostprocess?</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Postprocess which can be used to transform (explode) the &#39;Config&#39; Column in a dataframe for easier filtering.&quot;&quot;&quot;</span>

    <span class="n">DEFAULTS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="o">**</span><span class="n">SessionPostprocess</span><span class="o">.</span><span class="n">DEFAULTS</span><span class="p">,</span>
        <span class="s2">&quot;limit&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;drop&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;config2cols&quot;</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">limit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get limit property.&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;limit&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">str2list</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">drop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get drop property.&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;drop&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<div class="viewcode-block" id="Config2ColumnsPostprocess.post_session">
<a class="viewcode-back" href="../../../../mlonmcu.session.postprocess.html#mlonmcu.session.postprocess.postprocesses.Config2ColumnsPostprocess.post_session">[docs]</a>
    <span class="k">def</span> <span class="nf">post_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">report</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Called at the end of a session.&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">post_df</span>
        <span class="k">if</span> <span class="s2">&quot;Config&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">config_df</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Config&quot;</span><span class="p">]</span>
            <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limit</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">})</span>
            <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span>
            <span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="s2">&quot;config_&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop</span><span class="p">:</span>
            <span class="n">tmp_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Config&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tmp_df</span> <span class="o">=</span> <span class="n">df</span>
        <span class="n">new_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">tmp_df</span><span class="p">,</span> <span class="n">config_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">post_df</span> <span class="o">=</span> <span class="n">new_df</span></div>
</div>



<div class="viewcode-block" id="MyPostprocess">
<a class="viewcode-back" href="../../../../mlonmcu.session.postprocess.html#mlonmcu.session.postprocess.postprocesses.MyPostprocess">[docs]</a>
<span class="k">class</span> <span class="nc">MyPostprocess</span><span class="p">(</span><span class="n">SessionPostprocess</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;TODO&quot;&quot;&quot;</span>

    <span class="n">DEFAULTS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="o">**</span><span class="n">SessionPostprocess</span><span class="o">.</span><span class="n">DEFAULTS</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;mypost&quot;</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config2cols</span> <span class="o">=</span> <span class="n">Config2ColumnsPostprocess</span><span class="p">(</span>
            <span class="n">config</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;config2cols.limit&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;tvmllvm.desired_layout&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;tvmaot.desired_layout&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;tvmaotplus.desired_layout&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;tvmrt.desired_layout&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;xcorev.mem&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;xcorev.mac&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;xcorev.bi&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;xcorev.alu&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;xcorev.bitmanip&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;xcorev.simd&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;xcorev.hwlp&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;cv32e40p.fpu&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;etiss.fpu&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;corev_ovpsim.fpu&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;tvmaot.disabled_passes&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;tvmaotplus.disabled_passes&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;tvmrt.disabled_passes&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;tvmllvm.disabled_passes&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;auto_vectorize.loop&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;auto_vectorize.slp&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;auto_vectorize.force_vector_width&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;auto_vectorize.force_vector_interleave&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;auto_vectorize.custom_unroll&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;tvmllvm.target_keys&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;tvmrt.target_keys&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;tvmaot.target_keys&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;tvmaotplus.target_keys&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;autotuned.mode&quot;</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="s2">&quot;config2cols.drop&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rename_cols</span> <span class="o">=</span> <span class="n">RenameColumnsPostprocess</span><span class="p">(</span>
            <span class="n">config</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;rename_cols.mapping&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;config_tvmllvm.desired_layout&quot;</span><span class="p">:</span> <span class="s2">&quot;Layout&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;config_tvmaot.desired_layout&quot;</span><span class="p">:</span> <span class="s2">&quot;Layout&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;config_tvmaotplus.desired_layout&quot;</span><span class="p">:</span> <span class="s2">&quot;Layout&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;config_tvmrt.desired_layout&quot;</span><span class="p">:</span> <span class="s2">&quot;Layout&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;config_xcorev.mem&quot;</span><span class="p">:</span> <span class="s2">&quot;XCVMem&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;config_xcorev.mac&quot;</span><span class="p">:</span> <span class="s2">&quot;XCVMac&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;config_xcorev.bi&quot;</span><span class="p">:</span> <span class="s2">&quot;XCVBi&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;config_xcorev.alu&quot;</span><span class="p">:</span> <span class="s2">&quot;XCVAlu&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;config_xcorev.bitmanip&quot;</span><span class="p">:</span> <span class="s2">&quot;XCVBitmanip&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;config_xcorev.simd&quot;</span><span class="p">:</span> <span class="s2">&quot;XCVSimd&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;config_xcorev.hwlp&quot;</span><span class="p">:</span> <span class="s2">&quot;XCVHwlp&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;feature_autotuned&quot;</span><span class="p">:</span> <span class="s2">&quot;Autotuned&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;feature_debug&quot;</span><span class="p">:</span> <span class="s2">&quot;Debug&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;config_cv32e40p.fpu&quot;</span><span class="p">:</span> <span class="s2">&quot;FPU&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;config_etiss.fpu&quot;</span><span class="p">:</span> <span class="s2">&quot;FPU&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;config_corev_ovpsim.fpu&quot;</span><span class="p">:</span> <span class="s2">&quot;FPU&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;config_tvmaot.disabled_passes&quot;</span><span class="p">:</span> <span class="s2">&quot;Disabled&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;config_tvmaotplus.disabled_passes&quot;</span><span class="p">:</span> <span class="s2">&quot;Disabled&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;config_tvmrt.disabled_passes&quot;</span><span class="p">:</span> <span class="s2">&quot;Disabled&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;config_tvmllvm.disabled_passes&quot;</span><span class="p">:</span> <span class="s2">&quot;Disabled&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;config_auto_vectorize.loop&quot;</span><span class="p">:</span> <span class="s2">&quot;Loop&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;config_auto_vectorize.slp&quot;</span><span class="p">:</span> <span class="s2">&quot;Slp&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;config_auto_vectorize.force_vector_width&quot;</span><span class="p">:</span> <span class="s2">&quot;FVW&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;config_auto_vectorize.force_vector_interleave&quot;</span><span class="p">:</span> <span class="s2">&quot;FVI&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;config_auto_vectorize.custom_unroll&quot;</span><span class="p">:</span> <span class="s2">&quot;Unroll&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;config_tvmllvm.target_keys&quot;</span><span class="p">:</span> <span class="s2">&quot;Keys&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;config_tvmrt.target_keys&quot;</span><span class="p">:</span> <span class="s2">&quot;Keys&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;config_tvmaot.target_keys&quot;</span><span class="p">:</span> <span class="s2">&quot;Keys&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;config_tvmaotplus.target_keys&quot;</span><span class="p">:</span> <span class="s2">&quot;Keys&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;config_autotuned.mode&quot;</span><span class="p">:</span> <span class="s2">&quot;Tuner&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features2cols</span> <span class="o">=</span> <span class="n">Features2ColumnsPostprocess</span><span class="p">(</span>
            <span class="n">config</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;features2cols.limit&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;autotuned&quot;</span><span class="p">,</span> <span class="s2">&quot;debug&quot;</span><span class="p">,</span> <span class="s2">&quot;auto_vectorize&quot;</span><span class="p">,</span> <span class="s2">&quot;target_optimized&quot;</span><span class="p">],</span>
                <span class="s2">&quot;features2cols.drop&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter_cols</span> <span class="o">=</span> <span class="n">FilterColumnsPostprocess</span><span class="p">(</span>
            <span class="n">config</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;filter_cols.drop&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;Postprocesses&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Framework&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Platform&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Session&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;ROM read-only&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;ROM code&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;ROM misc&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;RAM data&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;RAM zero-init data&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Run Stage Time [s]&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Compile Stage Time [s]&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Workspace Size [B]&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Build Stage Time [s]&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Load Stage Time [s]&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;feature_auto_vectorize&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;feature_target_optimized&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Setup Cycles&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Setup Instructions&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Setup CPI&quot;</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">}</span>
        <span class="p">)</span>

<div class="viewcode-block" id="MyPostprocess.post_session">
<a class="viewcode-back" href="../../../../mlonmcu.session.postprocess.html#mlonmcu.session.postprocess.postprocesses.MyPostprocess.post_session">[docs]</a>
    <span class="k">def</span> <span class="nf">post_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">report</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;TODO&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config2cols</span><span class="o">.</span><span class="n">post_session</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features2cols</span><span class="o">.</span><span class="n">post_session</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rename_cols</span><span class="o">.</span><span class="n">post_session</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter_cols</span><span class="o">.</span><span class="n">post_session</span><span class="p">(</span><span class="n">report</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="PassConfig2ColumnsPostprocess">
<a class="viewcode-back" href="../../../../mlonmcu.session.postprocess.html#mlonmcu.session.postprocess.postprocesses.PassConfig2ColumnsPostprocess">[docs]</a>
<span class="k">class</span> <span class="nc">PassConfig2ColumnsPostprocess</span><span class="p">(</span><span class="n">SessionPostprocess</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Postprocess which can be used to transform (explode) the TVM pass_config into separate columns.</span>
<span class="sd">    requires prior Config2Columns pass.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;passcfg2cols&quot;</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

<div class="viewcode-block" id="PassConfig2ColumnsPostprocess.post_session">
<a class="viewcode-back" href="../../../../mlonmcu.session.postprocess.html#mlonmcu.session.postprocess.postprocesses.PassConfig2ColumnsPostprocess.post_session">[docs]</a>
    <span class="k">def</span> <span class="nf">post_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">report</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Called at the end of a session.&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">post_df</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;config_tvmaot.extra_pass_config&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">config_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span><span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="s2">&quot;passcfg_&quot;</span><span class="p">)</span>
        <span class="n">tmp_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
        <span class="n">new_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">tmp_df</span><span class="p">,</span> <span class="n">config_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">post_df</span> <span class="o">=</span> <span class="n">new_df</span></div>
</div>



<div class="viewcode-block" id="Bytes2kBPostprocess">
<a class="viewcode-back" href="../../../../mlonmcu.session.postprocess.html#mlonmcu.session.postprocess.postprocesses.Bytes2kBPostprocess">[docs]</a>
<span class="k">class</span> <span class="nc">Bytes2kBPostprocess</span><span class="p">(</span><span class="n">SessionPostprocess</span><span class="p">):</span>  <span class="c1"># RunPostprocess?</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Postprocess which can be used to scale the memory related columns from Bytes to KiloBytes.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;bytes2kb&quot;</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

<div class="viewcode-block" id="Bytes2kBPostprocess.post_session">
<a class="viewcode-back" href="../../../../mlonmcu.session.postprocess.html#mlonmcu.session.postprocess.postprocesses.Bytes2kBPostprocess.post_session">[docs]</a>
    <span class="k">def</span> <span class="nf">post_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">report</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Called at the end of a session.&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">main_df</span>
        <span class="n">match_strs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ROM&quot;</span><span class="p">,</span> <span class="s2">&quot;RAM&quot;</span><span class="p">]</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">any</span><span class="p">(</span><span class="n">s</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">match_strs</span><span class="p">),</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># Only scale columns related to memory</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span> <span class="k">if</span> <span class="s2">&quot;kB&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">col</span><span class="p">]</span>  <span class="c1"># Do not scale columns with are already in kB</span>

        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1000.0</span>
            <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="n">col</span> <span class="o">+</span> <span class="s2">&quot; [kB]&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">report</span><span class="o">.</span><span class="n">main_df</span> <span class="o">=</span> <span class="n">df</span></div>
</div>



<div class="viewcode-block" id="VisualizePostprocess">
<a class="viewcode-back" href="../../../../mlonmcu.session.postprocess.html#mlonmcu.session.postprocess.postprocesses.VisualizePostprocess">[docs]</a>
<span class="k">class</span> <span class="nc">VisualizePostprocess</span><span class="p">(</span><span class="n">SessionPostprocess</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A very simple example on how to generate a plot of the results using a postprocess.&quot;&quot;&quot;</span>

    <span class="n">DEFAULTS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="o">**</span><span class="n">SessionPostprocess</span><span class="o">.</span><span class="n">DEFAULTS</span><span class="p">,</span>
        <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;png&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;visualize&quot;</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">format</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get format property.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;format&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="VisualizePostprocess.post_session">
<a class="viewcode-back" href="../../../../mlonmcu.session.postprocess.html#mlonmcu.session.postprocess.postprocesses.VisualizePostprocess.post_session">[docs]</a>
    <span class="k">def</span> <span class="nf">post_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">report</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Called at the end of a session.&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">report</span><span class="o">.</span><span class="n">pre_df</span><span class="p">,</span> <span class="n">report</span><span class="o">.</span><span class="n">main_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span> <span class="o">!=</span> <span class="s2">&quot;png&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Currently only supports PNG&quot;</span><span class="p">)</span>

        <span class="n">COLS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Cycles&quot;</span><span class="p">,</span> <span class="s2">&quot;Total ROM&quot;</span><span class="p">,</span> <span class="s2">&quot;Total RAM&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">COLS</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">report</span><span class="o">.</span><span class="n">main_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[]</span>

        <span class="c1"># Local import to deal with optional dependencies</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">COLS</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># (w, h)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">COLS</span><span class="p">):</span>
            <span class="n">new_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">col</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
            <span class="n">bar_names_df</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Session&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Run&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
            <span class="p">)</span>  <span class="c1"># ideally we would use model/backend/target names here...</span>
            <span class="n">new_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">bar_names_df</span>
            <span class="n">new_df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;bar&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdirname</span><span class="p">:</span>
            <span class="n">fig_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tmpdirname</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;plot.png&quot;</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig_path</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fig_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="n">artifacts</span> <span class="o">=</span> <span class="p">[</span><span class="n">Artifact</span><span class="p">(</span><span class="s2">&quot;plot.png&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">ArtifactFormat</span><span class="o">.</span><span class="n">RAW</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">artifacts</span></div>
</div>



<div class="viewcode-block" id="Artifact2ColumnPostprocess">
<a class="viewcode-back" href="../../../../mlonmcu.session.postprocess.html#mlonmcu.session.postprocess.postprocesses.Artifact2ColumnPostprocess">[docs]</a>
<span class="k">class</span> <span class="nc">Artifact2ColumnPostprocess</span><span class="p">(</span><span class="n">RunPostprocess</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Postprocess for converting artifacts to columns in the report.&quot;&quot;&quot;</span>

    <span class="n">DEFAULTS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="o">**</span><span class="n">RunPostprocess</span><span class="o">.</span><span class="n">DEFAULTS</span><span class="p">,</span>
        <span class="s2">&quot;file2colname&quot;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;artifacts2cols&quot;</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">file2colname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get file2colname property.&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;file2colname&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">str2dict</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

<div class="viewcode-block" id="Artifact2ColumnPostprocess.post_run">
<a class="viewcode-back" href="../../../../mlonmcu.session.postprocess.html#mlonmcu.session.postprocess.postprocesses.Artifact2ColumnPostprocess.post_run">[docs]</a>
    <span class="k">def</span> <span class="nf">post_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">report</span><span class="p">,</span> <span class="n">artifacts</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Called at the end of a run.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">colname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">file2colname</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">filecol</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="s2">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">filename</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="n">fname</span><span class="p">,</span> <span class="n">filecol</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="n">fname</span>
            <span class="n">matches</span> <span class="o">=</span> <span class="n">lookup_artifacts</span><span class="p">(</span><span class="n">artifacts</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">first_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">matches</span><span class="p">:</span>
                <span class="n">report</span><span class="o">.</span><span class="n">main_df</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fmt</span> <span class="o">!=</span> <span class="n">ArtifactFormat</span><span class="o">.</span><span class="n">TEXT</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Can only put text into report columns&quot;</span><span class="p">)</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">content</span>
            <span class="k">if</span> <span class="n">filecol</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">filename</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;.csv&quot;</span>
                <span class="n">filedf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">StringIO</span><span class="p">(</span><span class="n">content</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">filecol</span> <span class="o">==</span> <span class="s2">&quot;*&quot;</span><span class="p">:</span>
                    <span class="n">cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">filedf</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">filecol</span> <span class="ow">in</span> <span class="n">filedf</span><span class="o">.</span><span class="n">columns</span>
                    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">filecol</span><span class="p">]</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">filedf</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;list&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">content</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            <span class="n">report</span><span class="o">.</span><span class="n">main_df</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span> <span class="o">=</span> <span class="n">content</span>
        <span class="k">return</span> <span class="p">[]</span></div>
</div>



<div class="viewcode-block" id="AnalyseInstructionsPostprocess">
<a class="viewcode-back" href="../../../../mlonmcu.session.postprocess.html#mlonmcu.session.postprocess.postprocesses.AnalyseInstructionsPostprocess">[docs]</a>
<span class="k">class</span> <span class="nc">AnalyseInstructionsPostprocess</span><span class="p">(</span><span class="n">RunPostprocess</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Counting specific types of instructions.&quot;&quot;&quot;</span>

    <span class="n">DEFAULTS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="o">**</span><span class="n">RunPostprocess</span><span class="o">.</span><span class="n">DEFAULTS</span><span class="p">,</span>
        <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;sequences&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;seq_depth&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
        <span class="s2">&quot;to_df&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;to_file&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;corev&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;analyse_instructions&quot;</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">groups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get groups property.&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;groups&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sequences</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;get sequences property.&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;sequences&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">seq_depth</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;get seq_depth property.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;seq_depth&quot;</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">top</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;get top property.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">to_df</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get to_df property.&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;to_df&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">to_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get to_file property.&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;to_file&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">corev</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get corev property.&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;corev&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<div class="viewcode-block" id="AnalyseInstructionsPostprocess.post_run">
<a class="viewcode-back" href="../../../../mlonmcu.session.postprocess.html#mlonmcu.session.postprocess.postprocesses.AnalyseInstructionsPostprocess.post_run">[docs]</a>
    <span class="k">def</span> <span class="nf">post_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">report</span><span class="p">,</span> <span class="n">artifacts</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Called at the end of a run.&quot;&quot;&quot;</span>
        <span class="n">ret_artifacts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">log_artifact</span> <span class="o">=</span> <span class="n">lookup_artifacts</span><span class="p">(</span><span class="n">artifacts</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;log_instrs&quot;</span><span class="p">,),</span> <span class="n">fmt</span><span class="o">=</span><span class="n">ArtifactFormat</span><span class="o">.</span><span class="n">TEXT</span><span class="p">,</span> <span class="n">first_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">log_artifact</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;To use analyse_instructions process, please enable feature log_instrs.&quot;</span>
        <span class="n">log_artifact</span> <span class="o">=</span> <span class="n">log_artifact</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">is_spike</span> <span class="o">=</span> <span class="s2">&quot;spike&quot;</span> <span class="ow">in</span> <span class="n">log_artifact</span><span class="o">.</span><span class="n">flags</span>
        <span class="n">is_etiss</span> <span class="o">=</span> <span class="s2">&quot;etiss_pulpino&quot;</span> <span class="ow">in</span> <span class="n">log_artifact</span><span class="o">.</span><span class="n">flags</span> <span class="ow">or</span> <span class="s2">&quot;etiss&quot;</span> <span class="ow">in</span> <span class="n">log_artifact</span><span class="o">.</span><span class="n">flags</span>
        <span class="n">is_ovpsim</span> <span class="o">=</span> <span class="s2">&quot;ovpsim&quot;</span> <span class="ow">in</span> <span class="n">log_artifact</span><span class="o">.</span><span class="n">flags</span> <span class="ow">or</span> <span class="s2">&quot;corev_ovpsim&quot;</span> <span class="ow">in</span> <span class="n">log_artifact</span><span class="o">.</span><span class="n">flags</span>
        <span class="n">is_riscv</span> <span class="o">=</span> <span class="n">is_spike</span> <span class="ow">or</span> <span class="n">is_etiss</span> <span class="ow">or</span> <span class="n">is_ovpsim</span>
        <span class="k">if</span> <span class="n">is_spike</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">log_artifact</span><span class="o">.</span><span class="n">content</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
                <span class="n">encodings</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\((0x[0-9abcdef]+)\)&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequences</span><span class="p">:</span>
                <span class="n">names</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;core\s+\d+:\s0x[0-9abcdef]+\s\(0x[0-9abcdef]+\)\s([\w.]+).*&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">is_etiss</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">log_artifact</span><span class="o">.</span><span class="n">content</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
                <span class="n">encodings</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;0x[0-9abcdef]+:\s\w+\s#\s([0-9a-fx]+)\s.*&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
                <span class="n">encodings</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;0b</span><span class="si">{</span><span class="n">enc</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">enc</span> <span class="ow">in</span> <span class="n">encodings</span><span class="p">]</span>
                <span class="c1"># encodings = [f&quot;{enc}&quot; for enc in encodings]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequences</span><span class="p">:</span>
                <span class="n">names</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;0x[0-9abcdef]+:\s(\w+)\s#\s[0-9a-fx]+\s.*&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">is_ovpsim</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">log_artifact</span><span class="o">.</span><span class="n">content</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
                <span class="n">encodings</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;riscvOVPsim\/cpu&#39;,\s0x[0-9abcdef]+\(.*\):\s([0-9abcdef]+)\s+\w+\s+.*&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span>
                    <span class="n">content</span>
                <span class="p">)</span>
                <span class="n">encodings</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;0x</span><span class="si">{</span><span class="n">enc</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">enc</span> <span class="ow">in</span> <span class="n">encodings</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequences</span><span class="p">:</span>
                <span class="n">names</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;riscvOVPsim\/cpu&#39;,\s0x[0-9abcdef]+\(.*\):\s[0-9abcdef]+\s+(\w+)\s+.*&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span>
                    <span class="n">content</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Uable to determine the used target.&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_helper</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
            <span class="n">counts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
            <span class="n">probs</span> <span class="o">=</span> <span class="n">counts</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">counts</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">top</span><span class="p">)),</span> <span class="nb">dict</span><span class="p">(</span><span class="n">probs</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">top</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">_gen_csv</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">counts</span><span class="p">,</span> <span class="n">probs</span><span class="p">):</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">,Count,Probability&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">counts</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">counts</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">probs</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">is_riscv</span><span class="p">,</span> <span class="s2">&quot;Currently only riscv instrcutions can be analysed by groups&quot;</span>

            <span class="k">def</span> <span class="nf">_extract_major_opcode</span><span class="p">(</span><span class="n">enc</span><span class="p">):</span>
                <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="mb">0b0010011</span><span class="p">:</span> <span class="s2">&quot;OP-IMM&quot;</span><span class="p">,</span>
                    <span class="mb">0b0110111</span><span class="p">:</span> <span class="s2">&quot;LUI&quot;</span><span class="p">,</span>
                    <span class="mb">0b0010111</span><span class="p">:</span> <span class="s2">&quot;AUIPC&quot;</span><span class="p">,</span>
                    <span class="mb">0b0110011</span><span class="p">:</span> <span class="s2">&quot;OP&quot;</span><span class="p">,</span>
                    <span class="mb">0b1101111</span><span class="p">:</span> <span class="s2">&quot;JAL&quot;</span><span class="p">,</span>
                    <span class="mb">0b1100111</span><span class="p">:</span> <span class="s2">&quot;JALR&quot;</span><span class="p">,</span>
                    <span class="mb">0b1100011</span><span class="p">:</span> <span class="s2">&quot;BRANCH&quot;</span><span class="p">,</span>
                    <span class="mb">0b0000011</span><span class="p">:</span> <span class="s2">&quot;LOAD&quot;</span><span class="p">,</span>
                    <span class="mb">0b0100011</span><span class="p">:</span> <span class="s2">&quot;STORE&quot;</span><span class="p">,</span>
                    <span class="mb">0b0001111</span><span class="p">:</span> <span class="s2">&quot;MISC-MEM&quot;</span><span class="p">,</span>
                    <span class="mb">0b1110011</span><span class="p">:</span> <span class="s2">&quot;SYSTEM&quot;</span><span class="p">,</span>
                    <span class="mb">0b1000011</span><span class="p">:</span> <span class="s2">&quot;MADD&quot;</span><span class="p">,</span>
                    <span class="mb">0b1000111</span><span class="p">:</span> <span class="s2">&quot;MSUB&quot;</span><span class="p">,</span>
                    <span class="mb">0b1001011</span><span class="p">:</span> <span class="s2">&quot;MNSUB&quot;</span><span class="p">,</span>
                    <span class="mb">0b1001111</span><span class="p">:</span> <span class="s2">&quot;MNADD&quot;</span><span class="p">,</span>
                    <span class="mb">0b0000111</span><span class="p">:</span> <span class="s2">&quot;LOAD-FP&quot;</span><span class="p">,</span>
                    <span class="mb">0b0100111</span><span class="p">:</span> <span class="s2">&quot;STORE-FP&quot;</span><span class="p">,</span>
                    <span class="mb">0b0001011</span><span class="p">:</span> <span class="s2">&quot;custom-0&quot;</span><span class="p">,</span>
                    <span class="mb">0b0101011</span><span class="p">:</span> <span class="s2">&quot;custom-1&quot;</span><span class="p">,</span>
                    <span class="mb">0b1011011</span><span class="p">:</span> <span class="s2">&quot;custom-2/rv128&quot;</span><span class="p">,</span>
                    <span class="mb">0b1111011</span><span class="p">:</span> <span class="s2">&quot;custom-3/rv128&quot;</span><span class="p">,</span>
                    <span class="mb">0b1101011</span><span class="p">:</span> <span class="s2">&quot;reserved&quot;</span><span class="p">,</span>
                    <span class="mb">0b0101111</span><span class="p">:</span> <span class="s2">&quot;AMO&quot;</span><span class="p">,</span>
                    <span class="mb">0b1010011</span><span class="p">:</span> <span class="s2">&quot;OP-FP&quot;</span><span class="p">,</span>
                    <span class="mb">0b1010111</span><span class="p">:</span> <span class="s2">&quot;OP-V&quot;</span><span class="p">,</span>
                    <span class="mb">0b1110111</span><span class="p">:</span> <span class="s2">&quot;OP-P&quot;</span><span class="p">,</span>
                    <span class="mb">0b0011011</span><span class="p">:</span> <span class="s2">&quot;OP-IMM-32&quot;</span><span class="p">,</span>
                    <span class="mb">0b0111011</span><span class="p">:</span> <span class="s2">&quot;OP-32&quot;</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">enc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">enc</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Convert from hexadecimal</span>
                <span class="n">opcode</span> <span class="o">=</span> <span class="n">enc</span> <span class="o">&amp;</span> <span class="mb">0b1111111</span>
                <span class="n">lsbs</span> <span class="o">=</span> <span class="n">opcode</span> <span class="o">&amp;</span> <span class="mb">0b11</span>
                <span class="k">if</span> <span class="n">lsbs</span> <span class="o">==</span> <span class="mb">0b11</span><span class="p">:</span>
                    <span class="n">major</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">opcode</span><span class="p">,</span> <span class="s2">&quot;UNKNOWN&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># 16-bit instruction</span>
                    <span class="n">msbs</span> <span class="o">=</span> <span class="p">(</span><span class="n">enc</span> <span class="o">&amp;</span> <span class="mb">0b1110000000000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span>
                    <span class="n">rvc_mapping</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="mb">0b00000</span><span class="p">:</span> <span class="s2">&quot;OP-IMM&quot;</span><span class="p">,</span>
                        <span class="mb">0b00001</span><span class="p">:</span> <span class="s2">&quot;OP-IMM&quot;</span><span class="p">,</span>
                        <span class="mb">0b00010</span><span class="p">:</span> <span class="s2">&quot;OP-IMM&quot;</span><span class="p">,</span>
                        <span class="mb">0b00100</span><span class="p">:</span> <span class="s2">&quot;LOAD&quot;</span><span class="p">,</span>
                        <span class="mb">0b00101</span><span class="p">:</span> <span class="s2">&quot;JAL&quot;</span><span class="p">,</span>
                        <span class="mb">0b00110</span><span class="p">:</span> <span class="s2">&quot;LOAD-FP&quot;</span><span class="p">,</span>
                        <span class="mb">0b01000</span><span class="p">:</span> <span class="s2">&quot;LOAD&quot;</span><span class="p">,</span>
                        <span class="mb">0b01001</span><span class="p">:</span> <span class="s2">&quot;OP-IMM&quot;</span><span class="p">,</span>
                        <span class="mb">0b01010</span><span class="p">:</span> <span class="s2">&quot;LOAD&quot;</span><span class="p">,</span>
                        <span class="mb">0b01100</span><span class="p">:</span> <span class="s2">&quot;LOAD-FP&quot;</span><span class="p">,</span>
                        <span class="mb">0b01101</span><span class="p">:</span> <span class="s2">&quot;OP-IMM&quot;</span><span class="p">,</span>
                        <span class="mb">0b01110</span><span class="p">:</span> <span class="s2">&quot;LOAD-FP&quot;</span><span class="p">,</span>
                        <span class="mb">0b10000</span><span class="p">:</span> <span class="s2">&quot;reserved&quot;</span><span class="p">,</span>
                        <span class="mb">0b10001</span><span class="p">:</span> <span class="s2">&quot;MISC-ALU&quot;</span><span class="p">,</span>
                        <span class="mb">0b10010</span><span class="p">:</span> <span class="s2">&quot;JALR&quot;</span><span class="p">,</span>
                        <span class="mb">0b10100</span><span class="p">:</span> <span class="s2">&quot;STORE-FP&quot;</span><span class="p">,</span>
                        <span class="mb">0b10101</span><span class="p">:</span> <span class="s2">&quot;JAL&quot;</span><span class="p">,</span>
                        <span class="mb">0b10110</span><span class="p">:</span> <span class="s2">&quot;STORE-FP&quot;</span><span class="p">,</span>
                        <span class="mb">0b11000</span><span class="p">:</span> <span class="s2">&quot;STORE&quot;</span><span class="p">,</span>
                        <span class="mb">0b11001</span><span class="p">:</span> <span class="s2">&quot;BRANCH&quot;</span><span class="p">,</span>
                        <span class="mb">0b11010</span><span class="p">:</span> <span class="s2">&quot;STORE&quot;</span><span class="p">,</span>
                        <span class="mb">0b11100</span><span class="p">:</span> <span class="s2">&quot;STORE-FP&quot;</span><span class="p">,</span>
                        <span class="mb">0b11101</span><span class="p">:</span> <span class="s2">&quot;BRANCH&quot;</span><span class="p">,</span>
                        <span class="mb">0b11110</span><span class="p">:</span> <span class="s2">&quot;STORE-FP&quot;</span><span class="p">,</span>
                    <span class="p">}</span>
                    <span class="n">combined</span> <span class="o">=</span> <span class="n">msbs</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span> <span class="o">|</span> <span class="n">lsbs</span>
                    <span class="k">assert</span> <span class="n">combined</span> <span class="ow">in</span> <span class="n">rvc_mapping</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rvc_mapping</span><span class="p">[</span><span class="n">combined</span><span class="p">]</span><span class="si">}</span><span class="s2"> (Compressed)&quot;</span>
                <span class="k">return</span> <span class="n">major</span>

            <span class="n">majors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">_extract_major_opcode</span><span class="p">,</span> <span class="n">encodings</span><span class="p">))</span>
            <span class="n">major_counts</span><span class="p">,</span> <span class="n">major_probs</span> <span class="o">=</span> <span class="n">_helper</span><span class="p">(</span><span class="n">majors</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="p">)</span>
            <span class="n">majors_csv</span> <span class="o">=</span> <span class="n">_gen_csv</span><span class="p">(</span><span class="s2">&quot;Major&quot;</span><span class="p">,</span> <span class="n">major_counts</span><span class="p">,</span> <span class="n">major_probs</span><span class="p">)</span>
            <span class="n">artifact</span> <span class="o">=</span> <span class="n">Artifact</span><span class="p">(</span><span class="s2">&quot;analyse_instructions_majors.csv&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">majors_csv</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">ArtifactFormat</span><span class="o">.</span><span class="n">TEXT</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_file</span><span class="p">:</span>
                <span class="n">ret_artifacts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">artifact</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_df</span><span class="p">:</span>
                <span class="n">post_df</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">post_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">post_df</span><span class="p">[</span><span class="s2">&quot;AnalyseInstructionsMajorsCounts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">major_counts</span><span class="p">)</span>
                <span class="n">post_df</span><span class="p">[</span><span class="s2">&quot;AnalyseInstructionsMajorsProbs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">major_probs</span><span class="p">)</span>
                <span class="n">report</span><span class="o">.</span><span class="n">post_df</span> <span class="o">=</span> <span class="n">post_df</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequences</span><span class="p">:</span>
            <span class="n">max_len</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq_depth</span>

            <span class="k">def</span> <span class="nf">_get_sublists</span><span class="p">(</span><span class="n">lst</span><span class="p">,</span> <span class="n">length</span><span class="p">):</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span> <span class="o">-</span> <span class="n">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">lst_</span> <span class="o">=</span> <span class="n">lst</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">length</span><span class="p">]</span>
                    <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lst_</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">ret</span>

            <span class="k">for</span> <span class="n">length</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">names_</span> <span class="o">=</span> <span class="n">_get_sublists</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
                <span class="n">counts</span><span class="p">,</span> <span class="n">probs</span> <span class="o">=</span> <span class="n">_helper</span><span class="p">(</span><span class="n">names_</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="p">)</span>
                <span class="n">sequence_csv</span> <span class="o">=</span> <span class="n">_gen_csv</span><span class="p">(</span><span class="s2">&quot;Sequence&quot;</span><span class="p">,</span> <span class="n">counts</span><span class="p">,</span> <span class="n">probs</span><span class="p">)</span>
                <span class="n">artifact</span> <span class="o">=</span> <span class="n">Artifact</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;analyse_instructions_seq</span><span class="si">{</span><span class="n">length</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">sequence_csv</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">ArtifactFormat</span><span class="o">.</span><span class="n">TEXT</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_file</span><span class="p">:</span>
                    <span class="n">ret_artifacts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">artifact</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_df</span><span class="p">:</span>
                    <span class="n">post_df</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">post_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">post_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;AnalyseInstructionsSeq</span><span class="si">{</span><span class="n">length</span><span class="si">}</span><span class="s2">Counts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span>
                    <span class="n">post_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;AnalyseInstructionsSeq</span><span class="si">{</span><span class="n">length</span><span class="si">}</span><span class="s2">Probs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">probs</span><span class="p">)</span>
                    <span class="n">report</span><span class="o">.</span><span class="n">post_df</span> <span class="o">=</span> <span class="n">post_df</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">corev</span><span class="p">:</span>
            <span class="n">XCVMAC_INSNS</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;cv.mac&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.msu&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.mulun&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.mulhhun&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.mulsn&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.mulhhsn&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.mulurn&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.mulhhurn&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.mulsrn&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.mulhhsrn&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.macun&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.machhun&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.macsn&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.machhsn&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.macurn&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.machhurn&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.macsrn&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.machhsrn&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">XCVMEM_INSNS</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;cv.lb_ri_inc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.lbu_ri_inc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.lh_ri_inc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.lhu_ri_inc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.lw_ri_inc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.lb_ri_inc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.lbu_ri_inc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.lh_ri_inc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.lhu_ri_inc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.lw_ri_inc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.lb_rr_inc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.lbu_rr_inc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.lh_rr_inc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.lhu_rr_inc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.lw_rr_inc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.lb_rr_inc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.lbu_rr_inc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.lh_rr_inc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.lhu_rr_inc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.lw_rr_inc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.lb_rr&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.lbu_rr&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.lh_rr&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.lhu_rr&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.lw_rr&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.sb_ri_inc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.sh_ri_inc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.sw_ri_inc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.sb_ri_inc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.sh_ri_inc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.sw_ri_inc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.sb_rr_inc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.sh_rr_inc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.sw_rr_inc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.sb_rr_inc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.sh_rr_inc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.sw_rr_inc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.sb_rr&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.sh_rr&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.sw_rr&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">XCVBI_INSNS</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;cv.bneimm&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.beqimm&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">XCVALU_INSNS</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;cv.slet&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.min&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.addnr&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.addunr&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.addn&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.maxu&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.subun&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.extbz&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.addun&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.clip&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.clipu&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.subn&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.max&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.extbs&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.abs&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.addurn&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.exths&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.exthz&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.minu&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.sletu&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.suburn&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.addrn&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.clipur&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.subrn&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">XCVBITMANIP_INSNS</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;cv.ror&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.clb&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">XCVSIMD_INSNS</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;cv.add.h&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.add.sc.b&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.add.sc.h&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.add.sci.h&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.and.b&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.and.h&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.and.sc.h&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.and.sci.h&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.cmpeq.sc.h&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.cmpge.sci.h&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.cmpgtu.h&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.cmplt.sci.h&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.cmpltu.sci.b&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.cmpne.sc.h&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.cmpne.sci.b&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.extract.b&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.extract.h&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.extractu.b&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.extractu.h&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.insert.h&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.max.h&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.max.sci.h&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.maxu.h&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.or.b&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.or.h&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.pack&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.packhi.b&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.packlo.b&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.shuffle2.b&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.shuffle2.h&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.shufflei0.sci.b&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.sll.sci.h&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.sra.h&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.sra.sci.h&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.srl.h&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.srl.sci.h&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.sub.b&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.sub.h&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.xor.b&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.xor.sci.b&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.add.sci.b&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.cmpeq.b&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.cmpgtu.sc.h&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.cmpleu.sc.h&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.sdotup.h&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.sdotup.b&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.shuffle.sci.h&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.xor.sc.b&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.xor.sc.h&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.sdotsp.h&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.cmpeq.sci.b&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.and.sci.b&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.dotsp.h&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.dotsp.b&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.sdotsp.b&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.add.b&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.dotup.sci.b&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">XCVHWLP_INSNS</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;cv.count&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.counti&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.start&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.starti&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.end&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.endi&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.setup&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cv.setupi&quot;</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="k">def</span> <span class="nf">apply_mapping</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;cv_&quot;</span><span class="p">,</span> <span class="s2">&quot;cv.&quot;</span><span class="p">)</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_sc&quot;</span><span class="p">,</span> <span class="s2">&quot;.sc&quot;</span><span class="p">)</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_b&quot;</span><span class="p">,</span> <span class="s2">&quot;.b&quot;</span><span class="p">)</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_h&quot;</span><span class="p">,</span> <span class="s2">&quot;.h&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">XCVMAC_INSNS</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s2">&quot;XCVMac&quot;</span>
                <span class="k">elif</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">XCVMEM_INSNS</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s2">&quot;XCVMem&quot;</span>
                <span class="k">elif</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">XCVALU_INSNS</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s2">&quot;XCVAlu&quot;</span>
                <span class="k">elif</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">XCVBITMANIP_INSNS</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s2">&quot;XCVBitmanip&quot;</span>
                <span class="k">elif</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">XCVBI_INSNS</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s2">&quot;XCVBi&quot;</span>
                <span class="k">elif</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">XCVSIMD_INSNS</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s2">&quot;XCVSimd&quot;</span>
                <span class="k">elif</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">XCVHWLP_INSNS</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s2">&quot;XCVHwlp&quot;</span>
                <span class="k">elif</span> <span class="s2">&quot;cv.&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s2">&quot;XCV?&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s2">&quot;Other&quot;</span>

            <span class="n">names_</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">apply_mapping</span><span class="p">,</span> <span class="n">names</span><span class="p">))</span>
            <span class="n">cv_ext_counts</span><span class="p">,</span> <span class="n">cv_ext_probs</span> <span class="o">=</span> <span class="n">_helper</span><span class="p">(</span><span class="n">names_</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="p">)</span>
            <span class="n">corev_csv</span> <span class="o">=</span> <span class="n">_gen_csv</span><span class="p">(</span><span class="s2">&quot;Set&quot;</span><span class="p">,</span> <span class="n">cv_ext_counts</span><span class="p">,</span> <span class="n">cv_ext_probs</span><span class="p">)</span>
            <span class="n">artifact</span> <span class="o">=</span> <span class="n">Artifact</span><span class="p">(</span><span class="s2">&quot;analyse_instructions_corev.csv&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">corev_csv</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">ArtifactFormat</span><span class="o">.</span><span class="n">TEXT</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_file</span><span class="p">:</span>
                <span class="n">ret_artifacts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">artifact</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_df</span><span class="p">:</span>
                <span class="n">post_df</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">post_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">post_df</span><span class="p">[</span><span class="s2">&quot;CoreVSetCounts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cv_ext_counts</span><span class="p">)</span>
                <span class="n">post_df</span><span class="p">[</span><span class="s2">&quot;CoreVSetProbs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cv_ext_probs</span><span class="p">)</span>
                <span class="n">report</span><span class="o">.</span><span class="n">post_df</span> <span class="o">=</span> <span class="n">post_df</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_file</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_df</span><span class="p">,</span> <span class="s2">&quot;Either to_file or to_df have to be true&quot;</span>
        <span class="k">return</span> <span class="n">ret_artifacts</span></div>
</div>



<div class="viewcode-block" id="CompareRowsPostprocess">
<a class="viewcode-back" href="../../../../mlonmcu.session.postprocess.html#mlonmcu.session.postprocess.postprocesses.CompareRowsPostprocess">[docs]</a>
<span class="k">class</span> <span class="nc">CompareRowsPostprocess</span><span class="p">(</span><span class="n">SessionPostprocess</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;TODO&quot;&quot;&quot;</span>

    <span class="n">DEFAULTS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="o">**</span><span class="n">SessionPostprocess</span><span class="o">.</span><span class="n">DEFAULTS</span><span class="p">,</span>
        <span class="s2">&quot;to_compare&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;group_by&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;baseline&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;percent&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;invert&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;substract&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;compare_rows&quot;</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">to_compare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get to_compare property.&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;to_compare&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">str2list</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">group_by</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get group_by property.&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;group_by&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">str2list</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">baseline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get baseline property.&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;baseline&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">percent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get percent property.&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;percent&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">invert</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get invert property.&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;invert&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">substract</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get substract property.&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;substract&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<div class="viewcode-block" id="CompareRowsPostprocess.post_session">
<a class="viewcode-back" href="../../../../mlonmcu.session.postprocess.html#mlonmcu.session.postprocess.postprocesses.CompareRowsPostprocess.post_session">[docs]</a>
    <span class="k">def</span> <span class="nf">post_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">report</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Called at the end of a session.&quot;&quot;&quot;</span>
        <span class="n">pre_df</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">pre_df</span>
        <span class="n">main_df</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">main_df</span>  <span class="c1"># metrics</span>
        <span class="n">post_df</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">post_df</span>
        <span class="n">group_by</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_by</span>
        <span class="k">if</span> <span class="n">group_by</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">group_by</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pre_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Run&quot;</span><span class="p">,</span> <span class="s2">&quot;Sub&quot;</span><span class="p">]]</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">group_by</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">col</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">pre_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">post_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">group_by</span><span class="p">),</span> <span class="s2">&quot;Cols mssing in df&quot;</span>
        <span class="n">to_compare</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_compare</span>
        <span class="k">if</span> <span class="n">to_compare</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">to_compare</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">main_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">to_compare</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">col</span> <span class="ow">in</span> <span class="n">main_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">to_compare</span><span class="p">)</span>
        <span class="n">full_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pre_df</span><span class="p">,</span> <span class="n">main_df</span><span class="p">,</span> <span class="n">post_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">grouped</span> <span class="o">=</span> <span class="n">full_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">group_by</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">group_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">new_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">to_compare</span><span class="p">:</span>

            <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span> <span class="s2">&quot;Index of group baseline out of bounds&quot;</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">df</span> <span class="o">/</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">substract</span><span class="p">:</span>
                    <span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">invert</span><span class="p">:</span>
                    <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">ret</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">percent</span><span class="p">:</span>
                    <span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span> <span class="o">*</span> <span class="mf">100.0</span>
                <span class="k">return</span> <span class="n">ret</span>

            <span class="n">filtered_col</span> <span class="o">=</span> <span class="n">grouped</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
            <span class="n">first</span> <span class="o">=</span> <span class="n">filtered_col</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="n">first_col</span> <span class="o">=</span> <span class="n">first</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
            <span class="n">new</span> <span class="o">=</span> <span class="n">first_col</span>
            <span class="n">new_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> (rel.)&quot;</span>
            <span class="n">new_df</span><span class="p">[</span><span class="n">new_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span>
        <span class="n">main_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">main_df</span><span class="p">,</span> <span class="n">new_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">main_df</span> <span class="o">=</span> <span class="n">main_df</span></div>
</div>



<div class="viewcode-block" id="AnalyseDumpPostprocess">
<a class="viewcode-back" href="../../../../mlonmcu.session.postprocess.html#mlonmcu.session.postprocess.postprocesses.AnalyseDumpPostprocess">[docs]</a>
<span class="k">class</span> <span class="nc">AnalyseDumpPostprocess</span><span class="p">(</span><span class="n">RunPostprocess</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Counting static instructions.&quot;&quot;&quot;</span>

    <span class="n">DEFAULTS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="o">**</span><span class="n">RunPostprocess</span><span class="o">.</span><span class="n">DEFAULTS</span><span class="p">,</span>
        <span class="s2">&quot;to_df&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;to_file&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;analyse_dump&quot;</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">to_df</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get to_df property.&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;to_df&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">to_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get to_file property.&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;to_file&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<div class="viewcode-block" id="AnalyseDumpPostprocess.post_run">
<a class="viewcode-back" href="../../../../mlonmcu.session.postprocess.html#mlonmcu.session.postprocess.postprocesses.AnalyseDumpPostprocess.post_run">[docs]</a>
    <span class="k">def</span> <span class="nf">post_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">report</span><span class="p">,</span> <span class="n">artifacts</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Called at the end of a run.&quot;&quot;&quot;</span>
        <span class="n">platform</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">pre_df</span><span class="p">[</span><span class="s2">&quot;Platform&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">platform</span> <span class="o">!=</span> <span class="s2">&quot;mlif&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">ret_artifacts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dump_artifact</span> <span class="o">=</span> <span class="n">lookup_artifacts</span><span class="p">(</span>
            <span class="n">artifacts</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;generic_mlonmcu.dump&quot;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">ArtifactFormat</span><span class="o">.</span><span class="n">TEXT</span><span class="p">,</span> <span class="n">first_only</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">dump_artifact</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;To use analyse_dump postprocess, please set mlif.enable_asmdump=1&quot;</span>
        <span class="n">dump_artifact</span> <span class="o">=</span> <span class="n">dump_artifact</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">is_llvm</span> <span class="o">=</span> <span class="s2">&quot;llvm&quot;</span> <span class="ow">in</span> <span class="n">dump_artifact</span><span class="o">.</span><span class="n">flags</span>
        <span class="k">assert</span> <span class="n">is_llvm</span><span class="p">,</span> <span class="s2">&quot;Non-llvm objdump currently unsupported&quot;</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">dump_artifact</span><span class="o">.</span><span class="n">content</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">splitted</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">splitted</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">insn</span> <span class="o">=</span> <span class="n">splitted</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">splitted</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;cv.&quot;</span> <span class="ow">in</span> <span class="n">insn</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;(&quot;</span> <span class="ow">in</span> <span class="n">args</span> <span class="ow">and</span> <span class="s2">&quot;)&quot;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(.*)\((.*)\)&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                        <span class="n">g</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
                        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
                        <span class="n">offset</span><span class="p">,</span> <span class="n">base</span> <span class="o">=</span> <span class="n">g</span>
                        <span class="n">fmt</span> <span class="o">=</span> <span class="s2">&quot;ri&quot;</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="n">fmt</span> <span class="o">=</span> <span class="s2">&quot;rr&quot;</span>
                        <span class="n">insn</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">fmt</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="k">if</span> <span class="s2">&quot;!&quot;</span> <span class="ow">in</span> <span class="n">base</span><span class="p">:</span>
                            <span class="n">insn</span> <span class="o">+=</span> <span class="s2">&quot;_inc&quot;</span>
            <span class="k">if</span> <span class="n">insn</span> <span class="ow">in</span> <span class="n">counts</span><span class="p">:</span>
                <span class="n">counts</span><span class="p">[</span><span class="n">insn</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">counts</span><span class="p">[</span><span class="n">insn</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">total</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">counts_csv</span> <span class="o">=</span> <span class="s2">&quot;Instruction,Count,Probability</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">insn</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">counts</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">counts_csv</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">insn</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">count</span><span class="o">/</span><span class="n">total</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">artifact</span> <span class="o">=</span> <span class="n">Artifact</span><span class="p">(</span><span class="s2">&quot;dump_counts.csv&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">counts_csv</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">ArtifactFormat</span><span class="o">.</span><span class="n">TEXT</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_file</span><span class="p">:</span>
            <span class="n">ret_artifacts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">artifact</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_df</span><span class="p">:</span>
            <span class="n">post_df</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">post_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">post_df</span><span class="p">[</span><span class="s2">&quot;DumpCounts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span>
            <span class="n">report</span><span class="o">.</span><span class="n">post_df</span> <span class="o">=</span> <span class="n">post_df</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_file</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_df</span><span class="p">,</span> <span class="s2">&quot;Either to_file or to_df have to be true&quot;</span>
        <span class="k">return</span> <span class="n">ret_artifacts</span></div>
</div>



<div class="viewcode-block" id="AnalyseCoreVCountsPostprocess">
<a class="viewcode-back" href="../../../../mlonmcu.session.postprocess.html#mlonmcu.session.postprocess.postprocesses.AnalyseCoreVCountsPostprocess">[docs]</a>
<span class="k">class</span> <span class="nc">AnalyseCoreVCountsPostprocess</span><span class="p">(</span><span class="n">RunPostprocess</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Counting static instructions.&quot;&quot;&quot;</span>

    <span class="n">DEFAULTS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="o">**</span><span class="n">RunPostprocess</span><span class="o">.</span><span class="n">DEFAULTS</span><span class="p">,</span>
        <span class="s2">&quot;to_df&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;to_file&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;analyse_corev_counts&quot;</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">to_df</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get to_df property.&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;to_df&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">to_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get to_file property.&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;to_file&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<div class="viewcode-block" id="AnalyseCoreVCountsPostprocess.post_run">
<a class="viewcode-back" href="../../../../mlonmcu.session.postprocess.html#mlonmcu.session.postprocess.postprocesses.AnalyseCoreVCountsPostprocess.post_run">[docs]</a>
    <span class="k">def</span> <span class="nf">post_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">report</span><span class="p">,</span> <span class="n">artifacts</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Called at the end of a run.&quot;&quot;&quot;</span>
        <span class="n">ret_artifacts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">count_artifact</span> <span class="o">=</span> <span class="n">lookup_artifacts</span><span class="p">(</span><span class="n">artifacts</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;dump_counts.csv&quot;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">ArtifactFormat</span><span class="o">.</span><span class="n">TEXT</span><span class="p">,</span> <span class="n">first_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">count_artifact</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;To use analyse_corev_counts postprocess, analyse_dump needs to run first.&quot;</span>
        <span class="n">count_artifact</span> <span class="o">=</span> <span class="n">count_artifact</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">count_artifact</span><span class="o">.</span><span class="n">content</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">XCVMAC_INSNS</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;cv.mac&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.msu&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.mulun&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.mulhhun&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.mulsn&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.mulhhsn&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.mulurn&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.mulhhurn&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.mulsrn&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.mulhhsrn&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.macun&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.machhun&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.macsn&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.machhsn&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.macurn&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.machhurn&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.macsrn&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.machhsrn&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">XCVMEM_INSNS</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;cv.lb_ri_inc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.lbu_ri_inc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.lh_ri_inc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.lhu_ri_inc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.lw_ri_inc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.lb_ri_inc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.lbu_ri_inc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.lh_ri_inc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.lhu_ri_inc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.lw_ri_inc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.lb_rr_inc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.lbu_rr_inc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.lh_rr_inc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.lhu_rr_inc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.lw_rr_inc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.lb_rr_inc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.lbu_rr_inc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.lh_rr_inc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.lhu_rr_inc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.lw_rr_inc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.lb_rr&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.lbu_rr&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.lh_rr&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.lhu_rr&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.lw_rr&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.sb_ri_inc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.sh_ri_inc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.sw_ri_inc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.sb_ri_inc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.sh_ri_inc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.sw_ri_inc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.sb_rr_inc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.sh_rr_inc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.sw_rr_inc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.sb_rr_inc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.sh_rr_inc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.sw_rr_inc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.sb_rr&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.sh_rr&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.sw_rr&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">XCVBI_INSNS</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;cv.bneimm&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.beqimm&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">XCVALU_INSNS</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;cv.slet&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.min&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.addnr&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.addunr&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.addn&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.maxu&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.subun&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.extbz&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.addun&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.clip&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.clipu&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.subn&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.max&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.extbs&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.abs&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.addurn&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.exths&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.exthz&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.minu&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.sletu&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.suburn&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.addrn&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.clipur&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.subrn&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">XCVBITMANIP_INSNS</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;cv.ror&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.clb&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">XCVSIMD_INSNS</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;cv.add.h&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.add.sc.b&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.add.sc.h&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.add.sci.h&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.and.b&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.and.h&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.and.sc.h&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.and.sci.h&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.cmpeq.sc.h&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.cmpge.sci.h&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.cmpgtu.h&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.cmplt.sci.h&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.cmpltu.sci.b&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.cmpne.sc.h&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.cmpne.sci.b&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.extract.b&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.extract.h&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.extractu.b&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.extractu.h&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.insert.h&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.max.h&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.max.sci.h&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.maxu.h&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.or.b&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.or.h&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.pack&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.packhi.b&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.packlo.b&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.shuffle2.b&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.shuffle2.h&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.shufflei0.sci.b&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.sll.sci.h&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.sra.h&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.sra.sci.h&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.srl.h&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.srl.sci.h&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.sub.b&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.sub.h&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.xor.b&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.xor.sci.b&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.add.sci.b&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.cmpeq.b&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.cmpgtu.sc.h&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.cmpleu.sc.h&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.sdotup.h&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.sdotup.b&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.shuffle.sci.h&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.xor.sc.b&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.xor.sc.h&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.sdotsp.h&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.cmpeq.sci.b&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.and.sci.b&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.dotsp.h&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.dotsp.b&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.sdotsp.b&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.add.b&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.dotup.sci.b&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">XCVHWLP_INSNS</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;cv.count&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.counti&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.start&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.starti&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.end&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.endi&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.setup&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cv.setupi&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">unknowns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cv_ext_totals</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;XCVMac&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">XCVMAC_INSNS</span><span class="p">),</span>
            <span class="s2">&quot;XCVMem&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">XCVMEM_INSNS</span><span class="p">),</span>
            <span class="s2">&quot;XCVBi&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">XCVBI_INSNS</span><span class="p">),</span>
            <span class="s2">&quot;XCVAlu&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">XCVALU_INSNS</span><span class="p">),</span>
            <span class="s2">&quot;XCVBitmanip&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">XCVBITMANIP_INSNS</span><span class="p">),</span>
            <span class="s2">&quot;XCVSimd&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">XCVSIMD_INSNS</span><span class="p">),</span>
            <span class="s2">&quot;XCVHwlp&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">XCVHWLP_INSNS</span><span class="p">),</span>
            <span class="s2">&quot;Unknown&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">cv_ext_counts</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;XCVMac&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;XCVMem&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;XCVBi&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;XCVAlu&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;XCVBitmanip&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;XCVSimd&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;XCVHwlp&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;Unknown&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">cv_ext_unique_counts</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;XCVMac&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;XCVMem&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;XCVBi&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;XCVAlu&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;XCVBitmanip&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;XCVSimd&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;XCVHwlp&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;Unknown&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">total_counts</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">cv_counts_csv</span> <span class="o">=</span> <span class="s2">&quot;Instruction,Count,Probability</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">cv_counts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="k">if</span> <span class="s2">&quot;cv.&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">cv_counts_csv</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">splitted</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">splitted</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
            <span class="n">insn</span> <span class="o">=</span> <span class="n">splitted</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">splitted</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">cv_counts</span><span class="p">[</span><span class="n">insn</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span>
            <span class="n">total_counts</span> <span class="o">+=</span> <span class="n">count</span>
            <span class="k">if</span> <span class="n">insn</span> <span class="ow">in</span> <span class="n">XCVMAC_INSNS</span><span class="p">:</span>
                <span class="n">cv_ext_counts</span><span class="p">[</span><span class="s2">&quot;XCVMac&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">count</span>
                <span class="n">cv_ext_unique_counts</span><span class="p">[</span><span class="s2">&quot;XCVMac&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">insn</span> <span class="ow">in</span> <span class="n">XCVMEM_INSNS</span><span class="p">:</span>
                <span class="n">cv_ext_counts</span><span class="p">[</span><span class="s2">&quot;XCVMem&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">count</span>
                <span class="n">cv_ext_unique_counts</span><span class="p">[</span><span class="s2">&quot;XCVMem&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">insn</span> <span class="ow">in</span> <span class="n">XCVBI_INSNS</span><span class="p">:</span>
                <span class="n">cv_ext_counts</span><span class="p">[</span><span class="s2">&quot;XCVBi&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">count</span>
                <span class="n">cv_ext_unique_counts</span><span class="p">[</span><span class="s2">&quot;XCVBi&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">insn</span> <span class="ow">in</span> <span class="n">XCVALU_INSNS</span><span class="p">:</span>
                <span class="n">cv_ext_counts</span><span class="p">[</span><span class="s2">&quot;XCVAlu&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">count</span>
                <span class="n">cv_ext_unique_counts</span><span class="p">[</span><span class="s2">&quot;XCVAlu&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">insn</span> <span class="ow">in</span> <span class="n">XCVBITMANIP_INSNS</span><span class="p">:</span>
                <span class="n">cv_ext_counts</span><span class="p">[</span><span class="s2">&quot;XCVBitmanip&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">count</span>
                <span class="n">cv_ext_unique_counts</span><span class="p">[</span><span class="s2">&quot;XCVBitmanip&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">insn</span> <span class="ow">in</span> <span class="n">XCVSIMD_INSNS</span><span class="p">:</span>
                <span class="n">cv_ext_counts</span><span class="p">[</span><span class="s2">&quot;XCVSimd&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">count</span>
                <span class="n">cv_ext_unique_counts</span><span class="p">[</span><span class="s2">&quot;XCVSimd&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">insn</span> <span class="ow">in</span> <span class="n">XCVHWLP_INSNS</span><span class="p">:</span>
                <span class="n">cv_ext_counts</span><span class="p">[</span><span class="s2">&quot;XCVHwlp&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">count</span>
                <span class="n">cv_ext_unique_counts</span><span class="p">[</span><span class="s2">&quot;XCVHwlp&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cv_ext_counts</span><span class="p">[</span><span class="s2">&quot;Unknown&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">count</span>
                <span class="n">cv_ext_unique_counts</span><span class="p">[</span><span class="s2">&quot;Unknown&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">insn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unknowns</span><span class="p">:</span>
                    <span class="n">unknowns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">insn</span><span class="p">)</span>
        <span class="n">cv_ext_totals</span><span class="p">[</span><span class="s2">&quot;Unknown&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unknowns</span><span class="p">)</span>
        <span class="n">cv_ext_counts_csv</span> <span class="o">=</span> <span class="s2">&quot;Set,Count,Probability</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">ext</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">cv_ext_counts</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">cv_ext_counts_csv</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">count</span><span class="o">/</span><span class="n">total_counts</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">cv_ext_unique_counts_csv</span> <span class="o">=</span> <span class="s2">&quot;Set,Used,Utilization</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">ext</span><span class="p">,</span> <span class="n">used</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">cv_ext_unique_counts</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">used</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">rel</span> <span class="o">=</span> <span class="n">used</span> <span class="o">/</span> <span class="n">cv_ext_totals</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span>
            <span class="n">cv_ext_unique_counts_csv</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">used</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">rel</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">used</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">cv_ext_unique_counts</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">totals</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">cv_ext_totals</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">rel</span> <span class="o">=</span> <span class="n">used</span> <span class="o">/</span> <span class="n">totals</span>
        <span class="n">cv_ext_unique_counts_csv</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;XCVTotal,</span><span class="si">{</span><span class="n">used</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">rel</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="n">cv_counts_artifact</span> <span class="o">=</span> <span class="n">Artifact</span><span class="p">(</span><span class="s2">&quot;cv_counts.csv&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">cv_counts_csv</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">ArtifactFormat</span><span class="o">.</span><span class="n">TEXT</span><span class="p">)</span>
        <span class="n">cv_ext_counts_artifact</span> <span class="o">=</span> <span class="n">Artifact</span><span class="p">(</span><span class="s2">&quot;cv_ext_counts.csv&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">cv_ext_counts_csv</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">ArtifactFormat</span><span class="o">.</span><span class="n">TEXT</span><span class="p">)</span>
        <span class="n">cv_ext_unique_counts_artifact</span> <span class="o">=</span> <span class="n">Artifact</span><span class="p">(</span>
            <span class="s2">&quot;cv_ext_unique_counts.csv&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">cv_ext_unique_counts_csv</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">ArtifactFormat</span><span class="o">.</span><span class="n">TEXT</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unknowns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unknown instructions found: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">unknowns</span><span class="p">)</span>
            <span class="n">cv_ext_unknowns_artifact</span> <span class="o">=</span> <span class="n">Artifact</span><span class="p">(</span>
                <span class="s2">&quot;cv_ext_unknowns.csv&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unknowns</span><span class="p">),</span> <span class="n">fmt</span><span class="o">=</span><span class="n">ArtifactFormat</span><span class="o">.</span><span class="n">TEXT</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_file</span><span class="p">:</span>
                <span class="n">ret_artifacts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cv_ext_unknowns_artifact</span><span class="p">)</span>
            <span class="c1"># TODO: logging</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_file</span><span class="p">:</span>
            <span class="n">ret_artifacts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cv_counts_artifact</span><span class="p">)</span>
            <span class="n">ret_artifacts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cv_ext_counts_artifact</span><span class="p">)</span>
            <span class="n">ret_artifacts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cv_ext_unique_counts_artifact</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_df</span><span class="p">:</span>
            <span class="n">post_df</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">post_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">post_df</span><span class="p">[</span><span class="s2">&quot;XCVCounts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cv_counts</span><span class="p">)</span>
            <span class="n">post_df</span><span class="p">[</span><span class="s2">&quot;XCVExtCounts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cv_ext_counts</span><span class="p">)</span>
            <span class="n">post_df</span><span class="p">[</span><span class="s2">&quot;XCVExtUniqueCounts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cv_ext_unique_counts</span><span class="p">)</span>
            <span class="n">report</span><span class="o">.</span><span class="n">post_df</span> <span class="o">=</span> <span class="n">post_df</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_file</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_df</span><span class="p">,</span> <span class="s2">&quot;Either to_file or to_df have to be true&quot;</span>
        <span class="k">return</span> <span class="n">ret_artifacts</span></div>
</div>



<div class="viewcode-block" id="ValidateOutputsPostprocess">
<a class="viewcode-back" href="../../../../mlonmcu.session.postprocess.html#mlonmcu.session.postprocess.postprocesses.ValidateOutputsPostprocess">[docs]</a>
<span class="k">class</span> <span class="nc">ValidateOutputsPostprocess</span><span class="p">(</span><span class="n">RunPostprocess</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Postprocess for comparing model outputs with golden reference.&quot;&quot;&quot;</span>

    <span class="n">DEFAULTS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="o">**</span><span class="n">RunPostprocess</span><span class="o">.</span><span class="n">DEFAULTS</span><span class="p">,</span>
        <span class="s2">&quot;report&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;validate_metrics&quot;</span><span class="p">:</span> <span class="s2">&quot;topk(n=1);topk(n=2)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;validate_range&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;validate_outputs&quot;</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">validate_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get validate_metrics property.&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;validate_metrics&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get report property.&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;report&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">validate_range</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get validate_range property.&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;validate_range&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<div class="viewcode-block" id="ValidateOutputsPostprocess.post_run">
<a class="viewcode-back" href="../../../../mlonmcu.session.postprocess.html#mlonmcu.session.postprocess.postprocesses.ValidateOutputsPostprocess.post_run">[docs]</a>
    <span class="k">def</span> <span class="nf">post_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">report</span><span class="p">,</span> <span class="n">artifacts</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Called at the end of a run.&quot;&quot;&quot;</span>
        <span class="n">model_info_artifact</span> <span class="o">=</span> <span class="n">lookup_artifacts</span><span class="p">(</span><span class="n">artifacts</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;model_info.yml&quot;</span><span class="p">,</span> <span class="n">first_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_info_artifact</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Could not find artifact: model_info.yml&quot;</span>
        <span class="n">model_info_artifact</span> <span class="o">=</span> <span class="n">model_info_artifact</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="kn">import</span> <span class="nn">yaml</span>

        <span class="n">model_info_data</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">model_info_artifact</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_info_data</span><span class="p">[</span><span class="s2">&quot;output_names&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Multi-outputs not yet supported.&quot;</span><span class="p">)</span>
        <span class="n">outputs_ref_artifact</span> <span class="o">=</span> <span class="n">lookup_artifacts</span><span class="p">(</span><span class="n">artifacts</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;outputs_ref.npy&quot;</span><span class="p">,</span> <span class="n">first_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">outputs_ref_artifact</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Could not find artifact: outputs_ref.npy&quot;</span>
        <span class="n">outputs_ref_artifact</span> <span class="o">=</span> <span class="n">outputs_ref_artifact</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

        <span class="n">outputs_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">outputs_ref_artifact</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># import copy</span>
        <span class="c1"># outputs = copy.deepcopy(outputs_ref)</span>
        <span class="c1"># outputs[1][list(outputs[1].keys())[0]][0] = 42</span>
        <span class="n">outputs_artifact</span> <span class="o">=</span> <span class="n">lookup_artifacts</span><span class="p">(</span><span class="n">artifacts</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;outputs.npy&quot;</span><span class="p">,</span> <span class="n">first_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">outputs_artifact</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Could not find artifact: outputs.npy&quot;</span>
        <span class="n">outputs_artifact</span> <span class="o">=</span> <span class="n">outputs_artifact</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">outputs_artifact</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">in_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># compared = 0</span>
        <span class="c1"># matching = 0</span>
        <span class="c1"># missing = 0</span>
        <span class="c1"># metrics = {</span>
        <span class="c1">#     &quot;allclose(atol=0.0,rtol=0.0)&quot;: None,</span>
        <span class="c1">#     &quot;allclose(atol=0.05,rtol=0.05)&quot;: None,</span>
        <span class="c1">#     &quot;allclose(atol=0.1,rtol=0.1)&quot;: None,</span>
        <span class="c1">#     &quot;topk(n=1)&quot;: None,</span>
        <span class="c1">#     &quot;topk(n=2)&quot;: None,</span>
        <span class="c1">#     &quot;topk(n=inf)&quot;: None,</span>
        <span class="c1">#     &quot;toy&quot;: None,</span>
        <span class="c1">#     &quot;mse(thr=0.1)&quot;: None,</span>
        <span class="c1">#     &quot;mse(thr=0.05)&quot;: None,</span>
        <span class="c1">#     &quot;mse(thr=0.01)&quot;: None,</span>
        <span class="c1">#     &quot;+-1&quot;: None,</span>
        <span class="c1"># }</span>
        <span class="n">validate_metrics_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_metrics</span>
        <span class="n">validate_metrics</span> <span class="o">=</span> <span class="n">parse_validate_metrics</span><span class="p">(</span><span class="n">validate_metrics_str</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">output_ref</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">outputs_ref</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">outputs</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Missing output sample&quot;</span><span class="p">)</span>
                <span class="c1"># missing += 1</span>
                <span class="k">break</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">out_name</span><span class="p">,</span> <span class="n">out_ref_data</span> <span class="ow">in</span> <span class="n">output_ref</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">out_name</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
                    <span class="n">out_data</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="n">out_name</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="c1"># fallback for custom name-based npy dict</span>
                        <span class="n">out_data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="n">ii</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>  <span class="c1"># fallback for index-based npy array</span>
                        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">)),</span> <span class="s2">&quot;expected dict, list or np.array type&quot;</span>
                        <span class="n">out_data</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output not found: </span><span class="si">{</span><span class="n">out_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># optional dequantize</span>
                <span class="c1"># print(&quot;out_data_before_quant&quot;, out_data)</span>
                <span class="c1"># print(&quot;sum(out_data_before_quant&quot;, np.sum(out_data))</span>

                <span class="n">quant</span> <span class="o">=</span> <span class="n">model_info_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output_quant_details&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">rng</span> <span class="o">=</span> <span class="n">model_info_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output_ranges&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">quant</span><span class="p">:</span>

                    <span class="k">def</span> <span class="nf">ref_quant_helper</span><span class="p">(</span><span class="n">quant</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>  <span class="c1"># TODO: move somewhere else</span>
                        <span class="k">if</span> <span class="n">quant</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">data</span>
                        <span class="n">quant_scale</span><span class="p">,</span> <span class="n">quant_zero_point</span><span class="p">,</span> <span class="n">quant_dtype</span><span class="p">,</span> <span class="n">quant_range</span> <span class="o">=</span> <span class="n">quant</span>
                        <span class="k">if</span> <span class="n">quant_dtype</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">quant_dtype</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">data</span>
                        <span class="k">assert</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;float32&quot;</span><span class="p">],</span> <span class="s2">&quot;Quantization only supported for float32 input&quot;</span>
                        <span class="k">assert</span> <span class="n">quant_dtype</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;int8&quot;</span><span class="p">],</span> <span class="s2">&quot;Quantization only supported for int8 output&quot;</span>
                        <span class="k">if</span> <span class="n">quant_range</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_range</span><span class="p">:</span>
                            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">quant_range</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Range should be a tuple (lower, upper)&quot;</span>
                            <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="n">quant_range</span>
                            <span class="c1"># print(&quot;quant_range&quot;, quant_range)</span>
                            <span class="c1"># print(&quot;np.min(data)&quot;, np.min(data))</span>
                            <span class="c1"># print(&quot;np.max(data)&quot;, np.max(data))</span>
                            <span class="k">assert</span> <span class="n">lower</span> <span class="o">&lt;=</span> <span class="n">upper</span>
                            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">lower</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">upper</span><span class="p">,</span> <span class="s2">&quot;Range missmatch&quot;</span>

                        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">((</span><span class="n">data</span> <span class="o">/</span> <span class="n">quant_scale</span><span class="p">)</span> <span class="o">+</span> <span class="n">quant_zero_point</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int8&quot;</span><span class="p">)</span>

                    <span class="k">def</span> <span class="nf">dequant_helper</span><span class="p">(</span><span class="n">quant</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>  <span class="c1"># TODO: move somewhere else</span>
                        <span class="k">if</span> <span class="n">quant</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">data</span>
                        <span class="n">quant_scale</span><span class="p">,</span> <span class="n">quant_zero_point</span><span class="p">,</span> <span class="n">quant_dtype</span><span class="p">,</span> <span class="n">quant_range</span> <span class="o">=</span> <span class="n">quant</span>
                        <span class="k">if</span> <span class="n">quant_dtype</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">quant_dtype</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">data</span>
                        <span class="k">assert</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;int8&quot;</span><span class="p">],</span> <span class="s2">&quot;Dequantization only supported for int8 input&quot;</span>
                        <span class="k">assert</span> <span class="n">quant_dtype</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;float32&quot;</span><span class="p">],</span> <span class="s2">&quot;Dequantization only supported for float32 output&quot;</span>
                        <span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">quant_zero_point</span><span class="p">)</span> <span class="o">*</span> <span class="n">quant_scale</span>
                        <span class="k">if</span> <span class="n">quant_range</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_range</span><span class="p">:</span>
                            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">quant_range</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Range should be a tuple (lower, upper)&quot;</span>
                            <span class="c1"># print(&quot;quant_range&quot;, quant_range)</span>
                            <span class="c1"># print(&quot;np.min(ret)&quot;, np.min(ret))</span>
                            <span class="c1"># print(&quot;np.max(ret)&quot;, np.max(ret))</span>
                            <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="n">quant_range</span>
                            <span class="k">assert</span> <span class="n">lower</span> <span class="o">&lt;=</span> <span class="n">upper</span>
                            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">lower</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">upper</span><span class="p">,</span> <span class="s2">&quot;Range missmatch&quot;</span>
                        <span class="k">return</span> <span class="n">ret</span>

                    <span class="k">assert</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">rng</span><span class="p">)</span>
                    <span class="n">rng_</span> <span class="o">=</span> <span class="n">rng</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">rng_</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_range</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">rng_</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Range should be a tuple (lower, upper)&quot;</span>
                        <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="n">rng_</span>
                        <span class="k">assert</span> <span class="n">lower</span> <span class="o">&lt;=</span> <span class="n">upper</span>
                        <span class="c1"># print(&quot;rng_&quot;, rng_)</span>
                        <span class="c1"># print(&quot;np.min(out_data)&quot;, np.min(out_data))</span>
                        <span class="c1"># print(&quot;np.max(out_data)&quot;, np.max(out_data))</span>
                        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">out_data</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">lower</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">out_data</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">upper</span><span class="p">,</span> <span class="s2">&quot;Range missmatch&quot;</span>
                    <span class="k">assert</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">quant</span><span class="p">)</span>
                    <span class="n">quant_</span> <span class="o">=</span> <span class="n">quant</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">quant_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">out_ref_data_quant</span> <span class="o">=</span> <span class="n">ref_quant_helper</span><span class="p">(</span><span class="n">quant_</span><span class="p">,</span> <span class="n">out_ref_data</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">vm</span> <span class="ow">in</span> <span class="n">validate_metrics</span><span class="p">:</span>
                            <span class="n">vm</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">out_data</span><span class="p">,</span> <span class="n">out_ref_data_quant</span><span class="p">,</span> <span class="n">in_data</span><span class="o">=</span><span class="n">in_data</span><span class="p">,</span> <span class="n">quant</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">out_data</span> <span class="o">=</span> <span class="n">dequant_helper</span><span class="p">(</span><span class="n">quant_</span><span class="p">,</span> <span class="n">out_data</span><span class="p">)</span>
                <span class="c1"># print(&quot;out_data&quot;, out_data)</span>
                <span class="c1"># print(&quot;sum(out_data)&quot;, np.sum(out_data))</span>
                <span class="c1"># print(&quot;out_ref_data&quot;, out_ref_data)</span>
                <span class="c1"># print(&quot;sum(out_ref_data)&quot;, np.sum(out_ref_data))</span>
                <span class="c1"># input(&quot;TIAW&quot;)</span>
                <span class="k">assert</span> <span class="n">out_data</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">out_ref_data</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s2">&quot;dtype missmatch&quot;</span>
                <span class="k">assert</span> <span class="n">out_data</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">out_ref_data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s2">&quot;shape missmatch&quot;</span>

                <span class="k">for</span> <span class="n">vm</span> <span class="ow">in</span> <span class="n">validate_metrics</span><span class="p">:</span>
                    <span class="n">vm</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">out_data</span><span class="p">,</span> <span class="n">out_ref_data</span><span class="p">,</span> <span class="n">in_data</span><span class="o">=</span><span class="n">in_data</span><span class="p">,</span> <span class="n">quant</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">ii</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="k">for</span> <span class="n">vm</span> <span class="ow">in</span> <span class="n">validate_metrics</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">vm</span><span class="o">.</span><span class="n">get_summary</span><span class="p">()</span>
            <span class="n">report</span><span class="o">.</span><span class="n">post_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">vm</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span>
        <span class="k">return</span> <span class="p">[]</span></div>
</div>



<div class="viewcode-block" id="ValidateLabelsPostprocess">
<a class="viewcode-back" href="../../../../mlonmcu.session.postprocess.html#mlonmcu.session.postprocess.postprocesses.ValidateLabelsPostprocess">[docs]</a>
<span class="k">class</span> <span class="nc">ValidateLabelsPostprocess</span><span class="p">(</span><span class="n">RunPostprocess</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Postprocess for comparing model outputs with golden reference.&quot;&quot;&quot;</span>

    <span class="n">DEFAULTS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="o">**</span><span class="n">RunPostprocess</span><span class="o">.</span><span class="n">DEFAULTS</span><span class="p">,</span>
        <span class="s2">&quot;report&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;classify_metrics&quot;</span><span class="p">:</span> <span class="s2">&quot;topk_label(n=1);topk_label(n=2)&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;validate_labels&quot;</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">classify_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get classify_metrics property.&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;classify_metrics&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get report property.&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;report&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<div class="viewcode-block" id="ValidateLabelsPostprocess.post_run">
<a class="viewcode-back" href="../../../../mlonmcu.session.postprocess.html#mlonmcu.session.postprocess.postprocesses.ValidateLabelsPostprocess.post_run">[docs]</a>
    <span class="k">def</span> <span class="nf">post_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">report</span><span class="p">,</span> <span class="n">artifacts</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Called at the end of a run.&quot;&quot;&quot;</span>
        <span class="n">model_info_artifact</span> <span class="o">=</span> <span class="n">lookup_artifacts</span><span class="p">(</span><span class="n">artifacts</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;model_info.yml&quot;</span><span class="p">,</span> <span class="n">first_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_info_artifact</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Could not find artifact: model_info.yml&quot;</span>
        <span class="n">model_info_artifact</span> <span class="o">=</span> <span class="n">model_info_artifact</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="kn">import</span> <span class="nn">yaml</span>

        <span class="n">model_info_data</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">model_info_artifact</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_info_data</span><span class="p">[</span><span class="s2">&quot;output_names&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Multi-outputs not yet supported.&quot;</span><span class="p">)</span>
        <span class="n">labels_ref_artifact</span> <span class="o">=</span> <span class="n">lookup_artifacts</span><span class="p">(</span><span class="n">artifacts</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;labels_ref.npy&quot;</span><span class="p">,</span> <span class="n">first_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">labels_ref_artifact</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="p">),</span> <span class="s2">&quot;Could not find artifact: labels_ref.npy (Run classify_labels postprocess first!)&quot;</span>
        <span class="n">labels_ref_artifact</span> <span class="o">=</span> <span class="n">labels_ref_artifact</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

        <span class="n">labels_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">labels_ref_artifact</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">outputs_artifact</span> <span class="o">=</span> <span class="n">lookup_artifacts</span><span class="p">(</span><span class="n">artifacts</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;outputs.npy&quot;</span><span class="p">,</span> <span class="n">first_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">outputs_artifact</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Could not find artifact: outputs.npy&quot;</span>
        <span class="n">outputs_artifact</span> <span class="o">=</span> <span class="n">outputs_artifact</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">outputs_artifact</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># missing = 0</span>
        <span class="n">classify_metrics_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classify_metrics</span>
        <span class="n">classify_metrics</span> <span class="o">=</span> <span class="n">parse_classify_metrics</span><span class="p">(</span><span class="n">classify_metrics_str</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">output</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">outputs</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>  <span class="c1"># name based lookup</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># index based lookup</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">)),</span> <span class="s2">&quot;expected dict, list or np.array&quot;</span>
                <span class="n">output_names</span> <span class="o">=</span> <span class="n">model_info_data</span><span class="p">[</span><span class="s2">&quot;output_names&quot;</span><span class="p">]</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_names</span><span class="p">)</span>
                <span class="n">output</span> <span class="o">=</span> <span class="p">{</span><span class="n">output_names</span><span class="p">[</span><span class="n">idx</span><span class="p">]:</span> <span class="n">out</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">out</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">output</span><span class="p">)}</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Only supporting single-output models&quot;</span>
            <span class="n">out_data</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="c1"># print(&quot;out_data&quot;, out_data)</span>
            <span class="k">assert</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels_ref</span><span class="p">),</span> <span class="s2">&quot;Missing reference labels&quot;</span>
            <span class="n">label_ref</span> <span class="o">=</span> <span class="n">labels_ref</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="c1"># print(&quot;label_ref&quot;, label_ref)</span>
            <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="n">classify_metrics</span><span class="p">:</span>
                <span class="n">cm</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">out_data</span><span class="p">,</span> <span class="n">label_ref</span><span class="p">,</span> <span class="n">quant</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="n">classify_metrics</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_summary</span><span class="p">()</span>
            <span class="n">report</span><span class="o">.</span><span class="n">post_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cm</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span>
        <span class="k">return</span> <span class="p">[]</span></div>
</div>



<div class="viewcode-block" id="ExportOutputsPostprocess">
<a class="viewcode-back" href="../../../../mlonmcu.session.postprocess.html#mlonmcu.session.postprocess.postprocesses.ExportOutputsPostprocess">[docs]</a>
<span class="k">class</span> <span class="nc">ExportOutputsPostprocess</span><span class="p">(</span><span class="n">RunPostprocess</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Postprocess for writing model outputs to a directory.&quot;&quot;&quot;</span>

    <span class="n">DEFAULTS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="o">**</span><span class="n">RunPostprocess</span><span class="o">.</span><span class="n">DEFAULTS</span><span class="p">,</span>
        <span class="s2">&quot;dest&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># if none: export as artifact</span>
        <span class="s2">&quot;use_ref&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;skip_dequant&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;fmt&quot;</span><span class="p">:</span> <span class="s2">&quot;bin&quot;</span><span class="p">,</span>
        <span class="s2">&quot;archive_fmt&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;export_outputs&quot;</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get dest property.&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;dest&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">use_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get use_ref property.&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;use_ref&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">skip_dequant</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get skip_dequant property.&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;skip_dequant&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fmt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get fmt property.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;fmt&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">archive_fmt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get archive_fmt property.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;archive_fmt&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="ExportOutputsPostprocess.post_run">
<a class="viewcode-back" href="../../../../mlonmcu.session.postprocess.html#mlonmcu.session.postprocess.postprocesses.ExportOutputsPostprocess.post_run">[docs]</a>
    <span class="k">def</span> <span class="nf">post_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">report</span><span class="p">,</span> <span class="n">artifacts</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Called at the end of a run.&quot;&quot;&quot;</span>
        <span class="n">model_info_artifact</span> <span class="o">=</span> <span class="n">lookup_artifacts</span><span class="p">(</span><span class="n">artifacts</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;model_info.yml&quot;</span><span class="p">,</span> <span class="n">first_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_info_artifact</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Could not find artifact: model_info.yml&quot;</span>
        <span class="n">model_info_artifact</span> <span class="o">=</span> <span class="n">model_info_artifact</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="kn">import</span> <span class="nn">yaml</span>

        <span class="n">model_info_data</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">model_info_artifact</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="c1"># print(&quot;model_info_data&quot;, model_info_data)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_info_data</span><span class="p">[</span><span class="s2">&quot;output_names&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Multi-outputs not yet supported.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_ref</span><span class="p">:</span>
            <span class="n">outputs_ref_artifact</span> <span class="o">=</span> <span class="n">lookup_artifacts</span><span class="p">(</span><span class="n">artifacts</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;outputs_ref.npy&quot;</span><span class="p">,</span> <span class="n">first_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">outputs_ref_artifact</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Could not find artifact: outputs_ref.npy&quot;</span>
            <span class="n">outputs_ref_artifact</span> <span class="o">=</span> <span class="n">outputs_ref_artifact</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">outputs_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">outputs_ref_artifact</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="n">outputs_ref</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outputs_artifact</span> <span class="o">=</span> <span class="n">lookup_artifacts</span><span class="p">(</span><span class="n">artifacts</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;outputs.npy&quot;</span><span class="p">,</span> <span class="n">first_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">outputs_artifact</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Could not find artifact: outputs.npy&quot;</span>
            <span class="n">outputs_artifact</span> <span class="o">=</span> <span class="n">outputs_artifact</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">outputs_artifact</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span>
            <span class="n">dest_</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">temp_dir</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">temp_dir</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="o">.</span><span class="n">is_dir</span><span class="p">(),</span> <span class="sa">f</span><span class="s2">&quot;Not a directory: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">dest_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmt</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;bin&quot;</span><span class="p">,</span> <span class="s2">&quot;npy&quot;</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;Invalid format: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fmt</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">filenames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">output</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">outputs</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>  <span class="c1"># name based lookup</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># index based lookup</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">)),</span> <span class="s2">&quot;expected dict, list or np.array&quot;</span>
                <span class="n">output_names</span> <span class="o">=</span> <span class="n">model_info_data</span><span class="p">[</span><span class="s2">&quot;output_names&quot;</span><span class="p">]</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_names</span><span class="p">)</span>
                <span class="n">output</span> <span class="o">=</span> <span class="p">{</span><span class="n">output_names</span><span class="p">[</span><span class="n">idx</span><span class="p">]:</span> <span class="n">out</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">out</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">output</span><span class="p">)}</span>
            <span class="n">quant</span> <span class="o">=</span> <span class="n">model_info_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output_quant_details&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">quant</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_dequant</span><span class="p">:</span>

                <span class="k">def</span> <span class="nf">dequant_helper</span><span class="p">(</span><span class="n">quant</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">quant</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">data</span>
                    <span class="n">quant_scale</span><span class="p">,</span> <span class="n">quant_zero_point</span><span class="p">,</span> <span class="n">quant_dtype</span><span class="p">,</span> <span class="n">quant_range</span> <span class="o">=</span> <span class="n">quant</span>
                    <span class="k">if</span> <span class="n">quant_dtype</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">quant_dtype</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">data</span>
                    <span class="k">assert</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;int8&quot;</span><span class="p">],</span> <span class="s2">&quot;Dequantization only supported for int8 input&quot;</span>
                    <span class="k">assert</span> <span class="n">quant_dtype</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;float32&quot;</span><span class="p">],</span> <span class="s2">&quot;Dequantization only supported for float32 output&quot;</span>
                    <span class="k">return</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">quant_zero_point</span><span class="p">)</span> <span class="o">*</span> <span class="n">quant_scale</span>

                <span class="n">output</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">out_name</span><span class="p">:</span> <span class="n">dequant_helper</span><span class="p">(</span><span class="n">quant</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">output</span><span class="p">[</span><span class="n">out_name</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">out_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="p">}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;npy&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;npy export&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;bin&quot;</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Multi-outputs not supported&quot;</span>
                <span class="n">output_data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">output_data</span><span class="o">.</span><span class="n">tobytes</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s2">&quot;C&quot;</span><span class="p">)</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.bin&quot;</span>
                <span class="n">file_dest</span> <span class="o">=</span> <span class="n">dest_</span> <span class="o">/</span> <span class="n">file_name</span>
                <span class="n">filenames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_dest</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_dest</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;fmt not supported: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fmt</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">artifacts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">archive_fmt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">archive_fmt</span>
        <span class="n">create_artifact</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">archive_fmt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">create_artifact</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">archive_fmt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="n">archive_fmt</span> <span class="o">=</span> <span class="s2">&quot;tar.gz&quot;</span>  <span class="c1"># Default fallback</span>
            <span class="k">assert</span> <span class="n">archive_fmt</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;tar.xz&quot;</span><span class="p">,</span> <span class="s2">&quot;tar.gz&quot;</span><span class="p">,</span> <span class="s2">&quot;zip&quot;</span><span class="p">]</span>
            <span class="n">archive_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;output_data.</span><span class="si">{</span><span class="n">archive_fmt</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">archive_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dest_</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">archive_fmt</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">archive_fmt</span> <span class="o">==</span> <span class="s2">&quot;tar.gz&quot;</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">tarfile</span>

                <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">archive_path</span><span class="p">,</span> <span class="s2">&quot;w:gz&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tar</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
                        <span class="n">tar</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">arcname</span><span class="o">=</span><span class="n">filename</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;archive_fmt=</span><span class="si">{</span><span class="n">archive_fmt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">archive_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">raw</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">artifact</span> <span class="o">=</span> <span class="n">Artifact</span><span class="p">(</span><span class="n">archive_name</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="n">raw</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">ArtifactFormat</span><span class="o">.</span><span class="n">BIN</span><span class="p">)</span>
            <span class="n">artifacts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">artifact</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">temp_dir</span><span class="p">:</span>
            <span class="n">temp_dir</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">artifacts</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, TUM Department of Electrical and Computer Engineering - Chair of Electronic Design Automation.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>